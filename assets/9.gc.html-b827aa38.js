import{_ as p,V as o,W as c,X as n,Y as s,Z as e,a0 as a,F as i}from"./framework-f06be456.js";const l={},u=a('<h1 id="gc" tabindex="-1"><a class="header-anchor" href="#gc" aria-hidden="true">#</a> gc</h1><p>垃圾回收要干的事就是将不再使用的对象内存释放，腾出空间给其它对象使用。就这么简单的一句描述但它实现起来却非常不简单，垃圾回收的发展历史已经有了几十年，最早在上世纪60年代的Lisp语言就首次采用了垃圾回收机制，我们所熟知的Python，Objective-C，其主要的GC机制就是引用计数，Java，C#采用的是分代回收。在今天来看垃圾回收，从回收算法来看，可以大致分为下面几个大类：</p><ul><li>引用计数：让每一个对象记录自身被引用了多少次，当计数为0时，就将其回收</li><li>标记清除：将活动的对象做标记，将未标记的对象进行回收</li><li>复制算法：将活动对象复制到新的内存中，将旧内存中的所有对象全部回收，达到回收垃圾目的</li><li>标记压缩：标记清除的升级版，回收时将活动对象移动到堆的头部，方便管理</li></ul><p>从应用方式来看，可以分为下面几个大类：</p><ul><li>全局回收：一次直接回收所有的垃圾</li><li>分代回收：根据对象的存活时间分成不同的代，然后采用不同的回收算法</li><li>增量回收：每一次只进行局部的垃圾回收</li></ul>',5),r={class:"hint-container tip"},d=n("p",{class:"hint-container-title"},"提示",-1),k={href:"https://go.dev/blog/ismmkeynote",target:"_blank",rel:"noopener noreferrer"},v=a(`<p>在刚发布时，Go的垃圾回收机制十分简陋，只有简单的标记清除算法，垃圾回收所造成的STW（Stop The World，指因垃圾回收暂停整个程序）高达几秒甚至更久。意识到这一问题的Go团队变开始着手改进垃圾回收算法，在go1.0到go1.8版本之间，他们先后尝试过很多设想</p><ol><li>读屏障并发复制GC：读屏障的开销有很多不确定性，这种方案被取消了</li><li>面向请求的收集器（ROC）：需要时刻开启写屏障，拖累运行速度，拉低了编译时间</li><li>分代回收：分代回收在go中的效率并不高，因为go的编译器会倾向于将新对象分配到栈上，长期存在的对象分配到堆上，所以新生代对象大多数会被栈直接回收。</li><li>无写屏障的卡片标记：通过哈希散列成本来替代写屏障的成本，需要硬件配合</li></ol><p>最后Go团队还是选择了三色并发标记+写屏障的组合，并且在后续的版本中不断的改进和优化，这种做法也一直沿用到现在，下面一组图展示了从go1.4至go1.9的GC延时变化。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406071809080.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406071810572.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406071810654.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406071811463.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在写下本文时，go的最新版本已经快要来到了go1.23，对于如今的go来讲，GC性能早已不算问题了，现在的GC延时大部分情况下都低于100微秒，满足绝大部分业务场景的需要。</p><p>总的来说，Go中的垃圾回收可以分为下面几个阶段</p><ul><li>扫描阶段：从栈和全局变量中收集根对象</li><li>标记阶段：将对象着色</li><li>标记终止阶段：处理善后工作，关闭屏障</li><li>回收阶段：释放和回收垃圾对象的内存</li></ul><h2 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h2><p>在官方文档和文章中可能会出现以下的一些概念，下面简单的解释说明一下</p><ul><li>赋值器（mutator）：一种术语化的表达方式，指的是用户程序，在go中指的是用户代码</li><li>收集器（collector）：指的就是负责垃圾回收的程序，在go中负责垃圾回收的就是运行时</li><li>终结器（finalizer）：指的是在标记扫描工作完成后，负责回收释放清理对象内存的代码</li><li>控制器：指的是<code>runtime.gcController</code>全局变量，它的类型为<code>gcControllerState</code>，后者实现了调步算法，负责确认何时进行垃圾回收和执行多少工作量。</li><li>限制器：指的是<code>runtime.gcCPULimiter</code>，它负责在垃圾回收时防止CPU占用率过高而影响到用户程序</li></ul><h2 id="触发" tabindex="-1"><a class="header-anchor" href="#触发" aria-hidden="true">#</a> 触发</h2><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>垃圾回收由<code>runtime.gcStart</code>函数来开启，它只接收参数<code>runtime.gcTrigger</code>结构体，其中包含了GC触发的原因，当前时间，以及这是第几轮GC。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> gcTrigger <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    kind gcTriggerKind
    now  <span class="token builtin">int64</span>  <span class="token comment">// gcTriggerTime: current time</span>
    n    <span class="token builtin">uint32</span> <span class="token comment">// gcTriggerCycle: cycle number to start</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>gcTriggerKind</code>有以下几种可选值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// gcTriggerHeap indicates that a cycle should be started when</span>
	<span class="token comment">// the heap size reaches the trigger heap size computed by the</span>
	<span class="token comment">// controller.</span>
	gcTriggerHeap gcTriggerKind <span class="token operator">=</span> <span class="token boolean">iota</span>

	<span class="token comment">// gcTriggerTime indicates that a cycle should be started when</span>
	<span class="token comment">// it&#39;s been more than forcegcperiod nanoseconds since the</span>
	<span class="token comment">// previous GC cycle.</span>
	gcTriggerTime

	<span class="token comment">// gcTriggerCycle indicates that a cycle should be started if</span>
	<span class="token comment">// we have not yet started cycle number gcTrigger.n (relative</span>
	<span class="token comment">// to work.cycles).</span>
	gcTriggerCycle
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总的来说垃圾回收的触发时机有三种</p><ul><li><p>创建新对象时：在调用<code>runtime.mallocgc</code>分配内存时，如果监测到堆内存达到了阈值（一般来说是上一次GC时的两倍，该值也会被调步算法进行调整），便会开启垃圾回收</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	<span class="token keyword">if</span> shouldhelpgc <span class="token punctuation">{</span>
		<span class="token keyword">if</span> t <span class="token operator">:=</span> <span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerHeap<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">gcStart</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定时强制触发：go在运行时会启动一个单独的协程来运行<code>runtime.forcegchelper</code>函数，如果长时间没有进行垃圾回收，它便会强制开启GC，这个时间由<code>runtime.forcegcperiod</code>常量决定，其值为2分钟，同时在系统监控协程中也会定时检查是否需要强制GC</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">forcegchelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
		<span class="token function">gcStart</span><span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerTime<span class="token punctuation">,</span> now<span class="token punctuation">:</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
		<span class="token comment">// check if we need to force a GC</span>
		<span class="token keyword">if</span> t <span class="token operator">:=</span> <span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerTime<span class="token punctuation">,</span> now<span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
			<span class="token keyword">var</span> list gList
			list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>forcegc<span class="token punctuation">.</span>g<span class="token punctuation">)</span>
			<span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>手动触发：通过<code>runtime.GC</code>函数，用户可以手动触发垃圾回收。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	n <span class="token operator">:=</span> work<span class="token punctuation">.</span>cycles<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">gcStart</span><span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerCycle<span class="token punctuation">,</span> n<span class="token punctuation">:</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul>`,21),m={class:"hint-container tip"},b=n("p",{class:"hint-container-title"},"提示",-1),g={href:"https://github.com/golang/proposal/blob/master/design/44167-gc-pacer-redesign.md",target:"_blank",rel:"noopener noreferrer"},f=a('<h2 id="标记" tabindex="-1"><a class="header-anchor" href="#标记" aria-hidden="true">#</a> 标记</h2><p>现如今Go的GC算法依然是先标记后清除这样一个步骤，但其实现不再像以前一样简单。</p><h3 id="标记-清除" tabindex="-1"><a class="header-anchor" href="#标记-清除" aria-hidden="true">#</a> 标记-清除</h3><p>先从最简单的标记清除算法开始讲起，在内存中，对象与对象之间的引用关系会构成一个图，垃圾回收的工作就在这个图上进行，工作分为两个阶段：</p><ul><li>标记阶段：从根节点（根节点通常是栈上的变量，全局变量等活跃对象）开始，逐个遍历每一个可以到达的节点，并将其标记为活跃对象，直到遍历完所有可以到达的节点，</li><li>清除阶段：遍历堆中的所有对象，将未标记的对象回收，将其内存空间释放或是复用。</li></ul><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406051711875.png" style="zoom:67%;"><p>在回收的过程中，对象图的结构不能被改变，所以要将整个程序停止，也就是STW，回收完毕以后才能继续运行，这种算法的缺点就在于耗时较长，比较影响程序的运行效率，这是早期版本Go使用的标记算法，它的缺点比较明显</p><ul><li>会产生内存碎片（由于Go TCMalloc式的内存管理方式，碎片问题的影响并不大）</li><li>在标记阶段会扫描堆的所有对象</li><li>会导致STW，暂停整个程序，且时间不短</li></ul><h3 id="三色标记" tabindex="-1"><a class="header-anchor" href="#三色标记" aria-hidden="true">#</a> 三色标记</h3><p>为了改进效率，Go采用了经典的三色标记算法，所谓三色，指的是黑灰白三色：</p><ul><li>黑色：在标记过程中对象已访问过，并且它所直接引用的对象也都已经访问过，表示活跃的对象</li><li>灰色：在标记过程中对象已访问过，但它所直接引用的对象并未全部访问，当全部访问完后会转变为黑色，表示活跃的对象</li><li>白色：在标记过程中从未被访问过，在访问过后会变为灰色，表示可能为垃圾对象，</li></ul><p>在三色标记工作开始时，场上只有灰色和白色对象，所有根对象都是灰色，其它对象都是白色，如下图所示</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406051641610.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>每一轮标记开始时，先从灰色对象开始，将灰色对象标记为黑色，表示其为活跃对象，然后再将黑色对象所有直接引用的对象标记为灰色，剩下的就是白色，此时场上就有了黑白灰三种颜色。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406051650287.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>不断重复上述步骤，直到场上只剩下黑色和白色对象，当灰色对象集合为空时，就代表着标记结束，如下图</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406051703833.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在标记结束后，在清除阶段只需将白色集合中对象的内存释放即可。</p><h3 id="不变性" tabindex="-1"><a class="header-anchor" href="#不变性" aria-hidden="true">#</a> 不变性</h3><p>三色标记法本身没法进行并发标记（指程序一边运行一边标记），如果在标记时对象图结构发生了改变，这可能会导致两种情况</p><ul><li>多标：在对象被标记为黑色对象后，用户程序删除了对于该对象的所有引用，那么它应该是白色对象需要被清除</li><li>漏标：在对象被标记为白色对象后，用户程序中有其它对象引用了该对象，那么它应该是黑色对象不应该被清除</li></ul><p>对于第一种情况其实可以接受，因为未被清理的对象可以在下一轮回收中被处理掉。但第二种情况就没法接受了，正在使用中的对象内存被错误的释放，会造成严重的程序错误，这是必须要避免的问题。</p>',22),h={href:"https://dl.acm.org/doi/epdf/10.1145/301589.286863",target:"_blank",rel:"noopener noreferrer"},w=a(`<ul><li><p>强三色不变性：黑色对象不可以直接引用白色对象</p></li><li><p>弱三色不变性：当黑色对象直接引用白色对象时，必须有另一个灰色对象可以直接或间接访问到该灰色对象，称作受到灰色对象的保护</p></li></ul><p>对于强三色不变性而言，已知黑色对象3是已经访问过的对象，且其子对象也全都访问过并标记为灰色对象，如果此时用户程序并发的给黑色对象3添加白色对象7的新引用，正常来说白色对象7应该被标记为灰色，但由于黑色对象3已经被访问过了，对象7不会被访问，所以它始终都是白色对象，并最终被错误的清理掉。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406052226227.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>对于弱三色不变性而言，它其实跟强三色不变性同理，因为灰色对象能够直接或间接的访问到该白色对象，后续标记过程中它最终会被标记为灰色对象，从而避免被误清理。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406052237769.png" style="zoom:50%;"><p>通过不变性，可以确保在标记过程中不会有对象被误清理，也就能保证并发条件下的标记工作的正确性，从而可以使得三色标记并发的工作，这样一来其标记效率相比于标记-清除算法会提升相当多。要在并发情况下保证三色不变性，关键就在于屏障技术。</p><h3 id="标记工作" tabindex="-1"><a class="header-anchor" href="#标记工作" aria-hidden="true">#</a> 标记工作</h3><p>在GC扫描阶段时，有一个全局变量<code>runtime.gcphase</code>用于表示GC的状态，有如下可选值：</p><ul><li><code>_GCoff</code>：标记工作未开始</li><li><code>_GCmark</code>：标记工作已开始</li><li><code>_GCmarktermination</code>：标记工作将要终止</li></ul><p>当标记工作开始时，<code>runtime.gcphase</code>的状态为<code>_GCmark</code>，执行标记工作的是<code>runtime.gcDrain</code>函数，其中<code>runtime.gcWork</code>参数是一个缓冲池，它存放着要追踪的对象指针。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcDrain</span><span class="token punctuation">(</span>gcw <span class="token operator">*</span>gcWork<span class="token punctuation">,</span> flags gcDrainFlags<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在工作时，它会尝试从缓冲池去获取可追踪的指针，如果有的话则会调用<code>runtime.scanobject</code>函数继续执行扫描任务，它的作用是不断的扫描缓冲区中的对象，将它们染黑。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> work<span class="token punctuation">.</span>full <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    gcw<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

b <span class="token operator">:=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGetFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// Flush the write barrier</span>
        <span class="token comment">// buffer; this may create</span>
        <span class="token comment">// more work.</span>
        <span class="token function">wbBufFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// Unable to get work.</span>
    <span class="token keyword">break</span>
<span class="token punctuation">}</span>
<span class="token function">scanobject</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> gcw<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当P被抢占或将发生STW时，扫描工作才会停止</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>preempt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>preemptible <span class="token operator">||</span> sched<span class="token punctuation">.</span>gcwaiting<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> pp<span class="token punctuation">.</span>runSafePointFn <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token function">scanobject</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> gcw<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runtime.gcwork</code>是一个采用了生产者/消费者模型的队列，该队列负责存放待扫描的灰色对象，每一个处理器P本地都有这样一个队列，对应\`\`runtime.p.gcw\`字段。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">scanobject</span><span class="token punctuation">(</span>b <span class="token builtin">uintptr</span><span class="token punctuation">,</span> gcw <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> addr <span class="token builtin">uintptr</span>
		<span class="token keyword">if</span> hbits<span class="token punctuation">,</span> addr <span class="token operator">=</span> hbits<span class="token punctuation">.</span><span class="token function">nextFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> addr <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> hbits<span class="token punctuation">,</span> addr <span class="token operator">=</span> hbits<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> addr <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		scanSize <span class="token operator">=</span> addr <span class="token operator">-</span> b <span class="token operator">+</span> goarch<span class="token punctuation">.</span>PtrSize
		obj <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> obj <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> obj<span class="token operator">-</span>b <span class="token operator">&gt;=</span> n <span class="token punctuation">{</span>
			<span class="token keyword">if</span> obj<span class="token punctuation">,</span> span<span class="token punctuation">,</span> objIndex <span class="token operator">:=</span> <span class="token function">findObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> b<span class="token punctuation">,</span> addr<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> obj <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">greyobject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> b<span class="token punctuation">,</span> addr<span class="token operator">-</span>b<span class="token punctuation">,</span> span<span class="token punctuation">,</span> gcw<span class="token punctuation">,</span> objIndex<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	gcw<span class="token punctuation">.</span>bytesMarked <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	gcw<span class="token punctuation">.</span>heapScanWork <span class="token operator">+=</span> <span class="token function">int64</span><span class="token punctuation">(</span>scanSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runitme.scanobject</code>函数在扫描时会不断的将可达的白色对象标记为灰色，然后通过调用<code>gcw.put</code>放入本地的队列中，同时<code>gcDrain</code>函数也会不断的通过<code>gcw.tryget</code>来尝试获取灰色对象以继续扫描。标记扫描的过程是增量式的，不需要一口气完成所有的标记工作，标记任务因一些原因被抢占时就会中断，等到恢复后可以根据队列中剩余的灰色对象继续完成标记工作。</p><h3 id="后台标记" tabindex="-1"><a class="header-anchor" href="#后台标记" aria-hidden="true">#</a> 后台标记</h3><p>标记工作并不会在GC开始时立即执行，在刚触发GC时，go会创建与当前处理器P总数量相同的标记任务，它们会被添加到全局任务队列中，然后进入休眠直到在标记阶段被唤醒。在运行时，由<code>runtime.gcBgMarkStartWorkers</code>来进行任务的分配，标记任务实际上指的就是<code>runtime.gcBgMarkWorker</code>函数，其中<code>gcBgMarkWorkerCount</code>和<code>gomaxprocs</code>两个运行时全局变量分别表示当前worker的数量和处理器P的数量。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Background marking is performed by per-P G&#39;s. Ensure that each P has</span>
	<span class="token comment">// a background GC G.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Worker Gs don&#39;t exit if gomaxprocs is reduced. If it is raised</span>
	<span class="token comment">// again, we can reuse the old workers; no need to create new workers.</span>
	<span class="token keyword">for</span> gcBgMarkWorkerCount <span class="token operator">&lt;</span> gomaxprocs <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
		<span class="token comment">// The worker is now guaranteed to be added to the pool before</span>
		<span class="token comment">// its P&#39;s next findRunnableGCWorker.</span>

		gcBgMarkWorkerCount<span class="token operator">++</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在worker启动后，它会创建一个<code>runtime.gcBgMarkWorkerNode</code>结构体，将其加入全局的worker池<code>runitme.gcBgMarkWorkerPool</code>，然后调用<code>runtime.gopark</code>函数让协程其陷入休眠</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	node <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>gcBgMarkWorkerNode<span class="token punctuation">)</span>
	node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
	<span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Go to sleep until woken by</span>
		<span class="token comment">// gcController.findRunnableGCWorker.</span>
		<span class="token function">gopark</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>g <span class="token operator">*</span>g<span class="token punctuation">,</span> nodep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
			node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>nodep<span class="token punctuation">)</span>
			<span class="token comment">// Release this G to the pool.</span>
			gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
			<span class="token comment">// Note that at this point, the G may immediately be</span>
			<span class="token comment">// rescheduled and may be running.</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonGCWorkerIdle<span class="token punctuation">,</span> traceBlockSystemGoroutine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有两种情况可以唤醒worker</p><ul><li>处于标记阶段时，调度循环会通过<code>runtime.runtime.gcController.findRunnableGCWorker</code>函数来唤醒休眠的worker</li><li>处于标记阶段时，如果处理器P当前为空闲状态，调度循环会尝试直接从全局worker池<code>gcBgMarkWorkerPool</code>中获取可用的worker</li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">findRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime<span class="token punctuation">,</span> tryWakeP <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
top<span class="token punctuation">:</span>
    <span class="token comment">// Try to schedule a GC worker.</span>
	<span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> tnow <span class="token operator">:=</span> gcController<span class="token punctuation">.</span><span class="token function">findRunnableGCWorker</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
		<span class="token keyword">if</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		now <span class="token operator">=</span> tnow
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">// We have nothing to do.</span>
	<span class="token comment">//</span>
	<span class="token comment">// If we&#39;re in the GC mark phase, can safely scan and blacken objects,</span>
	<span class="token comment">// and have work to do, run idle-time marking rather than give up the P.</span>
	<span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> gcController<span class="token punctuation">.</span><span class="token function">addIdleMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerIdleMode
			gp <span class="token operator">:=</span> node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			trace <span class="token operator">:=</span> <span class="token function">traceAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
			<span class="token keyword">if</span> trace<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				trace<span class="token punctuation">.</span><span class="token function">GoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token function">traceRelease</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
		gcController<span class="token punctuation">.</span><span class="token function">removeIdleMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>处理器P有结构体中有一个字段<code>gcMarkWorkerMode</code>来表示标记任务的执行模式，它有以下几个可选值：</p><ul><li><p><code>gcMarkWorkerNotWorker</code>：表示当前处理器P没有正在执行标记任务</p></li><li><p><code>gcMarkWorkerDedicatedMode</code>：表示当前处理器P专门用于执行标记任务，且期间不会被抢占。</p></li><li><p><code>gcMarkWorkerFractionalMode</code>：表示当前处理器是因为GC利用率不达标（25%达标）才执行的标记任务，执行期间可以被抢占。假设当前处理器P数量为5，根据计算公式此时需要一个专用处理标记任务的处理器P，利用率只达到了20%，剩下5%的利用率就需要开启一个<code>FractionalMode</code>的处理器P来弥补。具体的计算代码如下所示</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>gcControllerState<span class="token punctuation">)</span> <span class="token function">startCycle</span><span class="token punctuation">(</span>markStartTime <span class="token builtin">int64</span><span class="token punctuation">,</span> procs <span class="token builtin">int</span><span class="token punctuation">,</span> trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	totalUtilizationGoal <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span> <span class="token operator">*</span> gcBackgroundUtilization
	dedicatedMarkWorkersNeeded <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>totalUtilizationGoal <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">float64</span><span class="token punctuation">(</span>dedicatedMarkWorkersNeeded<span class="token punctuation">)</span> <span class="token operator">&gt;</span> totalUtilizationGoal <span class="token punctuation">{</span>
        <span class="token comment">// Too many dedicated workers.</span>
        dedicatedMarkWorkersNeeded<span class="token operator">--</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>fractionalUtilizationGoal <span class="token operator">=</span> <span class="token punctuation">(</span>totalUtilizationGoal <span class="token operator">-</span> <span class="token function">float64</span><span class="token punctuation">(</span>dedicatedMarkWorkersNeeded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>gcMarkWorkerIdleMode</code>：表示当前处理器是因为空闲才执行标记任务，执行期间可以被抢占。</p></li></ul><p>Go团队不希望GC占用过多的性能从而影响用户程序的正常运行，根据这些不同的模式进行标记工作，可以在不浪费性能也不影响用户程序的情况下完成GC。可以注意到的是标记任务的基本分配单位是处理器P，所以标记工作是并发进行的，多个标记任务和用户程序之间并发的执行，互不影响。</p><h3 id="标记辅助" tabindex="-1"><a class="header-anchor" href="#标记辅助" aria-hidden="true">#</a> 标记辅助</h3><p>协程G在运行时有一个字段<code>gcAssistBytes</code>，这里将其称为GC辅助积分。处于GC标记状态时，当一个协程尝试申请若干大小的内存，它会被扣除与申请内存大小相同的积分。如果此时积分为负数，那么该协程必须辅助完成定量的GC扫描任务来偿还积分，当积分为正数时，协程就可以不需要去完成辅助标记任务了。</p><p>扣除积分的函数为<code>runtime.deductAssistCredit</code>，它会在<code>runtime.mallocgc</code>函数分配内存前被调用。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">deductAssistCredit</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>
    <span class="token keyword">var</span> assistG <span class="token operator">*</span>g
    <span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
       <span class="token comment">// Charge the current user G for this allocation.</span>
       assistG <span class="token operator">=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> assistG<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
          assistG <span class="token operator">=</span> assistG<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg
       <span class="token punctuation">}</span>
       <span class="token comment">// Charge the allocation against the G. We&#39;ll account</span>
       <span class="token comment">// for internal fragmentation at the end of mallocgc.</span>
       assistG<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">-=</span> <span class="token function">int64</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>

       <span class="token keyword">if</span> assistG<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
          <span class="token comment">// This G is in debt. Assist the GC to correct</span>
          <span class="token comment">// this before allocating. This must happen</span>
          <span class="token comment">// before disabling preemption.</span>
          <span class="token function">gcAssistAlloc</span><span class="token punctuation">(</span>assistG<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> assistG
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然而当协程完成定量的辅助扫描工作后，就会偿还定量的积分给当前协程，实际负责辅助标记的函数是<code>runtime.gcDrainN</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcAssistAlloc1</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> scanWork <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	gcw <span class="token operator">:=</span> <span class="token operator">&amp;</span><span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gcw
    <span class="token comment">// 完成工作了</span>
	workDone <span class="token operator">:=</span> <span class="token function">gcDrainN</span><span class="token punctuation">(</span>gcw<span class="token punctuation">,</span> scanWork<span class="token punctuation">)</span>
	<span class="token operator">...</span>
	assistBytesPerWork <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>assistBytesPerWork<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">int64</span><span class="token punctuation">(</span>assistBytesPerWork<span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>workDone<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于扫描是并发的，记录下来的工作量中只有一部分是当前协程的，余下的工作量会根据辅助队列的顺序来逐个偿还给其它协程，如果还有剩余的话，就会添加到全局积分<code>gcController.assistBytesPerWork</code>中。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcFlushBgCredit</span><span class="token punctuation">(</span>scanWork <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果队列为空则直接添加到全局积分中</span>
	<span class="token keyword">if</span> work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>scanWork<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	assistBytesPerWork <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>assistBytesPerWork<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	scanBytes <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>scanWork<span class="token punctuation">)</span> <span class="token operator">*</span> assistBytesPerWork<span class="token punctuation">)</span>

	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> scanBytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		gp <span class="token operator">:=</span> work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> scanBytes<span class="token operator">+</span>gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			scanBytes <span class="token operator">+=</span> gp<span class="token punctuation">.</span>gcAssistBytes
			gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token function">ready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">+=</span> scanBytes
			scanBytes <span class="token operator">=</span> <span class="token number">0</span>
			work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">pushBack</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// 还有剩余</span>
	<span class="token keyword">if</span> scanBytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		assistWorkPerByte <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>assistWorkPerByte<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		scanWork <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>scanBytes<span class="token punctuation">)</span> <span class="token operator">*</span> assistWorkPerByte<span class="token punctuation">)</span>
		gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>scanWork<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>相应的，当需要偿还的积分过多时（申请的内存过大），也可以使用全局积分来抵消部分自己的借债</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcAssistAlloc</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	assistWorkPerByte <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>assistWorkPerByte<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	assistBytesPerWork <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>assistBytesPerWork<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	debtBytes <span class="token operator">:=</span> <span class="token operator">-</span>gp<span class="token punctuation">.</span>gcAssistBytes
	scanWork <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>assistWorkPerByte <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span>debtBytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> scanWork <span class="token operator">&lt;</span> gcOverAssistWork <span class="token punctuation">{</span>
		scanWork <span class="token operator">=</span> gcOverAssistWork
		debtBytes <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span>assistBytesPerWork <span class="token operator">*</span> <span class="token function">float64</span><span class="token punctuation">(</span>scanWork<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// 用全局积分抵押</span>
	bgScanCredit <span class="token operator">:=</span> gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	stolen <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> bgScanCredit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> bgScanCredit <span class="token operator">&lt;</span> scanWork <span class="token punctuation">{</span>
			stolen <span class="token operator">=</span> bgScanCredit
			gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">int64</span><span class="token punctuation">(</span>assistBytesPerWork<span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>stolen<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			stolen <span class="token operator">=</span> scanWork
			gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">+=</span> debtBytes
		<span class="token punctuation">}</span>
		gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span>stolen<span class="token punctuation">)</span>

		scanWork <span class="token operator">-=</span> stolen

		<span class="token keyword">if</span> scanWork <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>标记辅助是在高负载的情况下的一种平衡手段，用户程序分配内存的速度远高于标记的速度，分配多少内存就进行多少标记工作。</p><h3 id="标记终止" tabindex="-1"><a class="header-anchor" href="#标记终止" aria-hidden="true">#</a> 标记终止</h3><p>当所有可达的灰色对象都被染黑了过后，此时就由<code>_GCmark</code>状态过渡到<code>_GCmarktermination</code>状态，这个过程由<code>runtime.gcMarkDone</code>函数来完成。在开始时，它会检查是否仍有任务要执行，</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>top<span class="token punctuation">:</span>

	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>gcphase <span class="token operator">==</span> _GCmark <span class="token operator">&amp;&amp;</span> work<span class="token punctuation">.</span>nwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	gcMarkDoneFlushed <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token comment">// 将所有因写屏障拦截的标记操作全部批量的执行</span>
	<span class="token function">forEachP</span><span class="token punctuation">(</span>waitReasonGCMarkTermination<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">wbBufFlush1</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
		pp<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> pp<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span>flushedWork <span class="token punctuation">{</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcMarkDoneFlushed<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			pp<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span>flushedWork <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> gcMarkDoneFlushed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">goto</span> top
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当没有任何全局任务和本地任务要执行后，调用<code>runtime.stopTheWorldWithSema</code>进行STW，然后做一些收尾的工作</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Disable assists and background workers. We must do</span>
<span class="token comment">// this before waking blocked assists.</span>
atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcBlackenEnabled<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// Notify the CPU limiter that GC assists will now cease.</span>
gcCPULimiter<span class="token punctuation">.</span><span class="token function">startGCTransition</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>

<span class="token comment">// Wake all blocked assists. These will run when we</span>
<span class="token comment">// start the world again.</span>
<span class="token function">gcWakeAllAssists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// In STW mode, re-enable user goroutines. These will be</span>
<span class="token comment">// queued to run after we start the world.</span>
<span class="token function">schedEnableUser</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// endCycle depends on all gcWork cache stats being flushed.</span>
<span class="token comment">// The termination algorithm above ensured that up to</span>
<span class="token comment">// allocations since the ragged barrier.</span>
gcController<span class="token punctuation">.</span><span class="token function">endCycle</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>gomaxprocs<span class="token punctuation">)</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>userForced<span class="token punctuation">)</span>

<span class="token comment">// Perform mark termination. This will restart the world.</span>
<span class="token function">gcMarkTermination</span><span class="token punctuation">(</span>stw<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先将<code>runtime.BlackenEnabled</code>置为0，表示标记工作已经结束了，通知限制器标记辅助已经结束了，关闭内存屏障，唤醒所有因辅助标记而休眠的协程，然后再重新唤醒所有的用户协程，还要收集本轮扫描工作的各种数据来调整调步算法来为下一轮扫描做准备，收尾工作完成后，调用<code>runtime.gcSweep</code>函数清理垃圾对象，最后再调用<code>runtime.startTheWorldWithSema</code>让程序恢复运行。</p><h2 id="屏障" tabindex="-1"><a class="header-anchor" href="#屏障" aria-hidden="true">#</a> 屏障</h2><p>内存屏障的作用可以理解为hook了对象的赋值行为，在赋值前做一些指定的操作，这种hook代码通常在编译期间由编译器插入到代码中。前面提到过，三色标记在并发情况下添加和删除对象引用都会导致问题，由于这两个都是写操作（删除就是赋空值），所以拦截它们的屏障被统称为写屏障。但屏障机制并非毫无成本，拦截内存写操作会造成额外的开销，因此屏障机制只在堆上生效，考虑到实现复杂度和性能损耗，对于栈和寄存器则不起作用范围内。</p>`,48),y={class:"hint-container tip"},W=n("p",{class:"hint-container-title"},"提示",-1),C={href:"https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md",target:"_blank",rel:"noopener noreferrer"},G=a(`<h3 id="插入写屏障" tabindex="-1"><a class="header-anchor" href="#插入写屏障" aria-hidden="true">#</a> 插入写屏障</h3><p>插入写屏障由Dijkstra提出的，它满足强三色不变式。当给黑色对象添加了一个新的白色对象引用时，插入写屏障会拦截此操作，将该白色对象标记为灰色，这样可以避免黑色对象直接引用白色对象，保证了强三色不变性，这个相当好理解。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406052336189.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>前面提到过写屏障不会应用在栈上，如果在并发标记的过程中栈对象的引用关系发生了变化，比如栈中的黑色对象引用了堆中的白色对象，所以为了确保栈对象的正确性，只能在标记结束后再次将栈中的所有对象全部标记为灰色对象，然后重新扫描一遍，等于是一轮标记要扫描两次栈空间，并且第二次扫描时必须要STW，假如程序中同时存在成百上千个协程栈，那么这一扫描过程的耗时将不容忽视，根据官方统计的数据，重新扫描的耗时大概在10-100毫秒左右。</p><p>优点：扫描时不需要STW</p><p>缺点：需要二次扫描栈空间保证正确性，需要STW</p><h3 id="删除写屏障" tabindex="-1"><a class="header-anchor" href="#删除写屏障" aria-hidden="true">#</a> 删除写屏障</h3><p>删除写屏障由Yuasa提出，又称基于起始快照的屏障，该方式在开始时需要STW来对根对象进行快照记录，并且它会将所有根对象标黑，所有的一级子对象标灰，这样其余的白色子对象都会处于灰色对象的保护之下。Go团队并没有直接应用删除写屏障，而是选择了将其与插入写屏障混合使用，所以为了方便后续的理解，这里还是要讲一下。删除写屏障在并发条件下保证正确性的规则是：当从灰色或白色对象删除对白色对象的引用时，都会直接将白色对象标记为灰色对象。</p><p>分两种情况来解读：</p><ul><li><p>删除灰色对象对于白色对象的引用：由于不知道白色对象下游是否被黑色对象引用，此举可能会切断灰色对象对于白色对象的保护</p></li><li><p>删除白色对象对于白色对象的引用：由于不知道白色对象上游是否被灰色保护，下游是否被黑色对象引用，此举也可能会切断灰色对于白色对象的保护</p></li></ul><p>不管是哪种情况，删除写屏障都会将被引用的白色对象标记为灰色，这样一来就能满足弱三色不变式。这是一种保守的做法，因为上下游情况未知，将其标记为灰色就等于不再视其为垃圾对象，就算删除引用后会导致该对象不可达也就是成为垃圾对象时，也仍然会将其标记为灰色，它会在下轮扫描中被释放掉，这总好过对象被误清理而导致的内存错误。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406061744903.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>优点：由于栈对象全黑，所以不需要二次扫描栈空间</p><p>缺点：在扫描开始时需要STW来对栈空间的根对象进行快照</p><h3 id="混合写屏障" tabindex="-1"><a class="header-anchor" href="#混合写屏障" aria-hidden="true">#</a> 混合写屏障</h3><p>go1.8版本引用了新的屏障机制：混合写屏障，即插入写屏障与删除写屏障的混合，结合了它们两个的优点：</p><ul><li>插入写屏障起始时不需要STW来进行快照</li><li>删除写屏障不需要STW来二次扫描栈空间</li></ul><p>下面是官方给出的的伪代码：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>writePointer(slot, ptr):
    shade(*slot)
    if current stack is grey:
        shade(ptr)
    *slot = ptr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>简单讲解下里面的一些概念，其中<code>slot</code>是一个指针，表示对其它对象的引用，<code>*slot</code>是原对象，<code>ptr</code>是新对象，<code>*slot=ptr</code>是一次赋值操作，等于修改对象的引用，赋空值就是删除引用，<code>shade()</code>表示将一个对象标记为灰色，<code>shade(*slot)</code>就是将原对象标记为灰色，<code>shade(ptr)</code>就是将新对象标记为灰色，下面是一个例图，假设对象1原来引用着对象2，然后用户程序修改了引用，让对象1引用了对象3，混合写屏障捕捉到了这一行为，其中<code>*slot</code>代表的就是对象2，<code>ptr</code>代表的就是对象1。</p><figure><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406062107110.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>官方用一句话概括了上面伪代码的作用</p><blockquote><p>the write barrier shades the object whose reference is being overwritten, and, if the current goroutine&#39;s stack has not yet been scanned, also shades the reference being installed.</p></blockquote><p>翻译过来就是，当混合写屏障拦截到写操作时，会将原对象标记为灰色，如果当前协程栈还未被扫描过时，就将新对象也标记为灰色。</p><img src="https://public-1308755698.cos.ap-chongqing.myqcloud.com//img/202406062218312.png" style="zoom:33%;"><p>标记工作开始时，需要扫描栈空间以收集根对象，这时会直接将其全部标记为黑色，在此期间任何新创建对象也会被标记为黑色，保证栈中的所有都是黑色对象，所以伪代码中的<code>current stack is grey</code>表示的就是当前协程栈还未被扫描过，所以协程栈只有两种状态，要么全黑要么全灰，在由全灰变为全黑的过程中是需要暂停当前协程的，所以在混合写屏障下依然会有局部的STW。当协程栈全黑时，此时一定满足强三色不变式，因为扫描后栈中的黑色对象只会引用灰色对象，不会存在黑色对象直接引用白色对象的情况，所以此时不需要插入写屏障，对应伪代码</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>if current stack is grey:
        shade(ptr)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>但仍然需要删除写屏障来满足弱三色不变式，也就是</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>shade(*slot)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在扫描完毕后，由于栈空间的对象已经是全黑的了，就不再需要去二次扫描栈空间了，可以节省掉STW的时间。</p><p>至此，也就是go1.8版本往后，Go大体上确立了垃圾回收的基本框架，后续版本有关垃圾回收的优化也都是建立在混合写屏障的基础之上的，由于已经消除了大部分的STW，此时垃圾回收的平均延时已经降低到了微秒级别。</p><h3 id="着色缓存" tabindex="-1"><a class="header-anchor" href="#着色缓存" aria-hidden="true">#</a> 着色缓存</h3><p>在之前提到的屏障机制中，在拦截到写操作时都是立即标记对象颜色，在采用混合写屏障后，由于需要对原对象和新对象都行进行标记，所以工作量会翻倍，同时编译器插入的代码也会增加。为了进行优化，在go1.10版本中，写屏障在进行着色时不再会立即标记对象颜色，而是会将原对象和新对象存入一个缓存池中，等积攒到了一定数量后，再进行批量标记，这样做效率更高。</p><p>负责缓存的结构是<code>runtime.wbBuf</code>，它实际上是一个数组，大小为512。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> wbBuf <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next <span class="token builtin">uintptr</span>
	end <span class="token builtin">uintptr</span>
	buf <span class="token punctuation">[</span>wbBufEntries<span class="token punctuation">]</span><span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每一个P本地都有这样一个缓存</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	wbBuf wbBuf
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在标记工作进行时，如果<code>gcw</code>队列中没有可用的灰色对象，就会将缓存中的对象放入本地队列中。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcDrain</span><span class="token punctuation">(</span>gcw <span class="token operator">*</span>gcWork<span class="token punctuation">,</span> flags gcDrainFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>preempt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>preemptible <span class="token operator">||</span> sched<span class="token punctuation">.</span>gcwaiting<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> pp<span class="token punctuation">.</span>runSafePointFn <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> work<span class="token punctuation">.</span>full <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			gcw<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		b <span class="token operator">:=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGetFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token comment">// 刷新写屏障缓存</span>
				<span class="token function">wbBufFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token function">scanobject</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> gcw<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外一种情况是，当标记终止时，也会检查每一个P本地的<code>wbBuf</code>是否有剩下的灰色对象</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">gcMarkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
	<span class="token function">forEachP</span><span class="token punctuation">(</span>waitReasonGCMarkTermination<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		
		<span class="token function">wbBufFlush1</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>

		pp<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="回收" tabindex="-1"><a class="header-anchor" href="#回收" aria-hidden="true">#</a> 回收</h2><p>在垃圾回收中，最重要的部分在于如何找出垃圾对象，也就是扫描标记工作，而在标记工作完成后，回收工作就相对没那么复杂，它只需要将未标记的对象回收释放就行。这部分代码主要在<code>runtime/mgcsweep.go</code>文件中，根据文件中注释可以得知Go中的回收算法分为两种。</p><h3 id="对象回收" tabindex="-1"><a class="header-anchor" href="#对象回收" aria-hidden="true">#</a> 对象回收</h3><p>对象回收的工作会在标记终止阶段，由<code>runtime.sweepone</code>来完成清理工作，过程是异步的。在清理时，它会尝试在内存单元中寻找未标记的对象，然后回收掉。倘若整个内存单元都未被标记，那么这一个单元都会被回收掉。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
	sl <span class="token operator">:=</span> sweep<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	npages <span class="token operator">:=</span> <span class="token operator">^</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> noMoreWork <span class="token builtin">bool</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		s <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span><span class="token function">nextSpanForSweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			noMoreWork <span class="token operator">=</span> sweep<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">markDrained</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> state <span class="token operator">:=</span> s<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> state <span class="token operator">!=</span> mSpanInUse <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 尝试获取回收器</span>
		<span class="token keyword">if</span> s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> sl<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			npages <span class="token operator">=</span> s<span class="token punctuation">.</span>npages
            <span class="token comment">// 清理</span>
			<span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				mheap_<span class="token punctuation">.</span>reclaimCredit<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>npages<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				npages <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	sweep<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token keyword">return</span> npages
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于对象回收算法而言，回收整个单元比较的困难，所以就有了第二个回收算法。</p><h3 id="单元回收" tabindex="-1"><a class="header-anchor" href="#单元回收" aria-hidden="true">#</a> 单元回收</h3><p>单元回收的工作是在内存分配前进行的，由<code>runtime.mheap.reclaim</code>方法来完成，它会在堆中寻找所有对象都未被标记的内存单元，然后将整个单元回收。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>mheap<span class="token punctuation">)</span> <span class="token function">reclaim</span><span class="token punctuation">(</span>npage <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mp <span class="token operator">:=</span> <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	trace <span class="token operator">:=</span> <span class="token function">traceAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		trace<span class="token punctuation">.</span><span class="token function">GCSweepStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">traceRelease</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	arenas <span class="token operator">:=</span> h<span class="token punctuation">.</span>sweepArenas
	locked <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> npage <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> credit <span class="token operator">:=</span> h<span class="token punctuation">.</span>reclaimCredit<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> credit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			take <span class="token operator">:=</span> credit
			<span class="token keyword">if</span> take <span class="token operator">&gt;</span> npage <span class="token punctuation">{</span>
				take <span class="token operator">=</span> npage
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> h<span class="token punctuation">.</span>reclaimCredit<span class="token punctuation">.</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span>credit<span class="token punctuation">,</span> credit<span class="token operator">-</span>take<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				npage <span class="token operator">-=</span> take
			<span class="token punctuation">}</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		idx <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>reclaimIndex<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pagesPerReclaimerChunk<span class="token punctuation">)</span> <span class="token operator">-</span> pagesPerReclaimerChunk<span class="token punctuation">)</span>
		<span class="token keyword">if</span> idx<span class="token operator">/</span>pagesPerArena <span class="token operator">&gt;=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>arenas<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>reclaimIndex<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">63</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		nfound <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">reclaimChunk</span><span class="token punctuation">(</span>arenas<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> pagesPerReclaimerChunk<span class="token punctuation">)</span>
		<span class="token keyword">if</span> nfound <span class="token operator">&lt;=</span> npage <span class="token punctuation">{</span>
			npage <span class="token operator">-=</span> nfound
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			h<span class="token punctuation">.</span>reclaimCredit<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>nfound <span class="token operator">-</span> npage<span class="token punctuation">)</span>
			npage <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	trace <span class="token operator">=</span> <span class="token function">traceAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		trace<span class="token punctuation">.</span><span class="token function">GCSweepDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">traceRelease</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于内存单元而言，有一个<code>sweepgen</code>字段用于表明其回收状态</p><ul><li><code>mspan.sweepgen == mheap.sweepgen - 2</code>：该内存单元需要回收</li><li><code>mspan.sweepgen == mheap.sweepgen - 1</code>：该内存单元正在被回收</li><li><code>mspan.sweepgen == mheap.sweepgen</code>：该内存单元已经被回收了，可以正常使用</li><li><code>mspan.sweepgen == mheap.sweepgen + 1</code>：内存单元在缓存中，且需要回收</li><li><code>mspan.sweepgen == mheap.sweepgen + 3</code>：内存单元已经被回收了，但仍然在缓存中</li></ul><p><code>mheap.sweepgen</code>会随着GC轮次而增加，并且每一次都会+2。</p>`,53);function x(B,T){const t=i("ExternalLinkIcon");return o(),c("div",null,[u,n("div",r,[d,n("p",null,[s("前往"),n("a",k,[s("The Journey of Go's Garbage Collector"),e(t)]),s("阅读英文原文，了解更多有关Go垃圾回收的历史")])]),v,n("div",m,[b,n("p",null,[s("感兴趣可以前往"),n("a",g,[s("Go Gc Pacer Re-Design"),e(t)]),s("阅读英文原文，里面讲解了有关于触发GC的调步算法(pacing algorithm)的设计理念和改进，因其内容比较复杂涉及过多的数学公式，正文中不做过多阐述。")])]),f,n("p",null,[s("三色不变性这一概念来自于Pekka P. Pirinen于1998年发表的论文"),n("a",h,[s("《Barrier techniques for incremental tracing》"),e(t)]),s("，它指在并发标记时的对象颜色的两个不变性：")]),w,n("div",y,[W,n("p",null,[s("想要了解更多Go对于屏障技术的应用细节，前往"),n("a",C,[s("Eliminate STW stack rescan"),e(t)]),s("阅读英文原文，本文参考了许多内容。")])]),G])}const _=p(l,[["render",x],["__file","9.gc.html.vue"]]);export{_ as default};
