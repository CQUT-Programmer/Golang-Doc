<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://golang.halfiisland.com/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html"><meta property="og:site_name" content="Golang中文学习文档"><meta property="og:title" content="Gorm"><meta property="og:description" content="官方文档：Gen Guides | GORM - The fantastic ORM library for Golang, aims to be developer friendly. (https://gorm.io/gen/index.html) 官方仓库：go-gorm/gorm: The fantastic ORM library for G..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-02T06:50:29.000Z"><meta property="article:modified_time" content="2023-04-02T06:50:29.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Gorm","image":[""],"dateModified":"2023-04-02T06:50:29.000Z","author":[]}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>Gorm | Golang中文学习文档</title><meta name="description" content="官方文档：Gen Guides | GORM - The fantastic ORM library for Golang, aims to be developer friendly. (https://gorm.io/gen/index.html) 官方仓库：go-gorm/gorm: The fantastic ORM library for G...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-933124f9.css" as="style"><link rel="stylesheet" href="/assets/style-933124f9.css">
    <link rel="modulepreload" href="/assets/app-6834afb2.js"><link rel="modulepreload" href="/assets/framework-44a66fc7.js"><link rel="modulepreload" href="/assets/gorm.html-9eebe5c0.js"><link rel="modulepreload" href="/assets/gorm.html-187103d8.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.png" alt="Golang中文学习文档"><!----><span class="site-name hide-in-pad">Golang中文学习文档</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/guide.html" class="nav-link" aria-label="指南"><span class="font-icon icon iconfont icon-activity" style=""></span>指南<!----></a></div><div class="nav-item hide-in-mobile"><a href="/link.html" class="nav-link" aria-label="外链"><span class="font-icon icon iconfont icon-share" style=""></span>外链<!----></a></div><div class="nav-item hide-in-mobile"><a href="/cmd.html" class="nav-link" aria-label="命令"><span class="font-icon icon iconfont icon-shell" style=""></span>命令<!----></a></div><div class="nav-item hide-in-mobile"><a href="/release.html" class="nav-link" aria-label="更新日志"><span class="font-icon icon iconfont icon-repo" style=""></span>更新日志<!----></a></div><div class="nav-item hide-in-mobile"><a href="/deb.html" class="nav-link" aria-label="依赖导航"><span class="font-icon icon iconfont icon-discover" style=""></span>依赖导航<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://go.dev/play/" rel="noopener noreferrer" target="_blank" aria-label="在线运行" class="nav-link"><span class="font-icon icon iconfont icon-back-stage" style=""></span>在线运行<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://go.dev/ref/spec" rel="noopener noreferrer" target="_blank" aria-label="参考手册" class="nav-link"><span class="font-icon icon iconfont icon-article" style=""></span>参考手册<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about.html" class="nav-link" aria-label="关于作者"><span class="font-icon icon iconfont icon-alias" style=""></span>关于作者<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/CQUT-Programmer/Golang-Doc" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-activity" style=""></span><span class="title">语言入门</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-bit" style=""></span><span class="title">语法基础</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">语法进阶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-blog" style=""></span><span class="title">标准库</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-advance" style=""></span><span class="title">语言进阶</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-engine" style=""></span><span class="title">原理解析</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-diagram" style=""></span><span class="title">实用依赖</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-customize" style=""></span><span class="title">实用框架</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/beego.html" class="nav-link sidebar-link sidebar-page" aria-label="Beego"><!---->Beego<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gin.html" class="nav-link sidebar-link sidebar-page" aria-label="Gin"><!---->Gin<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Gorm"><!---->Gorm<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="安装"><!---->安装<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#快速入门" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="快速入门"><!---->快速入门<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#模型" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="模型"><!---->模型<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链接数据库" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="链接数据库"><!---->链接数据库<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#增加记录" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="增加记录"><!---->增加记录<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询记录" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询记录"><!---->查询记录<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新记录" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="更新记录"><!---->更新记录<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除记录" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="删除记录"><!---->删除记录<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#完整代码" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="完整代码"><!---->完整代码<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库连接" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="数据库连接"><!---->数据库连接<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#mysql" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MySQL"><!---->MySQL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#postgresql" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PostgreSQL"><!---->PostgreSQL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sqlite" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SQLite"><!---->SQLite<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql-server" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SQL Server"><!---->SQL Server<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="连接池"><!---->连接池<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约定俗成" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="约定俗成"><!---->约定俗成<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#id-作为主键" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ID 作为主键"><!---->ID 作为主键<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复数表名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="复数表名"><!---->复数表名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#tablename" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TableName"><!---->TableName<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#动态表名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="动态表名"><!---->动态表名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#临时表名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="临时表名"><!---->临时表名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#列名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="列名"><!---->列名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#时间戳追踪" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="时间戳追踪"><!---->时间戳追踪<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#模型-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="模型"><!---->模型<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#gorm-model" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Gorm.Model"><!---->Gorm.Model<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段级权限控制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字段级权限控制"><!---->字段级权限控制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建-更新时间追踪" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="创建/更新时间追踪"><!---->创建/更新时间追踪<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段标签" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字段标签"><!---->字段标签<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询"><!---->查询<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索单个对象" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索单个对象"><!---->检索单个对象<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#主键检索" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="主键检索"><!---->主键检索<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索全部对象" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索全部对象"><!---->检索全部对象<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字符串条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字符串条件"><!---->字符串条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据结构条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="数据结构条件"><!---->数据结构条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#内联条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="内联条件"><!---->内联条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#not条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Not条件"><!---->Not条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#or条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Or条件"><!---->Or条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#排序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="排序"><!---->排序<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#limi-offset" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Limi&amp;Offset"><!---->Limi&amp;Offset<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#distinct" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Distinct"><!---->Distinct<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#group-having" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Group&amp;Having"><!---->Group&amp;Having<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#join" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Join"><!---->Join<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scan" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Scan"><!---->Scan<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#高级查询" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="高级查询"><!---->高级查询<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动选择字段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自动选择字段"><!---->自动选择字段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="锁"><!---->锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子查询" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子查询"><!---->子查询<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#条件组" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="条件组"><!---->条件组<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多列in" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="多列IN"><!---->多列IN<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#命名参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="命名参数"><!---->命名参数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#map扫描" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Map扫描"><!---->Map扫描<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#firstorinit" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="FirstOrInit"><!---->FirstOrInit<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#firstorcreate" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="FirstOrCreate"><!---->FirstOrCreate<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#优化器-索引提示" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="优化器/索引提示"><!---->优化器/索引提示<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#迭代" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="迭代"><!---->迭代<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#findinbatches" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="FindInBatches"><!---->FindInBatches<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="钩子方法"><!---->钩子方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#pluck" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Pluck"><!---->Pluck<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scope" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Scope"><!---->Scope<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#count" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Count"><!---->Count<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="创建"><!---->创建<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#指定字段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="指定字段"><!---->指定字段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段默认值" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字段默认值"><!---->字段默认值<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量创建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="批量创建"><!---->批量创建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#map创建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Map创建"><!---->Map创建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="钩子方法"><!---->钩子方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联创建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="关联创建"><!---->关联创建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#upsert-及冲突" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Upsert 及冲突"><!---->Upsert 及冲突<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="更新"><!---->更新<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#所有字段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="所有字段"><!---->所有字段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="单列"><!---->单列<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="多列"><!---->多列<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#选定字段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="选定字段"><!---->选定字段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="批量更新"><!---->批量更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#阻止全局更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="阻止全局更新"><!---->阻止全局更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#使用sql表达式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="使用SQL表达式"><!---->使用SQL表达式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子查询更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子查询更新"><!---->子查询更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新钩子方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="更新钩子方法"><!---->更新钩子方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁止hook与时间更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="禁止Hook与时间更新"><!---->禁止Hook与时间更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#返回更新的数据" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="返回更新的数据"><!---->返回更新的数据<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检查字段值是否有更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检查字段值是否有更新"><!---->检查字段值是否有更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#在更新前修改值" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="在更新前修改值"><!---->在更新前修改值<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="删除"><!---->删除<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单个删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="单个删除"><!---->单个删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#根据主键删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="根据主键删除"><!---->根据主键删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="批量删除"><!---->批量删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#阻止全局删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="阻止全局删除"><!---->阻止全局删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#返回删除行的数据" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="返回删除行的数据"><!---->返回删除行的数据<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#软删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="软删除"><!---->软删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#软删除标志" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="软删除标志"><!---->软删除标志<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql构建器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SQL构建器"><!---->SQL构建器<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#原生sql" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="原生SQL"><!---->原生SQL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#命名参数-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="命名参数"><!---->命名参数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#dryrun模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DryRun模式"><!---->DryRun模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#tosql" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TOSQL"><!---->TOSQL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#row-rows" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Row &amp; Rows"><!---->Row &amp; Rows<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="连接"><!---->连接<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句-clause" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子句(Clause)"><!---->子句(Clause)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句构造器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子句构造器"><!---->子句构造器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句选项" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子句选项"><!---->子句选项<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#statementmodifier" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StatementModifier"><!---->StatementModifier<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#belongs-to" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Belongs To"><!---->Belongs To<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#示例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="示例"><!---->示例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写外键"><!---->重写外键<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写引用"><!---->重写引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="外键约束"><!---->外键约束<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#has-one" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Has One"><!---->Has One<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写外键"><!---->重写外键<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写引用"><!---->重写引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多态关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="多态关联"><!---->多态关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用-has-one" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自引用 Has One"><!---->自引用 Has One<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="外键约束"><!---->外键约束<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#has-many" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Has Many"><!---->Has Many<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#声明" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="声明"><!---->声明<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索"><!---->检索<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写外键"><!---->重写外键<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写引用"><!---->重写引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多态关联-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="多态关联"><!---->多态关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自引用"><!---->自引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="外键约束"><!---->外键约束<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#many-to-many" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Many To Many"><!---->Many To Many<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#声明-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="声明"><!---->声明<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索"><!---->检索<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-3" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重写外键"><!---->重写外键<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自引用"><!---->自引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义连接表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自定义连接表"><!---->自定义连接表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-3" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="外键约束"><!---->外键约束<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复合外键" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="复合外键"><!---->复合外键<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="关联模式"><!---->关联模式<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动创建-更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自动创建，更新"><!---->自动创建，更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#跳过自动创建、更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="跳过自动创建、更新"><!---->跳过自动创建、更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查找关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查找关联"><!---->查找关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#添加关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="添加关联"><!---->添加关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#替换关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="替换关联"><!---->替换关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="删除关联"><!---->删除关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#清空关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="清空关联"><!---->清空关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联计数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="关联计数"><!---->关联计数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量处理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="批量处理"><!---->批量处理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#select删除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Select删除"><!---->Select删除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联标签" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="关联标签"><!---->关联标签<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预加载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="预加载"><!---->预加载<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#joins-预加载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Joins 预加载"><!---->Joins 预加载<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预加载全部" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="预加载全部"><!---->预加载全部<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#条件预加载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="条件预加载"><!---->条件预加载<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义预加载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自定义预加载"><!---->自定义预加载<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#嵌套预加载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="嵌套预加载"><!---->嵌套预加载<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#context" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Context"><!---->Context<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单会话模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="单会话模式"><!---->单会话模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#持续会话模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="持续会话模式"><!---->持续会话模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#会话超时" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="会话超时"><!---->会话超时<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#hooks-callbacks-中的-context" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Hooks/Callbacks 中的 Context"><!---->Hooks/Callbacks 中的 Context<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#错误处理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="错误处理"><!---->错误处理<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#示例-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="示例"><!---->示例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#错误列表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="错误列表"><!---->错误列表<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链式操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="链式操作"><!---->链式操作<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链式方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="链式方法"><!---->链式方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#终结方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="终结方法"><!---->终结方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#新建会话方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="新建会话方法"><!---->新建会话方法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#会话" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="会话"><!---->会话<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#dryrun" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DryRun"><!---->DryRun<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预编译" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="预编译"><!---->预编译<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#newdb" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="NewDB"><!---->NewDB<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#初始化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="初始化"><!---->初始化<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#跳过钩子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="跳过钩子"><!---->跳过钩子<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用嵌套事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="禁用嵌套事务"><!---->禁用嵌套事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用全局更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="禁用全局更新"><!---->禁用全局更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#保存所有关联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="保存所有关联"><!---->保存所有关联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#context-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Context"><!---->Context<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义-logger" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自定义 Logger"><!---->自定义 Logger<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#nowfunc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="NowFunc"><!---->NowFunc<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#调试" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="调试"><!---->调试<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询字段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询字段"><!---->查询字段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#createbatchsize" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CreateBatchSize"><!---->CreateBatchSize<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="钩子方法"><!---->钩子方法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#生命周期" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="生命周期"><!---->生命周期<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建钩子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="创建钩子"><!---->创建钩子<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新钩子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="更新钩子"><!---->更新钩子<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除钩子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="删除钩子"><!---->删除钩子<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询钩子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询钩子"><!---->查询钩子<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="索引"><!---->索引<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#标签" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="标签"><!---->标签<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#唯一索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="唯一索引"><!---->唯一索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复合索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="复合索引"><!---->复合索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段优先级" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字段优先级"><!---->字段优先级<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#共享复合索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="共享复合索引"><!---->共享复合索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="多索引"><!---->多索引<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约束" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="约束"><!---->约束<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检查约束" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检查约束"><!---->检查约束<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-4" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="外键约束"><!---->外键约束<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务"><!---->事务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用默认事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="禁用默认事务"><!---->禁用默认事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务使用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务使用"><!---->事务使用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#嵌套事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="嵌套事务"><!---->嵌套事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#手动事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="手动事务"><!---->手动事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#定点回滚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定点回滚"><!---->定点回滚<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#迁移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="迁移"><!---->迁移<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动迁移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自动迁移"><!---->自动迁移<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#migrator-接口" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Migrator 接口"><!---->Migrator 接口<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#当前数据库" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="当前数据库"><!---->当前数据库<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="表"><!---->表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="列"><!---->列<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约束-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="约束"><!---->约束<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="索引"><!---->索引<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#日志" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="日志"><!---->日志<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#日志级别" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="日志级别"><!---->日志级别<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#debug" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Debug"><!---->Debug<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义-logger-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自定义 Logger"><!---->自定义 Logger<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#安全" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="安全"><!---->安全<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询条件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询条件"><!---->查询条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#内联条件-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="内联条件"><!---->内联条件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql-注入方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SQL 注入方法"><!---->SQL 注入方法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#通用数据库接口" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="通用数据库接口"><!---->通用数据库接口<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="连接池"><!---->连接池<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#性能" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="性能"><!---->性能<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用默认事务-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="禁用默认事务"><!---->禁用默认事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#缓存预编译语句" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="缓存预编译语句"><!---->缓存预编译语句<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#带预编译的sql生成器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="带预编译的SQL生成器"><!---->带预编译的SQL生成器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#缩小字段选择范围" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="缩小字段选择范围"><!---->缩小字段选择范围<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#findinbatches-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="FindInBatches"><!---->FindInBatches<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引提示" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="索引提示"><!---->索引提示<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#读写分离" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="读写分离"><!---->读写分离<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义数据类型" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自定义数据类型"><!---->自定义数据类型<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scanner-valuer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Scanner/valuer"><!---->Scanner/valuer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据类型接口" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="数据类型接口"><!---->数据类型接口<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#gormvaluerinterface" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="GormValuerInterface"><!---->GormValuerInterface<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句表达式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="子句表达式"><!---->子句表达式<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scope-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Scope"><!---->Scope<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="查询"><!---->查询<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#分页" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分页"><!---->分页<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#动态表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="动态表"><!---->动态表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="更新"><!---->更新<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库实例的上下文值传递" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="数据库实例的上下文值传递"><!---->数据库实例的上下文值传递<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#set-get" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Set / Get"><!---->Set / Get<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#instanceset-instanceget" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="InstanceSet / InstanceGet"><!---->InstanceSet / InstanceGet<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库解析器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="数据库解析器"><!---->数据库解析器<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#用法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="用法"><!---->用法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动切换连接" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自动切换连接"><!---->自动切换连接<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#读写分离-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="读写分离"><!---->读写分离<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#手动切换连接" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="手动切换连接"><!---->手动切换连接<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事务"><!---->事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#负载均衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="负载均衡"><!---->负载均衡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="连接池"><!---->连接池<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/xorm.html" class="nav-link sidebar-link sidebar-page" aria-label="Xorm"><!---->Xorm<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">数据操作</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-change" style=""></span><span class="title">微服务</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-study" style=""></span><span class="title">理论思想</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-line" style=""></span><span class="title">设计模式</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-line" style=""></span><span class="title">算法刷题</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">实用技术</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-discover" style=""></span><span class="title">中间件</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-snow" style=""></span><span class="title">有趣技术</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-git" style=""></span><span class="title">Git</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-relation" style=""></span><span class="title">Docker</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-linux" style=""></span><span class="title">Linux</span><span class="arrow right"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Gorm</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.vegetableprogrammer.top/" target="_blank" rel="noopener noreferrer">寒江蓑笠翁</a></span><span property="author" content="寒江蓑笠翁"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-13T05:04:15.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 160 分钟</span><meta property="timeRequired" content="PT160M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#安装" class="router-link-active router-link-exact-active toc-link level2">安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#快速入门" class="router-link-active router-link-exact-active toc-link level2">快速入门</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#模型" class="router-link-active router-link-exact-active toc-link level3">模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链接数据库" class="router-link-active router-link-exact-active toc-link level3">链接数据库</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#增加记录" class="router-link-active router-link-exact-active toc-link level3">增加记录</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询记录" class="router-link-active router-link-exact-active toc-link level3">查询记录</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新记录" class="router-link-active router-link-exact-active toc-link level3">更新记录</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除记录" class="router-link-active router-link-exact-active toc-link level3">删除记录</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#完整代码" class="router-link-active router-link-exact-active toc-link level3">完整代码</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库连接" class="router-link-active router-link-exact-active toc-link level2">数据库连接</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#mysql" class="router-link-active router-link-exact-active toc-link level3">MySQL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#postgresql" class="router-link-active router-link-exact-active toc-link level3">PostgreSQL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sqlite" class="router-link-active router-link-exact-active toc-link level3">SQLite</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql-server" class="router-link-active router-link-exact-active toc-link level3">SQL Server</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池" class="router-link-active router-link-exact-active toc-link level3">连接池</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约定俗成" class="router-link-active router-link-exact-active toc-link level2">约定俗成</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#id-作为主键" class="router-link-active router-link-exact-active toc-link level3">ID 作为主键</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复数表名" class="router-link-active router-link-exact-active toc-link level3">复数表名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#tablename" class="router-link-active router-link-exact-active toc-link level3">TableName</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#动态表名" class="router-link-active router-link-exact-active toc-link level3">动态表名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#临时表名" class="router-link-active router-link-exact-active toc-link level3">临时表名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#列名" class="router-link-active router-link-exact-active toc-link level3">列名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#时间戳追踪" class="router-link-active router-link-exact-active toc-link level3">时间戳追踪</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#模型-1" class="router-link-active router-link-exact-active toc-link level2">模型</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#gorm-model" class="router-link-active router-link-exact-active toc-link level3">Gorm.Model</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段级权限控制" class="router-link-active router-link-exact-active toc-link level3">字段级权限控制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建-更新时间追踪" class="router-link-active router-link-exact-active toc-link level3">创建/更新时间追踪</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段标签" class="router-link-active router-link-exact-active toc-link level3">字段标签</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询" class="router-link-active router-link-exact-active toc-link level2">查询</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索单个对象" class="router-link-active router-link-exact-active toc-link level3">检索单个对象</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#主键检索" class="router-link-active router-link-exact-active toc-link level3">主键检索</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索全部对象" class="router-link-active router-link-exact-active toc-link level3">检索全部对象</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字符串条件" class="router-link-active router-link-exact-active toc-link level3">字符串条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据结构条件" class="router-link-active router-link-exact-active toc-link level3">数据结构条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#内联条件" class="router-link-active router-link-exact-active toc-link level3">内联条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#not条件" class="router-link-active router-link-exact-active toc-link level3">Not条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#or条件" class="router-link-active router-link-exact-active toc-link level3">Or条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#排序" class="router-link-active router-link-exact-active toc-link level3">排序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#limi-offset" class="router-link-active router-link-exact-active toc-link level3">Limi&amp;Offset</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#distinct" class="router-link-active router-link-exact-active toc-link level3">Distinct</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#group-having" class="router-link-active router-link-exact-active toc-link level3">Group&amp;Having</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#join" class="router-link-active router-link-exact-active toc-link level3">Join</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scan" class="router-link-active router-link-exact-active toc-link level3">Scan</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#高级查询" class="router-link-active router-link-exact-active toc-link level2">高级查询</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动选择字段" class="router-link-active router-link-exact-active toc-link level3">自动选择字段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#锁" class="router-link-active router-link-exact-active toc-link level3">锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子查询" class="router-link-active router-link-exact-active toc-link level3">子查询</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#条件组" class="router-link-active router-link-exact-active toc-link level3">条件组</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多列in" class="router-link-active router-link-exact-active toc-link level3">多列IN</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#命名参数" class="router-link-active router-link-exact-active toc-link level3">命名参数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#map扫描" class="router-link-active router-link-exact-active toc-link level3">Map扫描</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#firstorinit" class="router-link-active router-link-exact-active toc-link level3">FirstOrInit</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#firstorcreate" class="router-link-active router-link-exact-active toc-link level3">FirstOrCreate</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#优化器-索引提示" class="router-link-active router-link-exact-active toc-link level3">优化器/索引提示</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#迭代" class="router-link-active router-link-exact-active toc-link level3">迭代</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#findinbatches" class="router-link-active router-link-exact-active toc-link level3">FindInBatches</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法" class="router-link-active router-link-exact-active toc-link level3">钩子方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#pluck" class="router-link-active router-link-exact-active toc-link level3">Pluck</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scope" class="router-link-active router-link-exact-active toc-link level3">Scope</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#count" class="router-link-active router-link-exact-active toc-link level3">Count</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建" class="router-link-active router-link-exact-active toc-link level2">创建</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#指定字段" class="router-link-active router-link-exact-active toc-link level3">指定字段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段默认值" class="router-link-active router-link-exact-active toc-link level3">字段默认值</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量创建" class="router-link-active router-link-exact-active toc-link level3">批量创建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#map创建" class="router-link-active router-link-exact-active toc-link level3">Map创建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法-1" class="router-link-active router-link-exact-active toc-link level3">钩子方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联创建" class="router-link-active router-link-exact-active toc-link level3">关联创建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#upsert-及冲突" class="router-link-active router-link-exact-active toc-link level3">Upsert 及冲突</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新" class="router-link-active router-link-exact-active toc-link level2">更新</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#所有字段" class="router-link-active router-link-exact-active toc-link level3">所有字段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单列" class="router-link-active router-link-exact-active toc-link level3">单列</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多列" class="router-link-active router-link-exact-active toc-link level3">多列</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#选定字段" class="router-link-active router-link-exact-active toc-link level3">选定字段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量更新" class="router-link-active router-link-exact-active toc-link level3">批量更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#阻止全局更新" class="router-link-active router-link-exact-active toc-link level3">阻止全局更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#使用sql表达式" class="router-link-active router-link-exact-active toc-link level3">使用SQL表达式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子查询更新" class="router-link-active router-link-exact-active toc-link level3">子查询更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新钩子方法" class="router-link-active router-link-exact-active toc-link level3">更新钩子方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁止hook与时间更新" class="router-link-active router-link-exact-active toc-link level3">禁止Hook与时间更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#返回更新的数据" class="router-link-active router-link-exact-active toc-link level3">返回更新的数据</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检查字段值是否有更新" class="router-link-active router-link-exact-active toc-link level3">检查字段值是否有更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#在更新前修改值" class="router-link-active router-link-exact-active toc-link level3">在更新前修改值</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除" class="router-link-active router-link-exact-active toc-link level2">删除</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单个删除" class="router-link-active router-link-exact-active toc-link level3">单个删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#根据主键删除" class="router-link-active router-link-exact-active toc-link level3">根据主键删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量删除" class="router-link-active router-link-exact-active toc-link level3">批量删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#阻止全局删除" class="router-link-active router-link-exact-active toc-link level3">阻止全局删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#返回删除行的数据" class="router-link-active router-link-exact-active toc-link level3">返回删除行的数据</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#软删除" class="router-link-active router-link-exact-active toc-link level3">软删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#软删除标志" class="router-link-active router-link-exact-active toc-link level3">软删除标志</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql构建器" class="router-link-active router-link-exact-active toc-link level2">SQL构建器</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#原生sql" class="router-link-active router-link-exact-active toc-link level3">原生SQL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#命名参数-1" class="router-link-active router-link-exact-active toc-link level3">命名参数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#dryrun模式" class="router-link-active router-link-exact-active toc-link level3">DryRun模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#tosql" class="router-link-active router-link-exact-active toc-link level3">TOSQL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#row-rows" class="router-link-active router-link-exact-active toc-link level3">Row &amp; Rows</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接" class="router-link-active router-link-exact-active toc-link level3">连接</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句-clause" class="router-link-active router-link-exact-active toc-link level3">子句(Clause)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句构造器" class="router-link-active router-link-exact-active toc-link level3">子句构造器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句选项" class="router-link-active router-link-exact-active toc-link level3">子句选项</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#statementmodifier" class="router-link-active router-link-exact-active toc-link level3">StatementModifier</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#belongs-to" class="router-link-active router-link-exact-active toc-link level2">Belongs To</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#示例" class="router-link-active router-link-exact-active toc-link level3">示例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键" class="router-link-active router-link-exact-active toc-link level3">重写外键</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用" class="router-link-active router-link-exact-active toc-link level3">重写引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束" class="router-link-active router-link-exact-active toc-link level3">外键约束</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#has-one" class="router-link-active router-link-exact-active toc-link level2">Has One</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-1" class="router-link-active router-link-exact-active toc-link level3">重写外键</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用-1" class="router-link-active router-link-exact-active toc-link level3">重写引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多态关联" class="router-link-active router-link-exact-active toc-link level3">多态关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用-has-one" class="router-link-active router-link-exact-active toc-link level3">自引用 Has One</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-1" class="router-link-active router-link-exact-active toc-link level3">外键约束</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#has-many" class="router-link-active router-link-exact-active toc-link level2">Has Many</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#声明" class="router-link-active router-link-exact-active toc-link level3">声明</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索" class="router-link-active router-link-exact-active toc-link level3">检索</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-2" class="router-link-active router-link-exact-active toc-link level3">重写外键</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写引用-2" class="router-link-active router-link-exact-active toc-link level3">重写引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多态关联-1" class="router-link-active router-link-exact-active toc-link level3">多态关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用" class="router-link-active router-link-exact-active toc-link level3">自引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-2" class="router-link-active router-link-exact-active toc-link level3">外键约束</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#many-to-many" class="router-link-active router-link-exact-active toc-link level2">Many To Many</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#声明-1" class="router-link-active router-link-exact-active toc-link level3">声明</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检索-1" class="router-link-active router-link-exact-active toc-link level3">检索</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#重写外键-3" class="router-link-active router-link-exact-active toc-link level3">重写外键</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自引用-1" class="router-link-active router-link-exact-active toc-link level3">自引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义连接表" class="router-link-active router-link-exact-active toc-link level3">自定义连接表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-3" class="router-link-active router-link-exact-active toc-link level3">外键约束</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复合外键" class="router-link-active router-link-exact-active toc-link level3">复合外键</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联模式" class="router-link-active router-link-exact-active toc-link level2">关联模式</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动创建-更新" class="router-link-active router-link-exact-active toc-link level3">自动创建，更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#跳过自动创建、更新" class="router-link-active router-link-exact-active toc-link level3">跳过自动创建、更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查找关联" class="router-link-active router-link-exact-active toc-link level3">查找关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#添加关联" class="router-link-active router-link-exact-active toc-link level3">添加关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#替换关联" class="router-link-active router-link-exact-active toc-link level3">替换关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除关联" class="router-link-active router-link-exact-active toc-link level3">删除关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#清空关联" class="router-link-active router-link-exact-active toc-link level3">清空关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联计数" class="router-link-active router-link-exact-active toc-link level3">关联计数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#批量处理" class="router-link-active router-link-exact-active toc-link level3">批量处理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#select删除" class="router-link-active router-link-exact-active toc-link level3">Select删除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#关联标签" class="router-link-active router-link-exact-active toc-link level3">关联标签</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预加载" class="router-link-active router-link-exact-active toc-link level2">预加载</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#joins-预加载" class="router-link-active router-link-exact-active toc-link level3">Joins 预加载</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预加载全部" class="router-link-active router-link-exact-active toc-link level3">预加载全部</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#条件预加载" class="router-link-active router-link-exact-active toc-link level3">条件预加载</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义预加载" class="router-link-active router-link-exact-active toc-link level3">自定义预加载</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#嵌套预加载" class="router-link-active router-link-exact-active toc-link level3">嵌套预加载</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#context" class="router-link-active router-link-exact-active toc-link level2">Context</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#单会话模式" class="router-link-active router-link-exact-active toc-link level3">单会话模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#持续会话模式" class="router-link-active router-link-exact-active toc-link level3">持续会话模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#会话超时" class="router-link-active router-link-exact-active toc-link level3">会话超时</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#hooks-callbacks-中的-context" class="router-link-active router-link-exact-active toc-link level3">Hooks/Callbacks 中的 Context</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#错误处理" class="router-link-active router-link-exact-active toc-link level2">错误处理</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#示例-1" class="router-link-active router-link-exact-active toc-link level3">示例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#错误列表" class="router-link-active router-link-exact-active toc-link level3">错误列表</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链式操作" class="router-link-active router-link-exact-active toc-link level2">链式操作</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#链式方法" class="router-link-active router-link-exact-active toc-link level3">链式方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#终结方法" class="router-link-active router-link-exact-active toc-link level3">终结方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#新建会话方法" class="router-link-active router-link-exact-active toc-link level3">新建会话方法</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#会话" class="router-link-active router-link-exact-active toc-link level2">会话</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#dryrun" class="router-link-active router-link-exact-active toc-link level3">DryRun</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#预编译" class="router-link-active router-link-exact-active toc-link level3">预编译</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#newdb" class="router-link-active router-link-exact-active toc-link level3">NewDB</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#初始化" class="router-link-active router-link-exact-active toc-link level3">初始化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#跳过钩子" class="router-link-active router-link-exact-active toc-link level3">跳过钩子</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用嵌套事务" class="router-link-active router-link-exact-active toc-link level3">禁用嵌套事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用全局更新" class="router-link-active router-link-exact-active toc-link level3">禁用全局更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#保存所有关联" class="router-link-active router-link-exact-active toc-link level3">保存所有关联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#context-1" class="router-link-active router-link-exact-active toc-link level3">Context</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义-logger" class="router-link-active router-link-exact-active toc-link level3">自定义 Logger</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#nowfunc" class="router-link-active router-link-exact-active toc-link level3">NowFunc</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#调试" class="router-link-active router-link-exact-active toc-link level3">调试</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询字段" class="router-link-active router-link-exact-active toc-link level3">查询字段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#createbatchsize" class="router-link-active router-link-exact-active toc-link level3">CreateBatchSize</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#钩子方法-2" class="router-link-active router-link-exact-active toc-link level2">钩子方法</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#生命周期" class="router-link-active router-link-exact-active toc-link level3">生命周期</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#创建钩子" class="router-link-active router-link-exact-active toc-link level3">创建钩子</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新钩子" class="router-link-active router-link-exact-active toc-link level3">更新钩子</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#删除钩子" class="router-link-active router-link-exact-active toc-link level3">删除钩子</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询钩子" class="router-link-active router-link-exact-active toc-link level3">查询钩子</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引" class="router-link-active router-link-exact-active toc-link level2">索引</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#标签" class="router-link-active router-link-exact-active toc-link level3">标签</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#唯一索引" class="router-link-active router-link-exact-active toc-link level3">唯一索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#复合索引" class="router-link-active router-link-exact-active toc-link level3">复合索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#字段优先级" class="router-link-active router-link-exact-active toc-link level3">字段优先级</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#共享复合索引" class="router-link-active router-link-exact-active toc-link level3">共享复合索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#多索引" class="router-link-active router-link-exact-active toc-link level3">多索引</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约束" class="router-link-active router-link-exact-active toc-link level2">约束</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#检查约束" class="router-link-active router-link-exact-active toc-link level3">检查约束</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#外键约束-4" class="router-link-active router-link-exact-active toc-link level3">外键约束</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务" class="router-link-active router-link-exact-active toc-link level2">事务</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用默认事务" class="router-link-active router-link-exact-active toc-link level3">禁用默认事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务使用" class="router-link-active router-link-exact-active toc-link level3">事务使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#嵌套事务" class="router-link-active router-link-exact-active toc-link level3">嵌套事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#手动事务" class="router-link-active router-link-exact-active toc-link level3">手动事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#定点回滚" class="router-link-active router-link-exact-active toc-link level3">定点回滚</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#迁移" class="router-link-active router-link-exact-active toc-link level2">迁移</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动迁移" class="router-link-active router-link-exact-active toc-link level3">自动迁移</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#migrator-接口" class="router-link-active router-link-exact-active toc-link level3">Migrator 接口</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#当前数据库" class="router-link-active router-link-exact-active toc-link level3">当前数据库</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#表" class="router-link-active router-link-exact-active toc-link level3">表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#列" class="router-link-active router-link-exact-active toc-link level3">列</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#约束-1" class="router-link-active router-link-exact-active toc-link level3">约束</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引-1" class="router-link-active router-link-exact-active toc-link level3">索引</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#日志" class="router-link-active router-link-exact-active toc-link level2">日志</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#日志级别" class="router-link-active router-link-exact-active toc-link level3">日志级别</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#debug" class="router-link-active router-link-exact-active toc-link level3">Debug</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义-logger-1" class="router-link-active router-link-exact-active toc-link level3">自定义 Logger</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#安全" class="router-link-active router-link-exact-active toc-link level2">安全</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询条件" class="router-link-active router-link-exact-active toc-link level3">查询条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#内联条件-1" class="router-link-active router-link-exact-active toc-link level3">内联条件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#sql-注入方法" class="router-link-active router-link-exact-active toc-link level3">SQL 注入方法</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#通用数据库接口" class="router-link-active router-link-exact-active toc-link level2">通用数据库接口</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池-1" class="router-link-active router-link-exact-active toc-link level3">连接池</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#性能" class="router-link-active router-link-exact-active toc-link level2">性能</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#禁用默认事务-1" class="router-link-active router-link-exact-active toc-link level3">禁用默认事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#缓存预编译语句" class="router-link-active router-link-exact-active toc-link level3">缓存预编译语句</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#带预编译的sql生成器" class="router-link-active router-link-exact-active toc-link level3">带预编译的SQL生成器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#缩小字段选择范围" class="router-link-active router-link-exact-active toc-link level3">缩小字段选择范围</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#findinbatches-1" class="router-link-active router-link-exact-active toc-link level3">FindInBatches</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#索引提示" class="router-link-active router-link-exact-active toc-link level3">索引提示</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#读写分离" class="router-link-active router-link-exact-active toc-link level3">读写分离</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自定义数据类型" class="router-link-active router-link-exact-active toc-link level2">自定义数据类型</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scanner-valuer" class="router-link-active router-link-exact-active toc-link level3">Scanner/valuer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据类型接口" class="router-link-active router-link-exact-active toc-link level3">数据类型接口</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#gormvaluerinterface" class="router-link-active router-link-exact-active toc-link level3">GormValuerInterface</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#子句表达式" class="router-link-active router-link-exact-active toc-link level3">子句表达式</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#scope-1" class="router-link-active router-link-exact-active toc-link level2">Scope</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#查询-1" class="router-link-active router-link-exact-active toc-link level3">查询</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#分页" class="router-link-active router-link-exact-active toc-link level3">分页</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#动态表" class="router-link-active router-link-exact-active toc-link level3">动态表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#更新-1" class="router-link-active router-link-exact-active toc-link level3">更新</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库实例的上下文值传递" class="router-link-active router-link-exact-active toc-link level2">数据库实例的上下文值传递</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#set-get" class="router-link-active router-link-exact-active toc-link level3">Set / Get</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#instanceset-instanceget" class="router-link-active router-link-exact-active toc-link level3">InstanceSet / InstanceGet</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#数据库解析器" class="router-link-active router-link-exact-active toc-link level2">数据库解析器</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#用法" class="router-link-active router-link-exact-active toc-link level3">用法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#自动切换连接" class="router-link-active router-link-exact-active toc-link level3">自动切换连接</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#读写分离-1" class="router-link-active router-link-exact-active toc-link level3">读写分离</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#手动切换连接" class="router-link-active router-link-exact-active toc-link level3">手动切换连接</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#事务-1" class="router-link-active router-link-exact-active toc-link level3">事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#负载均衡" class="router-link-active router-link-exact-active toc-link level3">负载均衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gorm.html#连接池-2" class="router-link-active router-link-exact-active toc-link level3">连接池</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="gorm" tabindex="-1"><a class="header-anchor" href="#gorm" aria-hidden="true">#</a> Gorm</h1><p>官方文档：<a href="https://gorm.io/gen/index.html" target="_blank" rel="noopener noreferrer">Gen Guides | GORM - The fantastic ORM library for Golang, aims to be developer friendly.<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>官方仓库：<a href="https://github.com/go-gorm/gorm" target="_blank" rel="noopener noreferrer">go-gorm/gorm: The fantastic ORM library for Golang, aims to be developer friendly (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>一个为go语言构建的出色的ORM框架，旨在为开发者提供友好的开发环境。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>尽管GORM的官方文档已经非常完善了，但是依然有不少错误，笔者本人也是GORM中文文档的贡献者之一，此页面也仍在不断更新，后续有重写编写的计划。</p></div><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go get -u gorm.io/gen
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="快速入门" tabindex="-1"><a class="header-anchor" href="#快速入门" aria-hidden="true">#</a> 快速入门</h2><h3 id="模型" tabindex="-1"><a class="header-anchor" href="#模型" aria-hidden="true">#</a> 模型</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Product <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   gorm<span class="token punctuation">.</span>Model <span class="token comment">//组合</span>
   Code  <span class="token builtin">string</span>
   Price <span class="token builtin">uint</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="链接数据库" tabindex="-1"><a class="header-anchor" href="#链接数据库" aria-hidden="true">#</a> 链接数据库</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;root:wyh246859@tcp(127.0.0.1:3306)/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">//自动迁移模型 如果表不存在则创建表，结构变化则适配变化</span>
db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="增加记录" tabindex="-1"><a class="header-anchor" href="#增加记录" aria-hidden="true">#</a> 增加记录</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//增</span>
db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Product<span class="token punctuation">{</span>Code<span class="token punctuation">:</span> <span class="token string">&quot;D44&quot;</span><span class="token punctuation">,</span> Price<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询记录" tabindex="-1"><a class="header-anchor" href="#查询记录" aria-hidden="true">#</a> 查询记录</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> product Product
<span class="token comment">//查</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新记录" tabindex="-1"><a class="header-anchor" href="#更新记录" aria-hidden="true">#</a> 更新记录</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> product Product
<span class="token comment">//查</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">//改</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Price&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除记录" tabindex="-1"><a class="header-anchor" href="#删除记录" aria-hidden="true">#</a> 删除记录</h3><p>如果结构体包含<code>deleted_at</code>则进行逻辑删除</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码" aria-hidden="true">#</a> 完整代码</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;gorm.io/driver/mysql&quot;</span>
	<span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Product <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	gorm<span class="token punctuation">.</span>Model
	Code  <span class="token builtin">string</span>
	Price <span class="token builtin">uint</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;root:wyh246859@tcp(127.0.0.1:3306)/test?parseTime=True&amp;loc=Local&amp;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">//增</span>
	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Product<span class="token punctuation">{</span>Code<span class="token punctuation">:</span> <span class="token string">&quot;D44&quot;</span><span class="token punctuation">,</span> Price<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> product Product
	<span class="token comment">//查</span>
	db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">//改</span>
	db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Price&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
	<span class="token comment">//删</span>
	db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>product<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>例如</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   ID           <span class="token builtin">uint</span>
   Name         <span class="token builtin">string</span>
   Email        <span class="token operator">*</span><span class="token builtin">string</span>
   Age          <span class="token builtin">uint8</span>
   Birthday     <span class="token operator">*</span>time<span class="token punctuation">.</span>Time
   MemberNumber sql<span class="token punctuation">.</span>NullString
   ActivatedAt  sql<span class="token punctuation">.</span>NullTime
   CreatedAt    time<span class="token punctuation">.</span>Time
   UpdatedAt    time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="数据库连接" tabindex="-1"><a class="header-anchor" href="#数据库连接" aria-hidden="true">#</a> 数据库连接</h2><p>GORM官方支持的数据库有四种<code>MySQL</code>,<code>PostgresSQL</code>,<code>SQLite</code>,<code>SQL server</code>。</p><h3 id="mysql" tabindex="-1"><a class="header-anchor" href="#mysql" aria-hidden="true">#</a> MySQL</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;gorm.io/driver/mysql&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情</span>
  dsn <span class="token operator">:=</span> <span class="token string">&quot;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>对于<code>Mysql</code>而言，想要正确的解析<code>time.time</code>类型的话，你需要在连接参数上加上<code>parseTime=True</code>，想要完整的utf8编码，需要加上<code>charset=utf8mb4</code>。<a href="https://github.com/go-sql-driver/mysql#parameters" target="_blank" rel="noopener noreferrer">go-sql-driver/mysql: Go MySQL Driver is a MySQL driver for Go&#39;s (golang) database/sql package (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><p>MySQL 驱动程序提供了 <a href="https://github.com/go-gorm/mysql" target="_blank" rel="noopener noreferrer">一些高级配置<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 可以在初始化过程中使用，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DSN<span class="token punctuation">:</span> <span class="token string">&quot;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span><span class="token punctuation">,</span> <span class="token comment">// DSN = data source name</span>
  DefaultStringSize<span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token comment">// string 类型字段的默认长度</span>
  DisableDatetimePrecision<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持</span>
  DontSupportRenameIndex<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引</span>
  DontSupportRenameColumn<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列</span>
  SkipInitializeWithVersion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 根据当前 MySQL 版本自动配置</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="自定义驱动" tabindex="-1"><a class="header-anchor" href="#自定义驱动" aria-hidden="true">#</a> 自定义驱动</h4><p>GORM 允许通过 <code>DriverName</code> 选项自定义 MySQL 驱动，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token boolean">_</span> <span class="token string">&quot;example.com/my_mysql_driver&quot;</span>
  <span class="token string">&quot;gorm.io/driver/mysql&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DriverName<span class="token punctuation">:</span> <span class="token string">&quot;my_mysql_driver&quot;</span><span class="token punctuation">,</span>
  DSN<span class="token punctuation">:</span> <span class="token string">&quot;gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span><span class="token punctuation">,</span> <span class="token comment">// data source name, 详情参考：https://github.com/go-sql-driver/mysql#dsn-data-source-name</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="postgresql" tabindex="-1"><a class="header-anchor" href="#postgresql" aria-hidden="true">#</a> PostgreSQL</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;gorm.io/driver/postgres&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

dsn <span class="token operator">:=</span> <span class="token string">&quot;host=localhost user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai&quot;</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们使用 <a href="https://github.com/jackc/pgx" target="_blank" rel="noopener noreferrer">pgx<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 作为 postgres 的 database/sql 驱动，默认情况下，它会启用 prepared statement 缓存，你可以这样禁用它：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// https://github.com/go-gorm/postgres</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DSN<span class="token punctuation">:</span> <span class="token string">&quot;user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai&quot;</span><span class="token punctuation">,</span>
  PreferSimpleProtocol<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// disables implicit prepared statement usage</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="自定义驱动-1" tabindex="-1"><a class="header-anchor" href="#自定义驱动-1" aria-hidden="true">#</a> 自定义驱动</h4><p>GORM 允许通过 <code>DriverName</code> 选项自定义 PostgreSQL 驱动，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token boolean">_</span> <span class="token string">&quot;github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/dialers/postgres&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DriverName<span class="token punctuation">:</span> <span class="token string">&quot;cloudsqlpostgres&quot;</span><span class="token punctuation">,</span>
  DSN<span class="token punctuation">:</span> <span class="token string">&quot;host=project:region:instance user=postgres dbname=postgres password=password sslmode=disable&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="现有的数据库连接" tabindex="-1"><a class="header-anchor" href="#现有的数据库连接" aria-hidden="true">#</a> 现有的数据库连接</h4><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;database/sql&quot;</span>
  <span class="token string">&quot;gorm.io/driver/postgres&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;pgx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mydb_dsn&quot;</span><span class="token punctuation">)</span>
gormDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>postgres<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  Conn<span class="token punctuation">:</span> sqlDB<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sqlite" tabindex="-1"><a class="header-anchor" href="#sqlite" aria-hidden="true">#</a> SQLite</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;gorm.io/driver/sqlite&quot;</span> <span class="token comment">// 基于 GGO 的 Sqlite 驱动</span>
  <span class="token comment">// &quot;github.com/glebarez/sqlite&quot; // 纯 Go 实现的 SQLite 驱动, 详情参考： https://github.com/glebarez/sqlite</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// github.com/mattn/go-sqlite3</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sql-server" tabindex="-1"><a class="header-anchor" href="#sql-server" aria-hidden="true">#</a> SQL Server</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;gorm.io/driver/sqlserver&quot;</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// github.com/denisenkom/go-mssqldb</span>
dsn <span class="token operator">:=</span> <span class="token string">&quot;sqlserver://gorm:LoremIpsum86@localhost:9930?database=gorm&quot;</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlserver<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="连接池" tabindex="-1"><a class="header-anchor" href="#连接池" aria-hidden="true">#</a> 连接池</h3><p>GORM 使用 <a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener noreferrer">database/sql<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 维护连接池</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxIdleConns 设置空闲连接池中连接的最大数量</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxOpenConns 设置打开数据库连接的最大数量。</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// SetConnMaxLifetime 设置了连接可复用的最大时间。</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="约定俗成" tabindex="-1"><a class="header-anchor" href="#约定俗成" aria-hidden="true">#</a> 约定俗成</h2><p>gorm相比于配置文件，会更优先采用约定俗成，如果开发者遵循这些约定俗成来进行开发，只需要写很少的代码。当然gorm也会允许修改这些配置。</p><h3 id="id-作为主键" tabindex="-1"><a class="header-anchor" href="#id-作为主键" aria-hidden="true">#</a> <code>ID</code> 作为主键</h3><p>GORM uses the field with the name <code>ID</code> as the table’s primary key by default.</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">string</span> <span class="token comment">// 字段ID将会被作为默认主键</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以使用使用结构体标签 <code>primaryKey</code>来修改主键</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Animal <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     <span class="token builtin">int64</span>
  UUID   <span class="token builtin">string</span> <span class="token string">`gorm:&quot;primaryKey&quot;`</span> <span class="token comment">//UUID被设置为主键</span>
  Name   <span class="token builtin">string</span>
  Age    <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="复数表名" tabindex="-1"><a class="header-anchor" href="#复数表名" aria-hidden="true">#</a> 复数表名</h3><p>GORM使用结构体名的蛇形命名作为标明，例如结构体<code>User</code>，其表名为<code>users</code>。</p><h3 id="tablename" tabindex="-1"><a class="header-anchor" href="#tablename" aria-hidden="true">#</a> TableName</h3><p>开发者可以实现<code>Tabler</code>接口来更改默认表名（不支持动态表名）例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>  <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token string">&quot;profiles&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="动态表名" tabindex="-1"><a class="header-anchor" href="#动态表名" aria-hidden="true">#</a> 动态表名</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">UserTable</span><span class="token punctuation">(</span>user User<span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>Admin <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;admin_users&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">UserTable</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="临时表名" tabindex="-1"><a class="header-anchor" href="#临时表名" aria-hidden="true">#</a> 临时表名</h3><p>使用<code>Table</code>方法指定临时表名：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;test_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="列名" tabindex="-1"><a class="header-anchor" href="#列名" aria-hidden="true">#</a> 列名</h3><p>根据约定，数据表的列名使用的是 struct 字段名的 <code>蛇形命名</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type User struct {
  ID        uint      // 列名是 `id`
  Name      string    // 列名是 `name`
  Birthday  time.Time // 列名是 `birthday`
  CreatedAt time.Time // 列名是 `created_at`
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以使用 <code>column</code> 标签或 <a href="https://gorm.io/zh_CN/docs/conventions.html#naming_strategy" target="_blank" rel="noopener noreferrer"><code>命名策略</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来覆盖列名</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type Animal struct {
  AnimalID int64     `gorm:&quot;column:beast_id&quot;`         // 将列名设为 `beast_id`
  Birthday time.Time `gorm:&quot;column:day_of_the_beast&quot;` // 将列名设为 `day_of_the_beast`
  Age      int64     `gorm:&quot;column:age_of_the_beast&quot;` // 将列名设为 `age_of_the_beast`
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="时间戳追踪" tabindex="-1"><a class="header-anchor" href="#时间戳追踪" aria-hidden="true">#</a> 时间戳追踪</h3><h4 id="createat" tabindex="-1"><a class="header-anchor" href="#createat" aria-hidden="true">#</a> <code>createAt</code></h4><p>对于拥有<code>createAt</code>字段的模型来说，创建记录时，如果为零值，则将值设为当前时间</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// 将 `CreatedAt` 设为当前时间</span>

user2 <span class="token operator">:=</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> CreatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span> <span class="token comment">// user2 的 `CreatedAt` 不会被修改</span>

<span class="token comment">// 想要修改该值，您可以使用 `Update`</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;CreatedAt&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以通过将 <code>autoCreateTime</code> 标签置为 <code>false</code> 来禁用时间戳追踪，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  CreatedAt time<span class="token punctuation">.</span>Time <span class="token string">`gorm:&quot;autoCreateTime:false&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="updatedat" tabindex="-1"><a class="header-anchor" href="#updatedat" aria-hidden="true">#</a> <code>UpdatedAt</code></h4><p>对于有 <code>UpdatedAt</code> 字段的模型，更新记录时，将该字段的值设为当前时间。创建记录时，如果该字段值为零值，则将该字段的值设为当前时间</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// 将 `UpdatedAt` 设为当前时间</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 会将 `UpdatedAt` 设为当前时间</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateColumn</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span> <span class="token comment">// `UpdatedAt` 不会被修改</span>

user2 <span class="token operator">:=</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> UpdatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span> <span class="token comment">// 创建记录时，user2 的 `UpdatedAt` 不会被修改</span>

user3 <span class="token operator">:=</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> UpdatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user3<span class="token punctuation">)</span> <span class="token comment">// 更新世，user3 的 `UpdatedAt` 会修改为当前时间</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以通过将 <code>autoUpdateTime</code> 标签置为 <code>false</code> 来禁用时间戳追踪，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  UpdatedAt time<span class="token punctuation">.</span>Time <span class="token string">`gorm:&quot;autoUpdateTime:false&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="模型-1" tabindex="-1"><a class="header-anchor" href="#模型-1" aria-hidden="true">#</a> 模型</h2><p>在MVC架构中，需要有一个<code>Model</code>来进行对数据库表的映射，<code>gorm</code>所支持的模型是一个结构体，其内部可以有基本数据类型，指针，或者</p><p><code>Scanner</code>和<code>Valuer</code>的自定义实现类型。</p><p>例如</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
    Age <span class="token builtin">int</span>
    Address <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gorm-model" tabindex="-1"><a class="header-anchor" href="#gorm-model" aria-hidden="true">#</a> <code>Gorm.Model</code></h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// gorm.Model 的定义</span>
<span class="token keyword">type</span> Model <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">uint</span>           <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  CreatedAt time<span class="token punctuation">.</span>Time
  UpdatedAt time<span class="token punctuation">.</span>Time
  DeletedAt gorm<span class="token punctuation">.</span>DeletedAt <span class="token string">`gorm:&quot;index&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">//使用匿名字段</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    gorm<span class="token punctuation">.</span>Model
    Name <span class="token builtin">string</span>
    Age <span class="token builtin">int</span>
<span class="token punctuation">}</span>
<span class="token comment">//或者`embaeded`标签</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Model gorm<span class="token punctuation">.</span>Model <span class="token string">`gorm:&quot;embedded&quot;`</span>
    Name <span class="token builtin">string</span>
    Age <span class="token builtin">int</span>
<span class="token punctuation">}</span>
<span class="token comment">//等价于</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ID        <span class="token builtin">uint</span>           <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
    CreatedAt time<span class="token punctuation">.</span>Time
    UpdatedAt time<span class="token punctuation">.</span>Time
    DeletedAt gorm<span class="token punctuation">.</span>DeletedAt <span class="token string">`gorm:&quot;index&quot;`</span>
    Name <span class="token builtin">string</span>
    Age <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是官方默认声明好了的结构体，可以将其嵌入你的结构体当中以节省代码，当然你也可以嵌入自定义结构体。</p><h3 id="字段级权限控制" tabindex="-1"><a class="header-anchor" href="#字段级权限控制" aria-hidden="true">#</a> 字段级权限控制</h3><p>gorm允许使用结构体标签来进行字段级别的权限控制。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>使用 GORM Migrator 创建表时，不会创建被忽略的字段</p></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;&lt;-:create&quot;`</span> <span class="token comment">// 允许读和创建</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;&lt;-:update&quot;`</span> <span class="token comment">// 允许读和更新</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;&lt;-&quot;`</span>        <span class="token comment">// 允许读和写（创建和更新）</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;&lt;-:false&quot;`</span>  <span class="token comment">// 允许读，禁止写</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-&gt;&quot;`</span>        <span class="token comment">// 只读（除非有自定义配置，否则禁止写）</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-&gt;;&lt;-:create&quot;`</span> <span class="token comment">// 允许读和写</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-&gt;:false;&lt;-:create&quot;`</span> <span class="token comment">// 仅创建（禁止从 db 读）</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-&quot;`</span>  <span class="token comment">// 通过 struct 读写会忽略该字段</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-:all&quot;`</span>        <span class="token comment">// 通过 struct 读写、迁移会忽略该字段</span>
   Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-:migration&quot;`</span>  <span class="token comment">// 通过 struct 迁移会忽略该字段</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建-更新时间追踪" tabindex="-1"><a class="header-anchor" href="#创建-更新时间追踪" aria-hidden="true">#</a> 创建/更新时间追踪</h3><p>GORM 约定使用 <code>CreatedAt</code>、<code>UpdatedAt</code> 追踪创建/更新时间。如果您定义了这种字段，GORM 在创建、更新时会自动填充 <a href="https://gorm.io/zh_CN/docs/gorm_config.html#now_func" target="_blank" rel="noopener noreferrer">当前时间<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>要使用不同名称的字段，您可以配置 <code>autoCreateTime</code>、<code>autoUpdateTime</code> 标签</p><p>如果您想要保存 UNIX（毫/纳）秒时间戳，而不是 time，您只需简单地将 <code>time.Time</code> 修改为 <code>int</code> 即可</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  CreatedAt time<span class="token punctuation">.</span>Time <span class="token comment">// 在创建时，如果该字段值为零值，则使用当前时间填充</span>
  UpdatedAt <span class="token builtin">int</span>       <span class="token comment">// 在创建时该字段值为零值或者在更新时，使用当前时间戳秒数填充</span>
  Updated   <span class="token builtin">int64</span> <span class="token string">`gorm:&quot;autoUpdateTime:nano&quot;`</span> <span class="token comment">// 使用时间戳填纳秒数充更新时间</span>
  Updated   <span class="token builtin">int64</span> <span class="token string">`gorm:&quot;autoUpdateTime:milli&quot;`</span> <span class="token comment">// 使用时间戳毫秒数填充更新时间</span>
  Created   <span class="token builtin">int64</span> <span class="token string">`gorm:&quot;autoCreateTime&quot;`</span>      <span class="token comment">// 使用时间戳秒数填充创建时间</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字段标签" tabindex="-1"><a class="header-anchor" href="#字段标签" aria-hidden="true">#</a> 字段标签</h3><p>声明 model 时，tag 是可选的，GORM 支持以下 tag： tag 名大小写不敏感，但建议使用 <code>camelCase</code> 风格</p><table><thead><tr><th style="text-align:left;">标签名</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><code>column</code></td><td style="text-align:left;">指定 db 列名</td></tr><tr><td style="text-align:left;"><code>type</code></td><td style="text-align:left;">列数据类型，推荐使用兼容性好的通用类型，例如：所有数据库都支持 bool、int、uint、float、string、time、bytes 并且可以和其他标签一起使用，例如：<code>not null</code>、<code>size</code>, <code>autoIncrement</code>… 像 <code>varbinary(8)</code> 这样指定数据库数据类型也是支持的。在使用指定数据库数据类型时，它需要是完整的数据库数据类型，如：<code>MEDIUMINT UNSIGNED not NULL AUTO_INCREMENT</code></td></tr><tr><td style="text-align:left;"><code>serializer</code></td><td style="text-align:left;">指定将数据序列化或反序列化到数据库中的序列化器, 例如: <code>serializer:json/gob/unixtime</code></td></tr><tr><td style="text-align:left;"><code>size</code></td><td style="text-align:left;">定义列数据类型的大小或长度，例如 <code>size: 256</code></td></tr><tr><td style="text-align:left;"><code>primaryKey</code></td><td style="text-align:left;">将列定义为主键</td></tr><tr><td style="text-align:left;"><code>unique</code></td><td style="text-align:left;">将列定义为唯一键</td></tr><tr><td style="text-align:left;"><code>default</code></td><td style="text-align:left;">定义列的默认值</td></tr><tr><td style="text-align:left;"><code>precision</code></td><td style="text-align:left;">指定列的精度</td></tr><tr><td style="text-align:left;"><code>scale</code></td><td style="text-align:left;">指定列大小</td></tr><tr><td style="text-align:left;"><code>not null</code></td><td style="text-align:left;">指定列为 NOT NULL</td></tr><tr><td style="text-align:left;"><code>autoIncrement</code></td><td style="text-align:left;">指定列为自动增长</td></tr><tr><td style="text-align:left;"><code>autoIncrementIncrement</code></td><td style="text-align:left;">自动步长，控制连续记录之间的间隔</td></tr><tr><td style="text-align:left;"><code>embedded</code></td><td style="text-align:left;">嵌套字段</td></tr><tr><td style="text-align:left;"><code>embeddedPrefix</code></td><td style="text-align:left;">嵌入字段的列名前缀</td></tr><tr><td style="text-align:left;"><code>autoCreateTime</code></td><td style="text-align:left;">创建时追踪当前时间，对于 <code>int</code> 字段，它会追踪时间戳秒数，您可以使用 <code>nano</code>/<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoCreateTime:nano</code></td></tr><tr><td style="text-align:left;"><code>autoUpdateTime</code></td><td style="text-align:left;">创建/更新时追踪当前时间，对于 <code>int</code> 字段，它会追踪时间戳秒数，您可以使用 <code>nano</code>/<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoUpdateTime:milli</code></td></tr><tr><td style="text-align:left;"><code>index</code></td><td style="text-align:left;">根据参数创建索引，多个字段使用相同的名称则创建复合索引，查看 <a href="https://gorm.io/zh_CN/docs/indexes.html" target="_blank" rel="noopener noreferrer">索引<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 获取详情</td></tr><tr><td style="text-align:left;"><code>uniqueIndex</code></td><td style="text-align:left;">与 <code>index</code> 相同，但创建的是唯一索引</td></tr><tr><td style="text-align:left;"><code>check</code></td><td style="text-align:left;">创建检查约束，例如 <code>check:age &gt; 13</code>，查看 <a href="https://gorm.io/zh_CN/docs/constraints.html" target="_blank" rel="noopener noreferrer">约束<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 获取详情</td></tr><tr><td style="text-align:left;"><code>&lt;-</code></td><td style="text-align:left;">设置字段写入的权限， <code>&lt;-:create</code> 只创建、<code>&lt;-:update</code> 只更新、<code>&lt;-:false</code> 无写入权限、<code>&lt;-</code> 创建和更新权限</td></tr><tr><td style="text-align:left;"><code>-&gt;</code></td><td style="text-align:left;">设置字段读的权限，<code>-&gt;:false</code> 无读权限</td></tr><tr><td style="text-align:left;"><code>-</code></td><td style="text-align:left;">忽略该字段，<code>-</code> 表示无读写，<code>-:migration</code> 表示无迁移权限，<code>-:all</code> 表示无读写迁移权限</td></tr><tr><td style="text-align:left;"><code>comment</code></td><td style="text-align:left;">迁移时为字段添加注释</td></tr></tbody></table><h2 id="查询" tabindex="-1"><a class="header-anchor" href="#查询" aria-hidden="true">#</a> 查询</h2><h3 id="检索单个对象" tabindex="-1"><a class="header-anchor" href="#检索单个对象" aria-hidden="true">#</a> 检索单个对象</h3><p>GORM 提供了 <code>First</code>、<code>Take</code>、<code>Last</code> 方法，以便从数据库中检索单个对象。当查询数据库时它添加了 <code>LIMIT 1</code> 条件，且没有找到记录时，它会返回 <code>ErrRecordNotFound</code> 错误。</p><p><code>First</code>，根据主键升序查询第一条记录，等价于<code>SELECT * FROM users ORDER BY id LIMIT 1;</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>Take</code>，获取第一条记录，等价于<code>SELECT * FROM users LIMIT 1;</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>Last</code>，根据主键降序获取第一条记录，等价于<code>SELECT * FROM users ORDER BY id DESC LIMIT 1;</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Last</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>检查返回结果</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Last</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>RowsAffected<span class="token punctuation">)</span> <span class="token comment">//影响的记录行数</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Error<span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//判断是否错误为gorm.ErrRecordNotFound</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果你想避免<code>ErrRecordNotFound</code>错误，你可以使用<code>Find</code>，比如<code>db.Limit(1).Find(&amp;user)</code>，<code>Find</code>方法可以接受struct和slice的数据。</p></blockquote><p><code>First</code> 和 <code>Last</code> 会根据主键排序，分别查询第一条和最后一条记录，如果model没有定义主键，即不是结构体也不是结构体指针，那么将按model的第一个字段排序。</p><h3 id="主键检索" tabindex="-1"><a class="header-anchor" href="#主键检索" aria-hidden="true">#</a> 主键检索</h3><p>如果主键是数字类型，可以使用内联条件来检索对象，若传入字符串参数，需要特别注意SQL注入问题。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// SELECT * FROM users WHERE id = 10;</span>

db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span> <span class="token comment">// SELECT * FROM users WHERE id = 10;</span>

db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// SELECT * FROM users WHERE id IN (1,2,3);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果主键是字符串，例如UUID，则应该这样写</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1b74413f-f3b8-409f-ac47-e8c062e3472a&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = &quot;1b74413f-f3b8-409f-ac47-e8c062e3472a&quot;;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>当目标对象主键值不为空时，将使用主键值进行检索</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> user <span class="token operator">=</span> User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = 10;</span>

<span class="token keyword">var</span> result User
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = 10;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检索全部对象" tabindex="-1"><a class="header-anchor" href="#检索全部对象" aria-hidden="true">#</a> 检索全部对象</h3><p>传入一个<code>[]User</code>类型的切片，会将所有查询到的结果装入这个切片中</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="字符串条件" tabindex="-1"><a class="header-anchor" href="#字符串条件" aria-hidden="true">#</a> 字符串条件</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">//获取第一个匹配的记录</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//读取所有不等于条件的记录</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name &lt;&gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//获取在该范围内的记录</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name IN ?&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;jack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//模糊查询</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name LIKE ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//AND条件查询</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ? AND age &gt;= ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//Between</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age BETWEEN ? AND ?&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果对象的主键值不为空，在查询时不会将其覆盖，而是将其作为<code>AND</code>条件查询，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token comment">//等价于 SELECT * FROM users WHERE id = 20 AND id = 100 ORDER BY id ASC LIMIT 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据结构条件" tabindex="-1"><a class="header-anchor" href="#数据结构条件" aria-hidden="true">#</a> 数据结构条件</h3><p>当<code>Where</code>方法的<code>query</code>参数可以为<code>struct</code>,<code>map</code>,<code>slice</code>时，gorm会根据不同的类型做出不同的处理。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//struct</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//struct 指定结构体字段查询</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// 等价于 SELECT * FROM users WHERE name = &quot;jack&quot; AND age = 0;</span>

<span class="token comment">//map</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//主键切片</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>当使用结构体进行查询时，gorm只会使用非零值的字段进行查询，当字段值为<code>0</code>，<code>&#39;&#39;</code>，<code>false</code>，<code>nil</code>将不会用做查询条件，如果一定要用零值，可以换成map。</p></div><h3 id="内联条件" tabindex="-1"><a class="header-anchor" href="#内联条件" aria-hidden="true">#</a> 内联条件</h3><p>条件查询以<code>Where()</code>方法的方式内联到<code>First</code>,<code>Last</code>,<code>Find</code>方法中，直接说可能会不懂，看下面的例子。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 通过主键查询获取对象</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string_primary_key&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = &#39;string_primary_key&#39;;</span>

<span class="token comment">// 普通字段查询</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;</span>

db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token string">&quot;name &lt;&gt; ? AND age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &gt; 20;</span>

<span class="token comment">// Struct</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE age = 20;</span>

<span class="token comment">// Map</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE age = 20;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="not条件" tabindex="-1"><a class="header-anchor" href="#not条件" aria-hidden="true">#</a> Not条件</h3><p>构建Not条件，用法跟<code>Where()</code>类似</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE NOT name = &quot;jinzhu&quot; ORDER BY id LIMIT 1;</span>

<span class="token comment">// Not In</span>
db<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu 2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name NOT IN (&quot;jinzhu&quot;, &quot;jinzhu 2&quot;);</span>

<span class="token comment">// Struct</span>
db<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &lt;&gt; 18 ORDER BY id LIMIT 1;</span>

<span class="token comment">// 不在主键切片中</span>
db<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id NOT IN (1,2,3) ORDER BY id LIMIT 1;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="or条件" tabindex="-1"><a class="header-anchor" href="#or条件" aria-hidden="true">#</a> Or条件</h3><p>构造Or条件，用法跟<code>Where()</code>类似</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;super_admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE role = &#39;admin&#39; OR role = &#39;super_admin&#39;;</span>

<span class="token comment">// Struct</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = &#39;jinzhu&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu 2&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu&#39; OR (name = &#39;jinzhu 2&#39; AND age = 18);</span>

<span class="token comment">// Map</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = &#39;jinzhu&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu 2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu&#39; OR (name = &#39;jinzhu 2&#39; AND age = 18);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="排序" tabindex="-1"><a class="header-anchor" href="#排序" aria-hidden="true">#</a> 排序</h3><p>从数据库检索记录时指定顺序</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;age desc, name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users ORDER BY age desc, name;</span>

db<span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;age desc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users ORDER BY age desc, name;</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OrderBy<span class="token punctuation">{</span>
  Expression<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>Expr<span class="token punctuation">{</span>SQL<span class="token punctuation">:</span> <span class="token string">&quot;FIELD(id,?)&quot;</span><span class="token punctuation">,</span> Vars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> WithoutParentheses<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users ORDER BY FIELD(id,1,2,3)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="limi-offset" tabindex="-1"><a class="header-anchor" href="#limi-offset" aria-hidden="true">#</a> Limi&amp;Offset</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users LIMIT 3;</span>

<span class="token comment">// 用-1来取消Limit条件</span>
db<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users2<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users LIMIT 10; (users1)</span>
<span class="token comment">// SELECT * FROM users; (users2)</span>

db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users OFFSET 3;</span>

db<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users OFFSET 5 LIMIT 10;</span>

<span class="token comment">// </span>
db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users2<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users OFFSET 10; (users1)</span>
<span class="token comment">// SELECT * FROM users; (users2)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="distinct" tabindex="-1"><a class="header-anchor" href="#distinct" aria-hidden="true">#</a> Distinct</h3><p>将查询的结果去重。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;name, age desc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>results<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="group-having" tabindex="-1"><a class="header-anchor" href="#group-having" aria-hidden="true">#</a> Group&amp;Having</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name, sum(age) as total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name LIKE ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;group%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
<span class="token comment">// SELECT name, sum(age) as total FROM `users` WHERE name LIKE &quot;group%&quot; GROUP BY `name` LIMIT 1</span>


db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name, sum(age) as total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Having</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
<span class="token comment">// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = &quot;group&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="join" tabindex="-1"><a class="header-anchor" href="#join" aria-hidden="true">#</a> Join</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;users.name, emails.email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;left join emails on emails.user_id = users.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id</span>

<span class="token comment">// 多个join</span>
db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;JOIN emails ON emails.user_id = users.id AND emails.email = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu@example.org&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;JOIN credit_cards ON credit_cards.user_id = users.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;credit_cards.number = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;411111111111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>预加载</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">/*
SELECT 
	`users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` 
FROM `users` 
LEFT JOIN 
	`companies` AS `Company` 
ON 
	`users`.`company_id` = `Company`.`id`;
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Company&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Company<span class="token punctuation">{</span>Alive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">/*
SELECT 
	`users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` 
FROM `users` 
LEFT JOIN 
	`companies` AS `Company` 
ON 
	`users`.`company_id` = `Company`.`id` 
AND 
	`Company`.`alive` = true;
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="scan" tabindex="-1"><a class="header-anchor" href="#scan" aria-hidden="true">#</a> Scan</h3><p>将结果扫描到结构体中，类似于<code>Find()</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name <span class="token builtin">string</span>
  Age  <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> result Result
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Antonio&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span>

<span class="token comment">// 原生sql</span>
db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name, age FROM users WHERE name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Antonio&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="高级查询" tabindex="-1"><a class="header-anchor" href="#高级查询" aria-hidden="true">#</a> 高级查询</h2><p>这一小节主要是涉及到一些GROM中常见的查询技巧</p><h3 id="自动选择字段" tabindex="-1"><a class="header-anchor" href="#自动选择字段" aria-hidden="true">#</a> 自动选择字段</h3><p>GORM允许通过<code>Select</code>方法来选择特定的字段，如果经常使用此功能，可以定义一个较小的结构体，以实现调用API时，自动选择特定的字段。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   ID           <span class="token builtin">uint</span>
   Name         <span class="token builtin">string</span>
   Email        <span class="token builtin">string</span>
   Age          <span class="token builtin">uint8</span>
   Birthday     time<span class="token punctuation">.</span>Time
   MemberNumber sql<span class="token punctuation">.</span>NullString
   ActivatedAt  sql<span class="token punctuation">.</span>NullTime
   CreatedAt    time<span class="token punctuation">.</span>Time
   UpdatedAt    time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token keyword">type</span> UserSimpleInfo <span class="token punctuation">{</span>
    ID <span class="token builtin">uint</span>
    Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">//使用select选择字段id和name</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//查询时会自动选择id和name字段</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UserSimpleInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>开启<code>QueryFields</code> 模式会根据当前 model 的所有字段名称进行 select。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  QueryFields<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 带上这个选项</span>

<span class="token comment">// Session Mode</span>
db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>QueryFields<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users`</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="锁" tabindex="-1"><a class="header-anchor" href="#锁" aria-hidden="true">#</a> 锁</h3><p>GORM支持多种类型的锁</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Locking<span class="token punctuation">{</span>Strength<span class="token punctuation">:</span> <span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FOR UPDATE</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Locking<span class="token punctuation">{</span>
  Strength<span class="token punctuation">:</span> <span class="token string">&quot;SHARE&quot;</span><span class="token punctuation">,</span>
  Table<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>Table<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>CurrentTable<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FOR SHARE OF `users`</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Locking<span class="token punctuation">{</span>
  Strength<span class="token punctuation">:</span> <span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">,</span>
  Options<span class="token punctuation">:</span> <span class="token string">&quot;NOWAIT&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FOR UPDATE NOWAIT</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="子查询" tabindex="-1"><a class="header-anchor" href="#子查询" aria-hidden="true">#</a> 子查询</h3><p>子查询可以嵌套在查询中，GORM允许在使用<code>*gorm.DB</code>对象作为参数时生成子查询。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//找出年龄大于平均年龄的用户</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; (?)&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;AVG(age)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">//SELECT　* FROM `users` WHERE age &gt; (SELECT AVG(age) FROM `users`)</span>

subQuery <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;AVG(age)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name LIKE ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;AVG(age) as avgage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Having</span><span class="token punctuation">(</span><span class="token string">&quot;AVG(age) &gt; (?)&quot;</span><span class="token punctuation">,</span> subQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>results<span class="token punctuation">)</span>
<span class="token comment">// SELECT AVG(age) as avgage FROM `users` GROUP BY `name` HAVING AVG(age) &gt; (SELECT AVG(age) FROM `users` WHERE name LIKE &quot;name%&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样的，也可以使用<code>Table()</code>方法来使用<code>FROM子查询</code>，就如下方的例子:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;(?) as u&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE `age` = 18</span>

subQuery1 <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
subQuery2 <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Pet<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;(?) as u, (?) as p&quot;</span><span class="token punctuation">,</span> subQuery1<span class="token punctuation">,</span> subQuery2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM (SELECT `name` FROM `users`) as u, (SELECT `name` FROM `pets`) as p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="条件组" tabindex="-1"><a class="header-anchor" href="#条件组" aria-hidden="true">#</a> 条件组</h3><p>使用条件组可以很轻松的编写复杂的条件SQL</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>
    db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pizza = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pepperoni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;size = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;small&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token string">&quot;size = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;medium&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span>
    db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pizza = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hawaiian&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;size = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xlarge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Pizza<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement

<span class="token comment">// SELECT * FROM `pizzas` WHERE (pizza = &quot;pepperoni&quot; AND (size = &quot;small&quot; OR size = &quot;medium&quot;)) OR (pizza = &quot;hawaiian&quot; AND size = &quot;xlarge&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多列in" tabindex="-1"><a class="header-anchor" href="#多列in" aria-hidden="true">#</a> 多列IN</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;(name, age, role) IN ?&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE (name, age, role) IN ((&quot;jinzhu&quot;, 18, &quot;admin&quot;), (&quot;jinzhu 2&quot;, 19, &quot;user&quot;));</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="命名参数" tabindex="-1"><a class="header-anchor" href="#命名参数" aria-hidden="true">#</a> 命名参数</h3><p>GORM一般使用是都是使用匿名参数，不过也支持命名参数，支持<code>sql.NamedArg</code>和<code>map[string]interface{}</code>和<code>struct</code>形式的命名参数。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//匿名参数</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ? AND age &lt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//命名参数</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; @min AND age &lt; @max&quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;min&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;max&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">//命名参数</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; @min AND age &lt; @max&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;min&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;max&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="map扫描" tabindex="-1"><a class="header-anchor" href="#map扫描" aria-hidden="true">#</a> Map扫描</h3><p>GORM允许将扫描结果写入<code>map[string]interface{}</code>或者<code>[]map[string]interface{}</code>，不过必须得指定<code>Model</code>或者<code>Tabel</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>result <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span> <span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> results <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>results<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="firstorinit" tabindex="-1"><a class="header-anchor" href="#firstorinit" aria-hidden="true">#</a> FirstOrInit</h3><p>查找第一条匹配的记录，如果没有找到的话，则根据已给定的条件初始化示例，支持<code>struct</code>和<code>map[string]interface{}</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// SELECT * FROM `users` WHERE `users`.`name` = &#39;mike&#39; ORDER BY`users`.`id` LIMIT 1</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//没有找到，则将条件赋值给user user -&gt; User{Name:&quot;mike&quot;}</span>

<span class="token comment">// SELECT * FROM `users` WHERE `users`.`name` = &#39;jack&#39; ORDER BY`users`.`id` LIMIT 1</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//找到了，则将结果扫描至user</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，也可以使用<code>Attrs()</code>方法来初始化user，<strong>并且其中的条件不会被用于查询，也不会保存至数据库</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//SELECT * FROM `users` WHERE `users`.`id` = 1 ORDER BY `users`.`id` LIMIT 1</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//没找到，user-&gt;User{ID:1,Name:&quot;mike&quot;}</span>

<span class="token comment">//使用map</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Assign()</code>方法，不管是否找到对应的记录，都会将值赋给<code>struct</code>，但这些值不会被用于查询，也不会保存至数据库。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//SELECT * FROM `users` WHERE `users`.`id` = 1 ORDER BY `users`.`id` LIMIT 1</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="firstorcreate" tabindex="-1"><a class="header-anchor" href="#firstorcreate" aria-hidden="true">#</a> FirstOrCreate</h3><p>查找第一条匹配的记录，如果没有找到的话，则创建一条新记录。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
		ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//SELECT * FROM `users` WHERE `users`.`name` = &#39;mike&#39; AND `users`.`id` = 1 ORDER BY `users`.`id` LIMIT 1</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//找到了，将结果扫描至user</span>

user <span class="token operator">=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
		ID<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//SELECT * FROM `users` WHERE `users`.`name` = &#39;jack&#39; AND `users`.`id` = 8 ORDER BY `users`.`id` LIMIT 1</span>
<span class="token comment">/*INSERT INTO `users` 
	(`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`,`id`) 
VALUES 
	(&#39;jack&#39;,&#39;&#39;,0,&#39;0000-00-00 00:00:00&#39;,NULL,NULL,&#39;2022-11-29 14:49:38.915&#39;,&#39;2022-11-29 14:49:38.915&#39;,8)
*/</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//没找到，根据条件创建一个新记录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样的，<code>Attrs()</code>中的值不会被用于查询SQL，但是在创建时会被写入数据库。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   ID<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//SELECT * FROM `users` WHERE `users`.`name` = &#39;jack&#39; AND `users`.`id` = 8 ORDER BY `users`.`id` LIMIT 1</span>
<span class="token comment">/*INSERT INTO `users` 
	(`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`,`id`) 
VALUES 
	(&#39;jack&#39;,&#39;&#39;,0,&#39;0000-00-00 00:00:00&#39;,NULL,NULL,&#39;2022-11-29 14:49:38.915&#39;,&#39;2022-11-29 14:49:38.915&#39;,8)
*/</span>
db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//没找到，根据条件创建一个新记录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Assign()</code>中的值，不管找没找到，都会将值赋给<code>struct</code>，并且将结果写入数据库</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   ID<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Assign</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">//没找到的情况下执行INSERT</span>
<span class="token comment">//SELECT * FROM `users` WHERE `users`.`name` = &#39;jack&#39; AND `users`.`id` = 8 ORDER BY `users`.`id` LIMIT 1</span>
<span class="token comment">/*INSERT INTO `users` 
	(`name`,`email`,`age`,`birthday`,`member_number`,`activated_at`,`created_at`,`updated_at`,`id`) 
VALUES 
	(&#39;jack&#39;,&#39;&#39;,0,&#39;0000-00-00 00:00:00&#39;,NULL,NULL,&#39;2022-11-29 14:49:38.915&#39;,&#39;2022-11-29 14:49:38.915&#39;,8)
*/</span>

<span class="token comment">//找到的情况下执行UPDATE</span>
<span class="token comment">//UPDATE `users` SET `name`=&#39;jack&#39;,`updated_at`=&#39;2022-11-29 14:56:18.829&#39; WHERE `id` = 8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="优化器-索引提示" tabindex="-1"><a class="header-anchor" href="#优化器-索引提示" aria-hidden="true">#</a> 优化器/索引提示</h3><p>该功能主要由<code>gorm.io/hints</code>提供，优化器提示允许去控制查询优化器去选择某一个查询执行计划。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/hints&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;MAX_EXECUTION_TIME(10000)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * /*+ MAX_EXECUTION_TIME(10000) */ FROM `users`</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>索引提示则允许将索引提示传递给数据库以防查询程序混淆。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/hints&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">UseIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">ForceIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="迭代" tabindex="-1"><a class="header-anchor" href="#迭代" aria-hidden="true">#</a> 迭代</h3><p>GORM支持通过行进行行迭代</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> user User
   db<span class="token punctuation">.</span><span class="token function">ScanRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="findinbatches" tabindex="-1"><a class="header-anchor" href="#findinbatches" aria-hidden="true">#</a> FindInBatches</h3><p>用于批量查询并处理记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">//每批次处理100条记录</span>
result <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;id &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FindInBatches</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> batch <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>

   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users <span class="token punctuation">{</span>
      <span class="token comment">//处理找到的记录</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//是第几批</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span>

   <span class="token comment">//返回error会中断后续的批处理操作</span>
   <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>RowsAffected<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="钩子方法" tabindex="-1"><a class="header-anchor" href="#钩子方法" aria-hidden="true">#</a> 钩子方法</h3><p>对于查询操作，GORM 支持 <code>AfterFind</code> 钩子，查询记录后会调用</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterFind</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>Role <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
    u<span class="token punctuation">.</span>Role <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pluck" tabindex="-1"><a class="header-anchor" href="#pluck" aria-hidden="true">#</a> Pluck</h3><p>Pluck 用于从数据库查询单个列，并将结果扫描到切片。如果您想要查询多列，您应该使用 <code>Select</code> 和 [<code>Scan</code>]</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ages <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pluck</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ages<span class="token punctuation">)</span>

<span class="token keyword">var</span> names <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pluck</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>names<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pluck</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>names<span class="token punctuation">)</span>

<span class="token comment">// Distinct Pluck</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pluck</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>names<span class="token punctuation">)</span>
<span class="token comment">// SELECT DISTINCT `name` FROM `users`</span>

<span class="token comment">// 超过一列的查询，应该使用 `Scan` 或者 `Find`，例如：</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="scope" tabindex="-1"><a class="header-anchor" href="#scope" aria-hidden="true">#</a> Scope</h3><p><code>Scopes</code> 允许你指定常用的查询，可以在调用方法时引用这些查询</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AmountGreaterThan1000</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;amount &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCreditCard</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode_sign = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCod</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode_sign = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span>status <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;status IN (?)&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCreditCard<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于 1000 的信用卡订单</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于 1000 的货到付款订单</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;paid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shipped&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于 1000 且已付款或已发货的订单</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="count" tabindex="-1"><a class="header-anchor" href="#count" aria-hidden="true">#</a> Count</h3><p>Count 用于获取匹配的记录数</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> count <span class="token builtin">int64</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
<span class="token comment">// SELECT count(1) FROM users WHERE name = &#39;jinzhu&#39; OR name = &#39;jinzhu 2&#39;</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
<span class="token comment">// SELECT count(1) FROM users WHERE name = &#39;jinzhu&#39;; (count)</span>

db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
<span class="token comment">// SELECT count(1) FROM deleted_users;</span>

<span class="token comment">// 去重并计数</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
<span class="token comment">// SELECT COUNT(DISTINCT(`name`)) FROM `users`</span>

db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;count(distinct(name))&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
<span class="token comment">// SELECT count(distinct(name)) FROM deleted_users</span>

<span class="token comment">// 分组计数</span>
users <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span>
  <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
count <span class="token comment">// =&gt; 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="创建" tabindex="-1"><a class="header-anchor" href="#创建" aria-hidden="true">#</a> 创建</h2><p>在gorm中，创建记录主要用到<code>Create()</code>方法，下面是一个简单的示例。</p><p><strong>例子</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
    Name<span class="token punctuation">:</span>     <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>
    Email<span class="token punctuation">:</span>    <span class="token string">&quot;78645@163.com&quot;</span><span class="token punctuation">,</span>
    Age<span class="token punctuation">:</span>      <span class="token number">23</span><span class="token punctuation">,</span>
    Birthday<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>RowsAffected<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="指定字段" tabindex="-1"><a class="header-anchor" href="#指定字段" aria-hidden="true">#</a> 指定字段</h3><p>默认情况下，传入的结构体不为零值的字段所对应的表字段在创建记录时会赋予对应的值。倘若想要指定在创建记录时给哪些字段赋值，可以按照下面的例子来进行操作。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   Name<span class="token punctuation">:</span>     <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>
   Email<span class="token punctuation">:</span>    <span class="token string">&quot;78645@163.com&quot;</span><span class="token punctuation">,</span>
   Age<span class="token punctuation">:</span>      <span class="token number">23</span><span class="token punctuation">,</span>
   Birthday<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//指定字段</span>
res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CreatedAt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` (`name`,`age`,`created_at`) VALUES (&quot;john&quot;, 23, &quot;now&quot;)</span>


fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>RowsAffected<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然也可以反向选择</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   Name<span class="token punctuation">:</span>     <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>
   Email<span class="token punctuation">:</span>    <span class="token string">&quot;78645@163.com&quot;</span><span class="token punctuation">,</span>
   Age<span class="token punctuation">:</span>      <span class="token number">23</span><span class="token punctuation">,</span>
   Birthday<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//反向选择字段</span>
res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CreatedAt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` (`birthday`,`updated_at`) VALUES (&quot;now&quot;, &quot;now&quot;)</span>


fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>RowsAffected<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字段默认值" tabindex="-1"><a class="header-anchor" href="#字段默认值" aria-hidden="true">#</a> 字段默认值</h3><p>可以通过结构体标签的形式为字段定义默认值，<code>gorm:&quot;default:val&quot;</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int64</span>
  Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;default:galeone&quot;`</span>
  Age  <span class="token builtin">int64</span>  <span class="token string">`gorm:&quot;default:18&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入记录到数据库时，<strong>默认值会被用于填充值为零值的字段</strong>。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意</strong> 对于声明了默认值的字段，像 <code>0</code>、<code>&#39;&#39;</code>、<code>false</code> 等零值是不会保存到数据库。您需要使用指针类型或 Scanner/Valuer 来避免这个问题，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name <span class="token builtin">string</span>
  Age  <span class="token operator">*</span><span class="token builtin">int</span>           <span class="token string">`gorm:&quot;default:18&quot;`</span> <span class="token comment">// 当该字段为0时，会正常保存到数据库。</span>
  Active sql<span class="token punctuation">.</span>NullBool <span class="token string">`gorm:&quot;default:true&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意</strong> 若要数据库有默认、虚拟/生成的值，你必须为字段设置 <code>default</code> 标签。若要在迁移时跳过默认值定义，你可以使用 <code>default:(-)</code>，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">string</span> <span class="token string">`gorm:&quot;default:uuid_generate_v3()&quot;`</span> <span class="token comment">// 数据库的内置函数</span>
  FirstName <span class="token builtin">string</span>
  LastName  <span class="token builtin">string</span>
  Age       <span class="token builtin">uint8</span>
  FullName  <span class="token builtin">string</span> <span class="token string">`gorm:&quot;-&gt;;type:GENERATED ALWAYS AS (concat(firstname,&#39; &#39;,lastname));default:(-);&quot;`</span> <span class="token comment">//migrate时将会跳过此字段。</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="批量创建" tabindex="-1"><a class="header-anchor" href="#批量创建" aria-hidden="true">#</a> 批量创建</h3><p>如果想要插入大量的记录，可以将一个<code>slice</code>传递给<code>Create()</code>方法。GORM将生成一条SQL语句来插入所有数据，并填回主键的值，钩子方法也会被调用。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;devaid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jenny&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lily&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者可以实用<code>CreateInBatches()</code>方法，分批次插入数据，并且可以指定每一批次的数量。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;devaid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jenny&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lily&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;devaid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jenny&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lily&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;devaid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jenny&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lily&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;devaid&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jenny&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lily&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">//每一批次插入5条记录</span>
db<span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意</strong> 使用<code>CreateBatchSize</code> 选项初始化 GORM 时，所有的创建&amp; 关联 <code>INSERT</code> 都将遵循该选项</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  CreateBatchSize<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

db <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>CreateBatchSize<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> Pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Pet<span class="token punctuation">{</span>pet1<span class="token punctuation">,</span> pet2<span class="token punctuation">,</span> pet3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO users xxx (5 batches)</span>
<span class="token comment">// INSERT INTO pets xxx (15 batches)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="map创建" tabindex="-1"><a class="header-anchor" href="#map创建" aria-hidden="true">#</a> Map创建</h3><p><code>Create()</code>方法的参数可以是<code>map</code>，例如下方的例子。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>根据 map 创建记录时，association 不会被调用，且主键也不会自动填充</p></div><h3 id="钩子方法-1" tabindex="-1"><a class="header-anchor" href="#钩子方法-1" aria-hidden="true">#</a> 钩子方法</h3><p>GORM允许用户定义的钩子方法有<code>BeforeSave</code>, <code>BeforeCreate</code>, <code>AfterSave</code>, <code>AfterCreate</code>，创建记录时将调用这些钩子方法。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  u<span class="token punctuation">.</span>UUID <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> u<span class="token punctuation">.</span>Role <span class="token operator">==</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid role&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果想跳过钩子方法，可以实用<code>SkipHooks</code>会话模式。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关联创建" tabindex="-1"><a class="header-anchor" href="#关联创建" aria-hidden="true">#</a> 关联创建</h3><p>在创建关联数据时，如果关联值是非零值，这些关联会被<code>upsert</code>，并且它们的钩子方法也会被调用。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number   <span class="token builtin">string</span>
  UserID   <span class="token builtin">uint</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name       <span class="token builtin">string</span>
  CreditCard CreditCard
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  CreditCard<span class="token punctuation">:</span> CreditCard<span class="token punctuation">{</span>Number<span class="token punctuation">:</span> <span class="token string">&quot;411111111111&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` ...</span>
<span class="token comment">// INSERT INTO `credit_cards` ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过也可以跳过关联保存</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;CreditCard&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 跳过所有关联</span>
db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Associations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="upsert-及冲突" tabindex="-1"><a class="header-anchor" href="#upsert-及冲突" aria-hidden="true">#</a> Upsert 及冲突</h3><div class="hint-container tip"><p class="hint-container-title">提示</p><p>阅读以下的代码需要有<code>gorm/clause</code>的相关知识。</p></div><p>upsert是update和insert的合体，这里暂时不对其具体的语义进行探讨，简单对其做一个定义，基本功能为：<strong>存在时更新，不存在时插入</strong>，简单的解释就是，当某种条件成立时使用update，条件不成立时使用insert，一般情况下都是将唯一标识当作判别标准，GORM为不同的数据库提供了兼容的Upsert支持。</p><p><code>id</code>冲突时，什么都不做</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>DoNothing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li></li></ul><p><code>id</code>冲突时，将其更新为默认值，即在冲突时，将<code>role</code>字段修改为默认值<code>”user“</code>，忽略掉<code>model</code>中的字段值。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>
  Columns<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span>clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  DoUpdates<span class="token punctuation">:</span> clause<span class="token punctuation">.</span><span class="token function">Assignments</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">//等价于</span>
<span class="token comment">// MERGE INTO &quot;users&quot; USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET ***; SQL Server</span>
<span class="token comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE ***; MySQL</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>id</code>冲突时，将其更新为默认值，且使用SQL内置的函数或语句。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>
  Columns<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span>clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  DoUpdates<span class="token punctuation">:</span> clause<span class="token punctuation">.</span><span class="token function">Assignments</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">:</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;GREATEST(count, VALUES(count))&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `count`=GREATEST(count, VALUES(count));</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>id</code>冲突时。将指定列更新为新的值，即将<code>model</code>中指定字段的值更新至表中。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>
  Columns<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span>clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  DoUpdates<span class="token punctuation">:</span> clause<span class="token punctuation">.</span><span class="token function">AssignmentColumns</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `name`=VALUES(name),`age=VALUES(age);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>id</code>冲突时，将所有的列更新为新的值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>
  UpdateAll<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE ***;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="更新" tabindex="-1"><a class="header-anchor" href="#更新" aria-hidden="true">#</a> 更新</h2><h3 id="所有字段" tabindex="-1"><a class="header-anchor" href="#所有字段" aria-hidden="true">#</a> 所有字段</h3><p><code>Save()</code>方法会更新所有的字段，即使字段是零值。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

user<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;jinzhu 2&quot;</span>
user<span class="token punctuation">.</span>Age <span class="token operator">=</span> <span class="token number">100</span>
db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name=&#39;jinzhu 2&#39;, age=100, birthday=&#39;2016-01-01&#39;, updated_at = &#39;2013-11-17 21:34:10&#39; WHERE id=111;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="单列" tabindex="-1"><a class="header-anchor" href="#单列" aria-hidden="true">#</a> 单列</h3><p>更新单列主要用到<code>Update()</code>方法，使用<code>Update()</code>方法需要提供一些相应的条件，否则将会抛出错误<code>ErrMissingWhereClause</code> 。当使用<code>Model()</code>时并且主键值不为空，主键值将会被采用构建更新条件。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
		ID<span class="token punctuation">:</span>       <span class="token number">1</span><span class="token punctuation">,</span>
		Name<span class="token punctuation">:</span>     <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>
		Email<span class="token punctuation">:</span>    <span class="token string">&quot;78645@163.com&quot;</span><span class="token punctuation">,</span>
		Age<span class="token punctuation">:</span>      <span class="token number">23</span><span class="token punctuation">,</span>
		Birthday<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

<span class="token comment">//默认使用主键条件</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//UPDATE users SET name = &#39;mike&#39; WHERE id = 1</span>

<span class="token comment">//自行构建条件</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//UPDATE users SET name = &#39;mike&#39; WHERE age = 23</span>

<span class="token comment">//两者都有</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = 23&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//UPDATE users SET name = &#39;mike&#39; WHERE id = 1 AND age = 23 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多列" tabindex="-1"><a class="header-anchor" href="#多列" aria-hidden="true">#</a> 多列</h3><p>更新多列时主要用到<code>Updates()</code>方法，其参数支持<code>struct</code>和<code>map[string]interface{}</code>，当使用<code>struct</code>更新时，默认情况话只会更新非零值字段。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//根据struct更新，只会更新非零值字段</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//根据map更新属性</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;11@qq.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="选定字段" tabindex="-1"><a class="header-anchor" href="#选定字段" aria-hidden="true">#</a> 选定字段</h3><p>如果想要选定一些字段，可以使用<code>Select()</code>，如果想要排除一些字段可以使用<code>Omit()</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;11@qq.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;11@qq.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//选中所有字段进行更新</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//更新除了name所有的字段</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="批量更新" tabindex="-1"><a class="header-anchor" href="#批量更新" aria-hidden="true">#</a> 批量更新</h3><p>当没有指定<code>Model()</code>的主键值时，GORM就会执行批量更新</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//将所有年龄18岁以上的人名字更新为mike</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; 18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//将id为1，2，3的人更新为mike</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;id IN&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;mike&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="阻止全局更新" tabindex="-1"><a class="header-anchor" href="#阻止全局更新" aria-hidden="true">#</a> 阻止全局更新</h3><p>GORM在对于没有任何条件限制下的批量更新操作是不会去执行的，并返回错误<code>ErrMissingWhereClause</code>，如果想要这么做的话，使用原生SQL，或者开启<code>AllowGlobalUpdate</code>模式。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE users SET name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name = &quot;jinzhu&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>AllowGlobalUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET `name` = &quot;jinzhu&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用sql表达式" tabindex="-1"><a class="header-anchor" href="#使用sql表达式" aria-hidden="true">#</a> 使用SQL表达式</h3><p>使用SQL表达式可以灵活且安全的使用SQL内部的一些函数与操作。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//将所有年龄18岁以上的人名字更新为mike</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; 18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;age + ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//UPDATE users SET age = age + 10 WHERE age &gt; 10</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; 18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;age + ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//UPDATE users SET age = age + 10 WHERE age &gt; 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="子查询更新" tabindex="-1"><a class="header-anchor" href="#子查询更新" aria-hidden="true">#</a> 子查询更新</h3><p>可以将子查询得到的结果作为更新列的值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;company_name&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Company<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;companies.id = users.company_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE &quot;users&quot; SET &quot;company_name&quot; = (SELECT name FROM companies WHERE companies.id = users.company_id);</span>

db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users as u&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;company_name&quot;</span><span class="token punctuation">:</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;companies as c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;c.id = u.company_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新钩子方法" tabindex="-1"><a class="header-anchor" href="#更新钩子方法" aria-hidden="true">#</a> 更新钩子方法</h3><p>GORM 支持的 hook 点包括：<code>BeforeSave</code>, <code>BeforeUpdate</code>, <code>AfterSave</code>, <code>AfterUpdate</code>. 更新记录时将调用这些方法</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> u<span class="token punctuation">.</span>Role <span class="token operator">==</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;admin user not allowed to update&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="禁止hook与时间更新" tabindex="-1"><a class="header-anchor" href="#禁止hook与时间更新" aria-hidden="true">#</a> 禁止Hook与时间更新</h3><p>倘若想在更新时跳过<code>Hook</code>方法且不追踪时间更新，可以使用<code>UpdateColumn()</code>替代<code>Update()</code>，<code>UpdateColumns()</code>替代<code>Updates()</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 更新单个列</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateColumn</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name=&#39;hello&#39; WHERE id = 111;</span>

<span class="token comment">// 更新多个列</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateColumns</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name=&#39;hello&#39;, age=18 WHERE id = 111;</span>

<span class="token comment">// 更新选中的列</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateColumns</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name=&#39;hello&#39;, age=0 WHERE id = 111;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="返回更新的数据" tabindex="-1"><a class="header-anchor" href="#返回更新的数据" aria-hidden="true">#</a> 返回更新的数据</h3><p>返回被修改的数据，仅适用于支持 Returning 的数据库，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 返回所有列</span>
<span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>User
DB<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Returning<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;salary * ?&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING *</span>
<span class="token comment">// users =&gt; []User{{ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100}, {ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000}}</span>

<span class="token comment">// 返回指定的列</span>
DB<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Returning<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;salary&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;salary * ?&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING `name`, `salary`</span>
<span class="token comment">// users =&gt; []User{{ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100}, {ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000}}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检查字段值是否有更新" tabindex="-1"><a class="header-anchor" href="#检查字段值是否有更新" aria-hidden="true">#</a> 检查字段值是否有更新</h3><p>GORM提供了<code>Changed() </code>方法，一般在<code>BeforeUpdate(0)</code>钩子方法里面使用，它会返回字段是否有变化的布尔值，它仅仅是检查<code>Model</code>对象的字段值是否与<code>update()</code>,<code>updates()</code>的值是否相等，如果有值有变化，且字段未被忽略，则返回<code>true</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 Role 字段有变更</span>
    <span class="token keyword">if</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">Changed</span><span class="token punctuation">(</span><span class="token string">&quot;Role&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;role not allowed to change&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 如果 Name 或 Role 字段有变更</span>
   <span class="token keyword">if</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">Changed</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
     tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">SetColumn</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

  <span class="token comment">// 如果任意字段有变更</span>
    <span class="token keyword">if</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">Changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">SetColumn</span><span class="token punctuation">(</span><span class="token string">&quot;RefreshedAt&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; true</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有变更</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; true</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有变更</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="在更新前修改值" tabindex="-1"><a class="header-anchor" href="#在更新前修改值" aria-hidden="true">#</a> 在更新前修改值</h3><p>使用<code>gorm.DB.Statement.SetCloumn()</code>方法设置字段值</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeSave</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//在更新密码前将值加密</span>
  <span class="token keyword">if</span> pw<span class="token punctuation">,</span> err <span class="token operator">:=</span> bcrypt<span class="token punctuation">.</span><span class="token function">GenerateFromPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">SetColumn</span><span class="token punctuation">(</span><span class="token string">&quot;EncryptedPassword&quot;</span><span class="token punctuation">,</span> pw<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//如果code字段改变就将年龄+20</span>
  <span class="token keyword">if</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">Changed</span><span class="token punctuation">(</span><span class="token string">&quot;Code&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">.</span>Age <span class="token operator">+=</span> <span class="token number">20</span>
    tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">SetColumn</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Age<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="删除" tabindex="-1"><a class="header-anchor" href="#删除" aria-hidden="true">#</a> 删除</h2><p>GORM中主要使用<code>db.Delete()</code>方法来执行删除操作。</p><h3 id="单个删除" tabindex="-1"><a class="header-anchor" href="#单个删除" aria-hidden="true">#</a> 单个删除</h3><p>删除一条记录时，需要指定额外的条件或者指定主键，否则GORM将不会执行并且返回错误<code>ErrMissingWhereClause</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
   ID<span class="token punctuation">:</span>       <span class="token number">1</span><span class="token punctuation">,</span>
   Name<span class="token punctuation">:</span>     <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>
   Email<span class="token punctuation">:</span>    <span class="token string">&quot;78645@163.com&quot;</span><span class="token punctuation">,</span>
   Age<span class="token punctuation">:</span>      <span class="token number">23</span><span class="token punctuation">,</span>
   Birthday<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//带主键值的对象</span>
db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">//带额外条件的删除</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="根据主键删除" tabindex="-1"><a class="header-anchor" href="#根据主键删除" aria-hidden="true">#</a> 根据主键删除</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//DELETE FROM users WHERE id = 10</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">//DELETE FROM users WHERE id = 10</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">//DELETE FROM users WHERE id = 10</span>
db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="批量删除" tabindex="-1"><a class="header-anchor" href="#批量删除" aria-hidden="true">#</a> 批量删除</h3><p>如果指定的值不包括主属性，那么GORM会执行批量删除，它将删除所有匹配的记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//DELETE FROM users WHERE id age &gt; 18</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

<span class="token comment">//DELETE FROM users WHERE id age &gt; 18</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="阻止全局删除" tabindex="-1"><a class="header-anchor" href="#阻止全局删除" aria-hidden="true">#</a> 阻止全局删除</h3><p>在没有任何条件限制的情况下的批量删除将不会被执行，且会返回错误<code>ErrMissingWhereClause</code>。如果一定要这么做可以使用原生SQL或者启用<code>AllowGlobalUpdate </code>模式</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;DELETE FROM users&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM users</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>AllowGlobalUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM users</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="返回删除行的数据" tabindex="-1"><a class="header-anchor" href="#返回删除行的数据" aria-hidden="true">#</a> 返回删除行的数据</h3><p>返回被删除的数据，仅适用于支持 Returning 的数据库</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 返回所有列</span>
<span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>User
DB<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Returning<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING *</span>
<span class="token comment">// users =&gt; []User{{ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100}, {ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000}}</span>

<span class="token comment">// 返回指定的列</span>
DB<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Returning<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;salary&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING `name`, `salary`</span>
<span class="token comment">// users =&gt; []User{{ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100}, {ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000}}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="软删除" tabindex="-1"><a class="header-anchor" href="#软删除" aria-hidden="true">#</a> 软删除</h3><p>如果模型中包含了一个<code>gorm.deletedAt</code>字段(<code>gorm.Model</code>已经包含了该字段)，它将自动获得软删除的能力。拥有软删除能力的模型在调用<code>Delete()</code>时，数据库中的记录并不会被真正的删除，但是GORM会将<code>DeleteAt</code>置为删除时间，并且不再能够通过正常的查询方法查找到该记录。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// user 的 ID 是 `111`</span>
db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE id = 111;</span>

<span class="token comment">// 批量删除</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE age = 20;</span>

<span class="token comment">// 在查询时会忽略被软删除的记录</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = 20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>倘若不像引入<code>gorm.Model</code>，也可以按照如下的例子启用软删除特性</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID      <span class="token builtin">int</span>
  Deleted gorm<span class="token punctuation">.</span>DeletedAt
  Name    <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GORM中可以使用<code>Unscoped() </code>来查找到被软删除的记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Unscoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = 20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE age = 20;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>同样的也可以使用<code>Unscoped()</code>来永久删除记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Unscoped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>order<span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM orders WHERE id=10;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="软删除标志" tabindex="-1"><a class="header-anchor" href="#软删除标志" aria-hidden="true">#</a> 软删除标志</h3><p>在默认情况下，GORM使用<code>*time.time</code>作为<code>DeleteAt</code>字段的类型，此外，通过<code>gorm.io/plugin/soft_delet</code>插件还可以支持其他的类型。</p><h4 id="unix时间戳" tabindex="-1"><a class="header-anchor" href="#unix时间戳" aria-hidden="true">#</a> Unix时间戳</h4><p>使用unix时间戳作为 <code>delete flag</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/plugin/soft_delete&quot;</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">uint</span>
  Name      <span class="token builtin">string</span>
  DeletedAt soft_delete<span class="token punctuation">.</span>DeletedAt <span class="token comment">//默认使用unix时间戳</span>
    <span class="token comment">// DeletedAt soft_delete.DeletedAt `gorm:&quot;softDelete:nano&quot;` 或者指定纳秒</span>
    <span class="token comment">// DeletedAt soft_delete.DeletedAt `gorm:&quot;softDelete:milli&quot;` 或者指定微秒</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询</span>
SELECT <span class="token operator">*</span> FROM users WHERE deleted_at <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 删除</span>
UPDATE users SET deleted_at <span class="token operator">=</span> <span class="token comment">/* 当前时间戳 */</span> WHERE ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-0-flag" tabindex="-1"><a class="header-anchor" href="#_1-0-flag" aria-hidden="true">#</a> 1/0 Flag</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/plugin/soft_delete&quot;</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID    <span class="token builtin">uint</span>
  Name  <span class="token builtin">string</span>
  IsDel soft_delete<span class="token punctuation">.</span>DeletedAt <span class="token string">`gorm:&quot;softDelete:flag&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询</span>
SELECT <span class="token operator">*</span> FROM users WHERE is_del <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 删除</span>
UPDATE users SET is_del <span class="token operator">=</span> <span class="token number">1</span> WHERE ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="混合使用" tabindex="-1"><a class="header-anchor" href="#混合使用" aria-hidden="true">#</a> 混合使用</h4><p>混合模式可以使用 <code>0</code>, <code>1</code> 或 unix 秒来标识数据是否已被删除，并同时保存删除的时间。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">uint</span>
  Name      <span class="token builtin">string</span>
  DeletedAt time<span class="token punctuation">.</span>Time
  IsDel     soft_delete<span class="token punctuation">.</span>DeletedAt <span class="token string">`gorm:&quot;softDelete:flag,DeletedAtField:DeletedAt&quot;`</span> <span class="token comment">// 使用 `1` `0` 标识</span>
  <span class="token comment">// IsDel     soft_delete.DeletedAt `gorm:&quot;softDelete:,DeletedAtField:DeletedAt&quot;` // 使用 `unix second` 标识</span>
  <span class="token comment">// IsDel     soft_delete.DeletedAt `gorm:&quot;softDelete:nano,DeletedAtField:DeletedAt&quot;` // 使用 `unix nano second` 标识</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询</span>
SELECT <span class="token operator">*</span> FROM users WHERE is_del <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 删除</span>
UPDATE users SET is_del <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> deleted_at <span class="token operator">=</span> <span class="token comment">/* current unix second */</span> WHERE ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sql构建器" tabindex="-1"><a class="header-anchor" href="#sql构建器" aria-hidden="true">#</a> SQL构建器</h2><h3 id="原生sql" tabindex="-1"><a class="header-anchor" href="#原生sql" aria-hidden="true">#</a> 原生SQL</h3><p>原生查询SQL和<code>Scan</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id, name, age FROM users WHERE name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token keyword">var</span> name <span class="token builtin">string</span>
db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name FROM users WHERE id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Exec</code>原生SQL</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;DROP TABLE users&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE orders SET shipped_at = ? WHERE id IN ?&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Exec with SQL Expression</span>
db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE users SET money = ? WHERE name = ?&quot;</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">&quot;money * ? + ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="命名参数-1" tabindex="-1"><a class="header-anchor" href="#命名参数-1" aria-hidden="true">#</a> 命名参数</h3><p>GORM 支持 <a href="https://tip.golang.org/pkg/database/sql/#NamedArg" target="_blank" rel="noopener noreferrer"><code>sql.NamedArg</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>、<code>map[string]interface{}{}</code> 或 struct 形式的命名参数，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name1 = @name OR name2 = @name&quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name1 = @name OR name2 = @name&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result3<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu2&quot; OR name2 = &quot;jinzhu2&quot; ORDER BY `users`.`id` LIMIT 1</span>

<span class="token comment">// 原生 SQL 及命名参数</span>
db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM users WHERE name1 = @name OR name2 = @name2 OR name3 = @name&quot;</span><span class="token punctuation">,</span>
   sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name1 = &quot;jinzhu1&quot; OR name2 = &quot;jinzhu2&quot; OR name3 = &quot;jinzhu1&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE users SET name1 = @name, name2 = @name2, name3 = @name&quot;</span><span class="token punctuation">,</span>
   sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhunew&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">Named</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhunew2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET name1 = &quot;jinzhunew&quot;, name2 = &quot;jinzhunew2&quot;, name3 = &quot;jinzhunew&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM users WHERE (name1 = @name AND name3 = @name) AND name2 = @name2&quot;</span><span class="token punctuation">,</span>
   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name2&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;</span>

<span class="token keyword">type</span> NamedArgument <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span>
    Name2 <span class="token builtin">string</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM users WHERE (name1 = @Name AND name3 = @Name) AND name2 = @Name2&quot;</span><span class="token punctuation">,</span>
     NamedArgument<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> Name2<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dryrun模式" tabindex="-1"><a class="header-anchor" href="#dryrun模式" aria-hidden="true">#</a> DryRun模式</h3><p>在不执行的情况下生成SQL及其参数，可以用于测试生成的SQL</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>statement <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>DryRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name FROM users WHERE id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT name FROM users WHERE id = ?</span>
stmt<span class="token punctuation">.</span>Vars         <span class="token comment">//=&gt; [1]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tosql" tabindex="-1"><a class="header-anchor" href="#tosql" aria-hidden="true">#</a> TOSQL</h3><p>返回生成的 <code>SQL</code> 但不执行。</p><p>GORM使用 database/sql 的参数占位符来构建 SQL 语句，它会自动转义参数以避免 SQL 注入，但GORM不保证生成 SQL 的安全，请只用于调试。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>sql <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">ToSQL</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;age desc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
sql <span class="token comment">//=&gt; SELECT * FROM &quot;users&quot; WHERE id = 100 AND &quot;users&quot;.&quot;deleted_at&quot; IS NULL ORDER BY age desc LIMIT 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="row-rows" tabindex="-1"><a class="header-anchor" href="#row-rows" aria-hidden="true">#</a> Row &amp; Rows</h3><p>获取 <code>*sql.Row</code>结果，即只有一行数据</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 使用 GORM API 构建 SQL</span>
row <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>age<span class="token punctuation">)</span>

<span class="token comment">// 使用原生 SQL</span>
row <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select name, age, email from users where name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>email<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获取 <code>*sql.Rows</code> 结果，有多行数据</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 使用 GORM API 构建 SQL</span>
rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name, age, email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>email<span class="token punctuation">)</span>

  <span class="token comment">// 业务逻辑...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 原生 SQL</span>
rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select name, age, email from users where name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>email<span class="token punctuation">)</span>

  <span class="token comment">// 业务逻辑...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 <code>sql.Rows</code> 扫描至 model，使用 <code>ScanRows</code> 将一行记录扫描至 struct，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name, age, email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// (*sql.Rows, error)</span>
<span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> user User
<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ScanRows 将一行扫描至 user</span>
  db<span class="token punctuation">.</span><span class="token function">ScanRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

  <span class="token comment">// 业务逻辑...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="连接" tabindex="-1"><a class="header-anchor" href="#连接" aria-hidden="true">#</a> 连接</h3><p>在一条 tcp DB 连接中运行多条 SQL (不是事务)</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Connection</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;SET my.role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>

  tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="子句-clause" tabindex="-1"><a class="header-anchor" href="#子句-clause" aria-hidden="true">#</a> 子句(Clause)</h3><p>GORM内部使用<code>SQL builder</code>生成SQL。对于每个操作，GORM都会创建一个<code>*gorm.Statement</code>对象，所有的<code>GORM API</code>都是在为<code>Statement</code>添加，修改子句。最后，GORM会根据这些子句生成SQL。</p><p>例如，当使用<code>First</code>进行查询时，它会在<code>Statement</code>中添加以下子句。</p><p>子句示例 <a href="https://github.com/go-gorm/gorm/tree/master/clause" target="_blank" rel="noopener noreferrer">示例<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>clause<span class="token punctuation">.</span>Select<span class="token punctuation">{</span>Columns<span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">}</span> <span class="token comment">//选择所有字段</span>
clause<span class="token punctuation">.</span>From<span class="token punctuation">{</span>Tables<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>CurrentTable<span class="token punctuation">}</span> <span class="token comment">//选择表</span>
clause<span class="token punctuation">.</span>Limit<span class="token punctuation">{</span>Limit<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">//限制长度</span>
clause<span class="token punctuation">.</span>OrderByColumn<span class="token punctuation">{</span> <span class="token comment">//排序</span>
  Column<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>Column<span class="token punctuation">{</span>Table<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>CurrentTable<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> clause<span class="token punctuation">.</span>PrimaryKey<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//主键排序</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后 GORM 在 <code>Query</code> callback 中构建最终的查询 SQL，像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>Statement<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FROM&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;WHERE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;GROUP BY&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LIMIT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FOR&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>生成 SQL：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>SELECT <span class="token operator">*</span> FROM <span class="token string">`users`</span> ORDER BY <span class="token string">`users`</span><span class="token punctuation">.</span><span class="token string">`id`</span> LIMIT <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="子句构造器" tabindex="-1"><a class="header-anchor" href="#子句构造器" aria-hidden="true">#</a> 子句构造器</h3><p>不同的数据库, 子句可能会生成不同的 SQL，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SQL Server 会生成</span>
<span class="token comment">// SELECT * FROM &quot;users&quot; OFFSET 10 ROW FETCH NEXT 5 ROWS ONLY</span>
<span class="token comment">// MySQL 会生成</span>
<span class="token comment">// SELECT * FROM `users` LIMIT 5 OFFSET 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="子句选项" tabindex="-1"><a class="header-anchor" href="#子句选项" aria-hidden="true">#</a> 子句选项</h3><p>GORM 定义了很多 <a href="https://github.com/go-gorm/gorm/tree/master/clause" target="_blank" rel="noopener noreferrer">子句<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，其中一些 子句提供了你可能会用到的选项</p><p>尽管很少会用到它们，但如果你发现 GORM API 与你的预期不符合。这可能可以很好地检查它们，例如：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>db.Clauses(clause.Insert{Modifier: &quot;IGNORE&quot;}).Create(&amp;user)
// INSERT IGNORE INTO users (name,age...) VALUES (&quot;jinzhu&quot;,18...);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="statementmodifier" tabindex="-1"><a class="header-anchor" href="#statementmodifier" aria-hidden="true">#</a> StatementModifier</h3><p>GORM 提供了 <a href="https://pkg.go.dev/gorm.io/gorm?tab=doc#StatementModifier" target="_blank" rel="noopener noreferrer">StatementModifier<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 接口，允许您修改语句，使其符合您的要求，这儿有一个 <a href="https://gorm.io/zh_CN/docs/hints.html" target="_blank" rel="noopener noreferrer">Hint<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 示例</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>import &quot;gorm.io/hints&quot;

db.Clauses(hints.New(&quot;hint&quot;)).Find(&amp;User{})
// SELECT * /*+ hint */ FROM `users`
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="belongs-to" tabindex="-1"><a class="header-anchor" href="#belongs-to" aria-hidden="true">#</a> Belongs To</h2><p><code>belongs To</code>会与另一个模型建立了一对一的连接。这种模型的每一个实例都属于另一个模型的一个实例。</p><h3 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h3><p>每个user能且只能被分配给一个company，下面的代码中即表示的这种关系。注意，在 <code>User</code> 对象中，有一个和 <code>Company</code> 一样的 <code>CompanyID</code>。 默认情况下， <code>CompanyID</code> 被隐含地用来在 <code>User</code> 和 <code>Company</code> 之间创建一个外键关系， 因此必须包含在 <code>User</code> 结构体中才能填充 <code>Company</code> 内部结构体。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// `User` 属于 `Company`，`CompanyID` 是外键</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  CompanyID <span class="token builtin">int</span>
  Company   Company
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写外键" tabindex="-1"><a class="header-anchor" href="#重写外键" aria-hidden="true">#</a> 重写外键</h3><p>要定义一个 belongs to 关系，数据库的表中必须存在外键。默认情况下，外键的名字，使用拥有者的类型名称加上表的主键的字段名字</p><p>例如，定义一个User实体属于Company实体，那么外键的名字一般使用CompanyID。</p><p>GORM同时提供自定义外键名字的方式，如下例所示。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name         <span class="token builtin">string</span>
  CompanyRefer <span class="token builtin">int</span>
  Company      Company <span class="token string">`gorm:&quot;foreignKey:CompanyRefer&quot;`</span>
  <span class="token comment">// 使用 CompanyRefer 作为外键</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写引用" tabindex="-1"><a class="header-anchor" href="#重写引用" aria-hidden="true">#</a> 重写引用</h3><p>对于 belongs to 关系，GORM 通常使用数据库表，主表（拥有者）的主键值作为外键参考。 正如上面的例子，我们使用主表Company中的主键字段ID作为外键的参考值。如果在User实体中设置的Company实体，那么GORM会自动把Company中的ID属性保存到User的CompanyID属性中。并且，可以使用<code>references</code>标签来更改它，例如下方代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  CompanyID <span class="token builtin">string</span>
  Company   Company <span class="token string">`gorm:&quot;references:Code&quot;`</span> <span class="token comment">// 使用 Code 作为引用</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Code <span class="token builtin">string</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>如果外键名恰好在拥有者类型存在，GORM通常会错误的认为这是<code>Has One</code>关系。为了避免这种情况，需要在<code>belong to</code>关系中指定<code>references</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  CompanyID <span class="token builtin">string</span>
  Company   Company <span class="token string">`gorm:&quot;references:CompanyID&quot;`</span> <span class="token comment">// 使用 Company.CompanyID 作为引用</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  CompanyID   <span class="token builtin">int</span>
  Code        <span class="token builtin">string</span>
  Name        <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="外键约束" tabindex="-1"><a class="header-anchor" href="#外键约束" aria-hidden="true">#</a> 外键约束</h3><p>你可以通过 <code>constraint</code> 标签配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  CompanyID <span class="token builtin">int</span>
  Company   Company <span class="token string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="has-one" tabindex="-1"><a class="header-anchor" href="#has-one" aria-hidden="true">#</a> Has One</h2><p><code>has one</code> 与另一个模型建立一对一的关联，但它和一对一关系有些许不同。 这种关联表明一个模型的每个实例都包含或拥有另一个模型的一个实例。例如，您的应用包含 user 和 credit card 模型，且每个 user 只能有一张 credit card。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// User 有一张 CreditCard，UserID 是外键</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写外键-1" tabindex="-1"><a class="header-anchor" href="#重写外键-1" aria-hidden="true">#</a> 重写外键</h3><p>对于 <code>has one</code> 关系，同样必须存在外键字段。拥有者将把属于它的模型的主键保存到这个字段。这个字段的名称通常由 <code>has one</code> 模型的类型加上其 <code>主键</code> 生成，对于上面的例子，它是 <code>UserID</code>。为 user 添加 credit card 时，它会将 user 的 <code>ID</code> 保存到自己的 <code>UserID</code> 字段。</p><p>如果你想要使用另一个字段来保存该关系，你同样可以使用标签 <code>foreignKey</code> 来更改它，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard <span class="token string">`gorm:&quot;foreignKey:UserName&quot;`</span> <span class="token comment">// 使用 UserName 作为外键</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number   <span class="token builtin">string</span>
  UserName <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写引用-1" tabindex="-1"><a class="header-anchor" href="#重写引用-1" aria-hidden="true">#</a> 重写引用</h3><p>默认情况下，拥有者实体会将 <code>has one</code> 对应模型的主键保存为外键，您也可以修改它，用另一个字段来保存，例如下面这个使用 <code>Name</code> 来保存的例子。</p><p>您可以使用标签 <code>references</code> 来更改它，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name       <span class="token builtin">string</span>     <span class="token string">`gorm:&quot;index&quot;`</span>
  CreditCard CreditCard <span class="token string">`gorm:&quot;foreignKey:UserName;references:name&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number   <span class="token builtin">string</span>
  UserName <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多态关联" tabindex="-1"><a class="header-anchor" href="#多态关联" aria-hidden="true">#</a> 多态关联</h3><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键值都保存到多态类型的字段中。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Cat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID    <span class="token builtin">int</span>
  Name  <span class="token builtin">string</span>
  Toy   Toy <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span><span class="token comment">//Owner指的是字段前缀</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
  Toy  Toy <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Toy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">int</span>
  Name      <span class="token builtin">string</span>
  OwnerID   <span class="token builtin">int</span>
  OwnerType <span class="token builtin">string</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dog<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;dog1&quot;</span><span class="token punctuation">,</span> Toy<span class="token punctuation">:</span> Toy<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span>
<span class="token comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;dogs&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
  Toy  Toy <span class="token string">`gorm:&quot;polymorphic:Owner;polymorphicValue:master&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Toy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">int</span>
  Name      <span class="token builtin">string</span>
  OwnerID   <span class="token builtin">int</span>
  OwnerType <span class="token builtin">string</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dog<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;dog1&quot;</span><span class="token punctuation">,</span> Toy<span class="token punctuation">:</span> Toy<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span>
<span class="token comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1go&quot;,&quot;1&quot;,&quot;master&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自引用-has-one" tabindex="-1"><a class="header-anchor" href="#自引用-has-one" aria-hidden="true">#</a> 自引用 Has One</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  ManagerID <span class="token operator">*</span><span class="token builtin">uint</span>
  Manager   <span class="token operator">*</span>User
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="外键约束-1" tabindex="-1"><a class="header-anchor" href="#外键约束-1" aria-hidden="true">#</a> 外键约束</h3><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type User struct {
  gorm.Model
  CreditCard CreditCard `gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`
}

type CreditCard struct {
  gorm.Model
  Number string
  UserID uint
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="has-many" tabindex="-1"><a class="header-anchor" href="#has-many" aria-hidden="true">#</a> Has Many</h2><p><code>has many</code> 与另一个模型建立了一对多的连接。 不同于 <code>has one</code>，拥有者可以有零或多个关联模型。</p><p>例如，您的应用包含 user 和 credit card 模型，且每个 user 可以有多张 credit card。</p><h3 id="声明" tabindex="-1"><a class="header-anchor" href="#声明" aria-hidden="true">#</a> 声明</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// User 有多张 CreditCard，UserID 是外键</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCards <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检索" tabindex="-1"><a class="header-anchor" href="#检索" aria-hidden="true">#</a> 检索</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// 检索用户列表并预加载信用卡
func GetAll(db *gorm.DB) ([]User, error) {
    var users []User
    err := db.Model(&amp;User{}).Preload(&quot;CreditCards&quot;).Find(&amp;users).Error
    return users, err
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写外键-2" tabindex="-1"><a class="header-anchor" href="#重写外键-2" aria-hidden="true">#</a> 重写外键</h3><p>要定义 <code>has many</code> 关系，同样必须存在外键。 默认的外键名是拥有者的类型名加上其主键字段名</p><p>例如，要定义一个属于 <code>User</code> 的模型，则其外键应该是 <code>UserID</code>。</p><p>此外，想要使用另一个字段作为外键，您可以使用 <code>foreignKey</code> 标签自定义它：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCards <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard <span class="token string">`gorm:&quot;foreignKey:UserRefer&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number    <span class="token builtin">string</span>
  UserRefer <span class="token builtin">uint</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写引用-2" tabindex="-1"><a class="header-anchor" href="#重写引用-2" aria-hidden="true">#</a> 重写引用</h3><p>GORM 通常使用拥有者的主键作为外键的值。 对于上面的例子，它是 <code>User</code> 的 <code>ID</code> 字段。</p><p>为 user 添加 credit card 时，GORM 会将 user 的 <code>ID</code> 字段保存到 credit card 的 <code>UserID</code> 字段。</p><p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  MemberNumber <span class="token builtin">string</span>
  CreditCards  <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard <span class="token string">`gorm:&quot;foreignKey:UserNumber;references:MemberNumber&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number     <span class="token builtin">string</span>
  UserNumber <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多态关联-1" tabindex="-1"><a class="header-anchor" href="#多态关联-1" aria-hidden="true">#</a> 多态关联</h3><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键都保存到多态类型的字段中。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
  Toys <span class="token punctuation">[</span><span class="token punctuation">]</span>Toy <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Toy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">int</span>
  Name      <span class="token builtin">string</span>
  OwnerID   <span class="token builtin">int</span>
  OwnerType <span class="token builtin">string</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dog<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;dog1&quot;</span><span class="token punctuation">,</span> Toys<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Toy<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span>
<span class="token comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;dogs&quot;), (&quot;toy2&quot;,&quot;1&quot;,&quot;dogs&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
  Toys <span class="token punctuation">[</span><span class="token punctuation">]</span>Toy <span class="token string">`gorm:&quot;polymorphic:Owner;polymorphicValue:master&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Toy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">int</span>
  Name      <span class="token builtin">string</span>
  OwnerID   <span class="token builtin">int</span>
  OwnerType <span class="token builtin">string</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dog<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;dog1&quot;</span><span class="token punctuation">,</span> Toy<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Toy<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;toy2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span>
<span class="token comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;master&quot;), (&quot;toy2&quot;,&quot;1&quot;,&quot;master&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自引用" tabindex="-1"><a class="header-anchor" href="#自引用" aria-hidden="true">#</a> 自引用</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name      <span class="token builtin">string</span>
  ManagerID <span class="token operator">*</span><span class="token builtin">uint</span>
  Team      <span class="token punctuation">[</span><span class="token punctuation">]</span>User <span class="token string">`gorm:&quot;foreignkey:ManagerID&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="外键约束-2" tabindex="-1"><a class="header-anchor" href="#外键约束-2" aria-hidden="true">#</a> 外键约束</h3><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCards <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard <span class="token string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="many-to-many" tabindex="-1"><a class="header-anchor" href="#many-to-many" aria-hidden="true">#</a> Many To Many</h2><p>Many to Many 会在两个 model 中添加一张连接表。</p><p>例如，您的应用包含了 user 和 language，且一个 user 可以说多种 language，多个 user 也可以说一种 language。</p><p>当使用 GORM 的 <code>AutoMigrate</code> 为 <code>User</code> 创建表时，GORM 会自动创建连接表</p><h3 id="声明-1" tabindex="-1"><a class="header-anchor" href="#声明-1" aria-hidden="true">#</a> 声明</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Languages <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Language <span class="token string">`gorm:&quot;many2many:user_languages;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Language <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name <span class="token builtin">string</span>
  Users <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User <span class="token string">`gorm:&quot;many2many:user_languages;&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="检索-1" tabindex="-1"><a class="header-anchor" href="#检索-1" aria-hidden="true">#</a> 检索</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 检索 User 列表并预加载 Language</span>
<span class="token keyword">func</span> <span class="token function">GetAllUsers</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>User
    err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
    <span class="token keyword">return</span> users<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

<span class="token comment">// 检索 Language 列表并预加载 User</span>
<span class="token keyword">func</span> <span class="token function">GetAllLanguages</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> languages <span class="token punctuation">[</span><span class="token punctuation">]</span>Language
    err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Language<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>languages<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
    <span class="token keyword">return</span> languages<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="重写外键-3" tabindex="-1"><a class="header-anchor" href="#重写外键-3" aria-hidden="true">#</a> 重写外键</h3><p>对于 <code>many2many</code> 关系，连接表会同时拥有两个模型的外键，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Languages <span class="token punctuation">[</span><span class="token punctuation">]</span>Language <span class="token string">`gorm:&quot;many2many:user_languages;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Language <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 连接表：user_languages</span>
<span class="token comment">//   foreign key: user_id, reference: users.id</span>
<span class="token comment">//   foreign key: language_id, reference: languages.id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>若要重写它们，可以使用标签 <code>foreignKey</code>、<code>references</code>、<code>joinforeignKey</code>、<code>joinReferences</code>。当然，您不需要使用全部的标签，你可以仅使用其中的一个重写部分的外键、引用。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    gorm<span class="token punctuation">.</span>Model
    Profiles <span class="token punctuation">[</span><span class="token punctuation">]</span>Profile <span class="token string">`gorm:&quot;many2many:user_profiles;foreignKey:Refer;joinForeignKey:UserReferID;References:UserRefer;joinReferences:ProfileRefer&quot;`</span>
    Refer    <span class="token builtin">uint</span>      <span class="token string">`gorm:&quot;index:,unique&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Profile <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    gorm<span class="token punctuation">.</span>Model
    Name      <span class="token builtin">string</span>
    UserRefer <span class="token builtin">uint</span> <span class="token string">`gorm:&quot;index:,unique&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 会创建连接表：user_profiles</span>
<span class="token comment">//   foreign key: user_refer_id, reference: users.refer</span>
<span class="token comment">//   foreign key: profile_refer, reference: profiles.user_refer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>某些数据库只允许在唯一索引字段上创建外键，如果您在迁移时会创建外键，则需要指定 <code>unique index</code> 标签。</p></div><h3 id="自引用-1" tabindex="-1"><a class="header-anchor" href="#自引用-1" aria-hidden="true">#</a> 自引用</h3><p>自引用 many2many 关系</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
    Friends <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User <span class="token string">`gorm:&quot;many2many:user_friends&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 会创建连接表：user_friends</span>
<span class="token comment">//   foreign key: user_id, reference: users.id</span>
<span class="token comment">//   foreign key: friend_id, reference: users.id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义连接表" tabindex="-1"><a class="header-anchor" href="#自定义连接表" aria-hidden="true">#</a> 自定义连接表</h3><p><code>连接表</code> 可以是一个全功能的模型，支持 <code>Soft Delete</code>、<code>钩子</code>、更多的字段，就跟其它模型一样。您可以通过 <code>SetupJoinTable</code> 指定它，例如：</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>自定义连接表要求外键是复合主键或复合唯一索引</p></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID        <span class="token builtin">int</span>
  Name      <span class="token builtin">string</span>
  Addresses <span class="token punctuation">[</span><span class="token punctuation">]</span>Address <span class="token string">`gorm:&quot;many2many:person_addresses;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">uint</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> PersonAddress <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  PersonID  <span class="token builtin">int</span> <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  AddressID <span class="token builtin">int</span> <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  CreatedAt time<span class="token punctuation">.</span>Time
  DeletedAt gorm<span class="token punctuation">.</span>DeletedAt
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>PersonAddress<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 修改 Person 的 Addresses 字段的连接表为 PersonAddress</span>
<span class="token comment">// PersonAddress 必须定义好所需的外键，否则会报错</span>
err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">SetupJoinTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Person<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Addresses&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>PersonAddress<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="外键约束-3" tabindex="-1"><a class="header-anchor" href="#外键约束-3" aria-hidden="true">#</a> 外键约束</h3><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code> 实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Languages <span class="token punctuation">[</span><span class="token punctuation">]</span>Language <span class="token string">`gorm:&quot;many2many:user_speaks;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Language <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Code <span class="token builtin">string</span> <span class="token string">`gorm:&quot;primarykey&quot;`</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">/* CREATE TABLE `user_speaks` 
	(`user_id` integer,`language_code` text,PRIMARY KEY (`user_id`,`language_code`),CONSTRAINT `fk_user_speaks_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE,CONSTRAINT `fk_user_speaks_language` FOREIGN KEY (`language_code`) REFERENCES `languages`(`code`) ON DELETE SET NULL ON UPDATE CASCADE);
	
*/</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="复合外键" tabindex="-1"><a class="header-anchor" href="#复合外键" aria-hidden="true">#</a> 复合外键</h3><p>如果您的模型使用了复合主键，GORM 会默认启用复合外键。</p><p>您也可以覆盖默认的外键、指定多个外键，只需用逗号分隔那些键名，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Tag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     <span class="token builtin">uint</span>   <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  Locale <span class="token builtin">string</span> <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  Value  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Blog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID         <span class="token builtin">uint</span>   <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  Locale     <span class="token builtin">string</span> <span class="token string">`gorm:&quot;primaryKey&quot;`</span>
  Subject    <span class="token builtin">string</span>
  Body       <span class="token builtin">string</span>
  Tags       <span class="token punctuation">[</span><span class="token punctuation">]</span>Tag <span class="token string">`gorm:&quot;many2many:blog_tags;&quot;`</span>
  LocaleTags <span class="token punctuation">[</span><span class="token punctuation">]</span>Tag <span class="token string">`gorm:&quot;many2many:locale_blog_tags;ForeignKey:id,locale;References:id&quot;`</span>
  SharedTags <span class="token punctuation">[</span><span class="token punctuation">]</span>Tag <span class="token string">`gorm:&quot;many2many:shared_blog_tags;ForeignKey:id;References:id&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 连接表：blog_tags</span>
<span class="token comment">//   foreign key: blog_id, reference: blogs.id</span>
<span class="token comment">//   foreign key: blog_locale, reference: blogs.locale</span>
<span class="token comment">//   foreign key: tag_id, reference: tags.id</span>
<span class="token comment">//   foreign key: tag_locale, reference: tags.locale</span>

<span class="token comment">// 连接表：locale_blog_tags</span>
<span class="token comment">//   foreign key: blog_id, reference: blogs.id</span>
<span class="token comment">//   foreign key: blog_locale, reference: blogs.locale</span>
<span class="token comment">//   foreign key: tag_id, reference: tags.id</span>

<span class="token comment">// 连接表：shared_blog_tags</span>
<span class="token comment">//   foreign key: blog_id, reference: blogs.id</span>
<span class="token comment">//   foreign key: tag_id, reference: tags.id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="关联模式" tabindex="-1"><a class="header-anchor" href="#关联模式" aria-hidden="true">#</a> 关联模式</h2><h3 id="自动创建-更新" tabindex="-1"><a class="header-anchor" href="#自动创建-更新" aria-hidden="true">#</a> 自动创建，更新</h3><p>在创建、更新记录时，GORM 会通过Upsert 自动保存关联及其引用记录。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>            <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  BillingAddress<span class="token punctuation">:</span>  Address<span class="token punctuation">{</span>Address1<span class="token punctuation">:</span> <span class="token string">&quot;Billing Address - Address 1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  ShippingAddress<span class="token punctuation">:</span> Address<span class="token punctuation">{</span>Address1<span class="token punctuation">:</span> <span class="token string">&quot;Shipping Address - Address 1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  Emails<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span>Email<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>Email<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu@example.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Email<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu-2@example.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Languages<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;ZH&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;EN&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// BEGIN TRANSACTION;</span>
<span class="token comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY DO NOTHING;</span>
<span class="token comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span>
<span class="token comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY DO NOTHING;</span>
<span class="token comment">// INSERT INTO &quot;languages&quot; (&quot;name&quot;) VALUES (&#39;ZH&#39;), (&#39;EN&#39;) ON DUPLICATE KEY DO NOTHING;</span>
<span class="token comment">// INSERT INTO &quot;user_languages&quot; (&quot;user_id&quot;,&quot;language_id&quot;) VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;</span>
<span class="token comment">// COMMIT;</span>

db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果您想要更新关联的数据，您应该使用 <code>FullSaveAssociations</code> 模式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>FullSaveAssociations<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);</span>
<span class="token comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span>
<span class="token comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="跳过自动创建、更新" tabindex="-1"><a class="header-anchor" href="#跳过自动创建、更新" aria-hidden="true">#</a> 跳过自动创建、更新</h3><p>若要在创建、更新时跳过自动保存，您可以使用 <code>Select</code> 或 <code>Omit</code>，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>user <span class="token operator">:=</span> User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>            <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  BillingAddress<span class="token punctuation">:</span>  Address<span class="token punctuation">{</span>Address1<span class="token punctuation">:</span> <span class="token string">&quot;Billing Address - Address 1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  ShippingAddress<span class="token punctuation">:</span> Address<span class="token punctuation">{</span>Address1<span class="token punctuation">:</span> <span class="token string">&quot;Shipping Address - Address 1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  Emails<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span>Email<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>Email<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu@example.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Email<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu-2@example.com&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Languages<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;ZH&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;EN&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO &quot;users&quot; (name) VALUES (&quot;jinzhu&quot;, 1, 2);</span>

db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;BillingAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// Skip create BillingAddress when creating a user</span>

db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Associations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// Skip all associations when creating a user</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>NOTE:</strong> 对于 many2many 关联，GORM 在创建连接表引用之前，会先 upsert 关联。如果你想跳过关联的 upsert，你可以这样做：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;Languages.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>下面的代码将跳过创建关联及其引用</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Omit</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></div><h3 id="查找关联" tabindex="-1"><a class="header-anchor" href="#查找关联" aria-hidden="true">#</a> 查找关联</h3><p>查找所有匹配的关联记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>languages<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查找带条件的关联</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>codes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;zh-CN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;en-US&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ja-JP&quot;</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;code IN ?&quot;</span><span class="token punctuation">,</span> codes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>languages<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;code IN ?&quot;</span><span class="token punctuation">,</span> codes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;code desc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>languages<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加关联" tabindex="-1"><a class="header-anchor" href="#添加关联" aria-hidden="true">#</a> 添加关联</h3><p>如果是<code>many to many</code>、<code>has many</code> 添加新的关联；如果是 <code>has one</code>, <code>belongs to</code> 替换当前的关联</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">{</span>languageZH<span class="token punctuation">,</span> languageEN<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Language<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;DE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;CreditCard&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CreditCard<span class="token punctuation">{</span>Number<span class="token punctuation">:</span> <span class="token string">&quot;411111111111&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="替换关联" tabindex="-1"><a class="header-anchor" href="#替换关联" aria-hidden="true">#</a> 替换关联</h3><p>用一个新的关联替换当前的关联</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">{</span>languageZH<span class="token punctuation">,</span> languageEN<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>Language<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;DE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> languageEN<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除关联" tabindex="-1"><a class="header-anchor" href="#删除关联" aria-hidden="true">#</a> 删除关联</h3><p>如果存在，则删除源模型与参数之间的关系，只会删除引用，不会从数据库中删除这些对象，会将引用更新为<code>NULL</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Language<span class="token punctuation">{</span>languageZH<span class="token punctuation">,</span>languageEN<span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>languageZH<span class="token punctuation">,</span> languageEN<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="清空关联" tabindex="-1"><a class="header-anchor" href="#清空关联" aria-hidden="true">#</a> 清空关联</h3><p>删除源模型与关联之间的所有引用，但不会删除这些关联</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="关联计数" tabindex="-1"><a class="header-anchor" href="#关联计数" aria-hidden="true">#</a> 关联计数</h3><p>返回当前关联的计数</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 条件计数</span>
codes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;zh-CN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;en-US&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ja-JP&quot;</span><span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;code IN ?&quot;</span><span class="token punctuation">,</span> codes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Languages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="批量处理" tabindex="-1"><a class="header-anchor" href="#批量处理" aria-hidden="true">#</a> 批量处理</h3><p>关联模式也支持批量处理，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 查询所有用户的所有角色</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Role&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>roles<span class="token punctuation">)</span>

<span class="token comment">// 从所有 team 中删除 user A</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>userA<span class="token punctuation">)</span>

<span class="token comment">// 获取去重的用户所属 team 数量</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 对于批量数据的 `Append`、`Replace`，参数的长度必须与数据的长度相同，否则会返回 error</span>
<span class="token keyword">var</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span>user1<span class="token punctuation">,</span> user2<span class="token punctuation">,</span> user3<span class="token punctuation">}</span>
<span class="token comment">// 例如：现在有三个 user，Append userA 到 user1 的 team，Append userB 到 user2 的 team，Append userA、userB 和 userC 到 user3 的 team</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>userA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>userB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span>userA<span class="token punctuation">,</span> userB<span class="token punctuation">,</span> userC<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 重置 user1 team 为 userA，重置 user2 的 team 为 userB，重置 user3 的 team 为 userA、 userB 和 userC</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Association</span><span class="token punctuation">(</span><span class="token string">&quot;Team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>userA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>userB<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span>userA<span class="token punctuation">,</span> userB<span class="token punctuation">,</span> userC<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="select删除" tabindex="-1"><a class="header-anchor" href="#select删除" aria-hidden="true">#</a> Select删除</h3><p>你可以在删除记录时通过 <code>Select</code> 来删除具有 has one、has many、many2many 关系的记录，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 删除 user 时，也删除 user 的 account</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 删除 user 时，也删除 user 的 Orders、CreditCards 记录</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 删除 user 时，也删除用户所有 has one/many、many2many 记录</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Associations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 删除 users 时，也删除每一个 user 的 account</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意：</strong> 只有当记录的主键不为空时，关联才会被删除，GORM 会使用这些主键作为条件来删除关联记录</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 不会有效</span>
db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 会删除所有 name=`jinzhu` 的 user，但这些 user 的 account 不会被删除</span>

db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 会删除 name = `jinzhu` 且 id = `1` 的 user，并且 user `1` 的 account 也会被删除</span>

db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 会删除 id = `1` 的 user，并且 user `1` 的 account 也会被删除</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="关联标签" tabindex="-1"><a class="header-anchor" href="#关联标签" aria-hidden="true">#</a> 关联标签</h3><table><thead><tr><th style="text-align:left;">标签</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">foreignKey</td><td style="text-align:left;">指定当前模型的列作为连接表的外键</td></tr><tr><td style="text-align:left;">references</td><td style="text-align:left;">指定引用表的列名，其将被映射为连接表外键</td></tr><tr><td style="text-align:left;">polymorphic</td><td style="text-align:left;">指定多态类型，比如模型名</td></tr><tr><td style="text-align:left;">polymorphicValue</td><td style="text-align:left;">指定多态值、默认表名</td></tr><tr><td style="text-align:left;">many2many</td><td style="text-align:left;">指定连接表表名</td></tr><tr><td style="text-align:left;">joinForeignKey</td><td style="text-align:left;">指定连接表的外键列名，其将被映射到当前表</td></tr><tr><td style="text-align:left;">joinReferences</td><td style="text-align:left;">指定连接表的外键列名，其将被映射到引用表</td></tr><tr><td style="text-align:left;">constraint</td><td style="text-align:left;">关系约束，例如：<code>OnUpdate</code>、<code>OnDelete</code></td></tr></tbody></table><h2 id="预加载" tabindex="-1"><a class="header-anchor" href="#预加载" aria-hidden="true">#</a> 预加载</h2><p>GORM 允许在其他 SQL 中使用<code>preload</code>进行即时加载关系(说人话就是在查询的时候把模型中所有的关联数据都查出来)，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Username <span class="token builtin">string</span>
  Orders   <span class="token punctuation">[</span><span class="token punctuation">]</span>Order
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  UserID <span class="token builtin">uint</span>
  Price  <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查找 user 时预加载相关 Order</span>
db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users;</span>
<span class="token comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4);</span>

db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Profile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Role&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users;</span>
<span class="token comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4); // has many</span>
<span class="token comment">// SELECT * FROM profiles WHERE user_id IN (1,2,3,4); // has one</span>
<span class="token comment">// SELECT * FROM roles WHERE id IN (4,5,6); // belongs to</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="joins-预加载" tabindex="-1"><a class="header-anchor" href="#joins-预加载" aria-hidden="true">#</a> Joins 预加载</h3><p><code>Preload</code> 在一个单独查询中加载关联数据。而 <code>Join Preload</code> 会使用 left join 加载关联数据</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Manager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Manager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;users.name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Company&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Manager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Joins</span><span class="token punctuation">(</span><span class="token string">&quot;Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token string">&quot;users.id IN ?&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p><strong>注意</strong> <code>Join Preload</code> 适用于一对一的关系，例如： <code>has one</code>, <code>belongs to</code></p></div><h3 id="预加载全部" tabindex="-1"><a class="header-anchor" href="#预加载全部" aria-hidden="true">#</a> 预加载全部</h3><p>与创建、更新时使用 <code>Select</code> 类似，<code>clause.Associations</code> 也可以和 <code>Preload</code> 一起使用，它可以用来 <code>预加载</code> 全部关联，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name       <span class="token builtin">string</span>
  CompanyID  <span class="token builtin">uint</span>
  Company    Company
  Role       Role
  Orders     <span class="token punctuation">[</span><span class="token punctuation">]</span>Order
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Associations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>clause.Associations</code> 不会预加载嵌套的关联，但你可以使用嵌套预加载 例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders.OrderItems.Product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>Associations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="条件预加载" tabindex="-1"><a class="header-anchor" href="#条件预加载" aria-hidden="true">#</a> 条件预加载</h3><p>GORM 允许带条件的 Preload 关联</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 带条件的预加载 Order</span>
db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;state NOT IN (?)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cancelled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users;</span>
<span class="token comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4) AND state NOT IN (&#39;cancelled&#39;);</span>

db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;state = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;active&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;state NOT IN (?)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cancelled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE state = &#39;active&#39;;</span>
<span class="token comment">// SELECT * FROM orders WHERE user_id IN (1,2) AND state NOT IN (&#39;cancelled&#39;);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义预加载" tabindex="-1"><a class="header-anchor" href="#自定义预加载" aria-hidden="true">#</a> 自定义预加载</h3><p>您可以通过 <code>func(db *gorm.DB) *gorm.DB</code> 实现自定义预加载 SQL，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;orders.amount DESC&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users;</span>
<span class="token comment">// SELECT * FROM orders WHERE user_id IN (1,2,3,4) order by orders.amount DESC;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="嵌套预加载" tabindex="-1"><a class="header-anchor" href="#嵌套预加载" aria-hidden="true">#</a> 嵌套预加载</h3><p>GORM 支持嵌套预加载，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders.OrderItems.Product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;CreditCard&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

<span class="token comment">// 自定义预加载 `Orders` 的条件</span>
<span class="token comment">// 这样，GORM 就不会加载不匹配的 order 记录</span>
db<span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;state = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;paid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Preload</span><span class="token punctuation">(</span><span class="token string">&quot;Orders.OrderItems&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="context" tabindex="-1"><a class="header-anchor" href="#context" aria-hidden="true">#</a> Context</h2><p>GORM通过 <code>WithContext()</code>方法提供了Context支持</p><h3 id="单会话模式" tabindex="-1"><a class="header-anchor" href="#单会话模式" aria-hidden="true">#</a> 单会话模式</h3><p>单会话模式通常被用于执行单次操作</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="持续会话模式" tabindex="-1"><a class="header-anchor" href="#持续会话模式" aria-hidden="true">#</a> 持续会话模式</h3><p>持续会话模式通常被用于执行一系列操作，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="会话超时" tabindex="-1"><a class="header-anchor" href="#会话超时" aria-hidden="true">#</a> 会话超时</h3><p>对于长 Sql 查询，你可以传入一个带超时的 context 给 <code>db.WithContext</code> 来设置超时时间，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="hooks-callbacks-中的-context" tabindex="-1"><a class="header-anchor" href="#hooks-callbacks-中的-context" aria-hidden="true">#</a> Hooks/Callbacks 中的 Context</h3><p>您可以从当前 <code>Statement</code>中访问 <code>Context</code> 对象，例如︰</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span>Context
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="错误处理" tabindex="-1"><a class="header-anchor" href="#错误处理" aria-hidden="true">#</a> 错误处理</h2><p>在GO中，错误处理是很重要的，建议在调用任何终结操作后，都进行错误检查。</p><h3 id="示例-1" tabindex="-1"><a class="header-anchor" href="#示例-1" aria-hidden="true">#</a> 示例</h3><p>GORM的错误处理与常见的GO代码不同，因为GORM提供的是链式API。如果遇到任何错误，GORM会设置<code>*gorm.DB</code>的<code>Error</code>字段，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">//错误处理</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> res <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> res<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">//错误处理</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="错误列表" tabindex="-1"><a class="header-anchor" href="#错误列表" aria-hidden="true">#</a> 错误列表</h3><p>[错误列表](<a href="https://github.com/go-gorm/gorm/blob/master/errors.go" target="_blank" rel="noopener noreferrer">gorm/errors.go at master · go-gorm/gorm (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p><table><thead><tr><th style="text-align:center;">Error名称</th><th style="text-align:center;">描述</th></tr></thead><tbody><tr><td style="text-align:center;"><code>ErrRecordNotFound</code></td><td style="text-align:center;">记录未找到</td></tr><tr><td style="text-align:center;"><code>ErrInvalidTransaction</code></td><td style="text-align:center;">无效的事务，通常发生在<code>Commit</code>或者<code>Rollback</code>时</td></tr><tr><td style="text-align:center;"><code>ErrNotImplemented</code></td><td style="text-align:center;">不可执行</td></tr><tr><td style="text-align:center;"><code>ErrMissingWhereClause</code></td><td style="text-align:center;">缺失了<code>WHERE</code>条件</td></tr><tr><td style="text-align:center;"><code>ErrUnsupportedRelation</code></td><td style="text-align:center;">不支持的关联</td></tr><tr><td style="text-align:center;"><code>ErrPrimaryKeyRequired</code></td><td style="text-align:center;">主键缺失</td></tr><tr><td style="text-align:center;"><code>ErrModelValueRequired</code></td><td style="text-align:center;">模型的值缺失</td></tr><tr><td style="text-align:center;"><code>ErrInvalidData</code></td><td style="text-align:center;">不支持的数据</td></tr><tr><td style="text-align:center;"><code>ErrUnsupportedDriver</code></td><td style="text-align:center;">不支持的驱动</td></tr><tr><td style="text-align:center;"><code>ErrRegistered</code></td><td style="text-align:center;">已注册</td></tr><tr><td style="text-align:center;"><code>ErrInvalidField</code></td><td style="text-align:center;">无效的字段</td></tr><tr><td style="text-align:center;"><code>ErrEmptySlice</code></td><td style="text-align:center;">发现空切片</td></tr><tr><td style="text-align:center;"><code>ErrDryRunModeUnsupported</code></td><td style="text-align:center;">不支持<code>dry run</code>模式</td></tr><tr><td style="text-align:center;"><code>ErrInvalidDB</code></td><td style="text-align:center;">无效的数据库</td></tr><tr><td style="text-align:center;"><code>ErrInvalidValue</code></td><td style="text-align:center;">无效的值，应该为一个指向结构体或者切片的指针</td></tr><tr><td style="text-align:center;"><code>ErrInvalidValueOfLength</code></td><td style="text-align:center;">关联值无效，长度不匹配</td></tr><tr><td style="text-align:center;"><code>ErrPreloadNotAllowed</code></td><td style="text-align:center;">当使用<code>Count()</code>时不允许<code>Preload</code></td></tr></tbody></table><h2 id="链式操作" tabindex="-1"><a class="header-anchor" href="#链式操作" aria-hidden="true">#</a> 链式操作</h2><p>GORM允许进行链式操作，所以可以像如下写代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name=?&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Fisrt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>GORM中有三种类型的方法，<code>链式方法</code>,<code>终结方法</code>,<code>新建会话方法</code>.</p><p>在 <code>链式方法</code>, <code>终结方法</code>之后, GORM 返回一个初始化的 <code>*gorm.DB</code> 实例，实例不能安全地重复使用，并且新生成的 SQL 可能会被先前的条件污染，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>queryDB <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10 AND age &gt; 20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了重新使用初始化的 <code>*gorm.DB</code> 实例, 您可以使用 <code>新建会话方法</code> 创建一个可共享的 <code>*gorm.DB</code>, 例如:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>queryDB <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 10</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age &gt; 20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="链式方法" tabindex="-1"><a class="header-anchor" href="#链式方法" aria-hidden="true">#</a> 链式方法</h3><p>链式方法是将<code>Clauses</code>修改或添加到当前<code>Statement</code>的方法，例如 :<code>Where</code>,<code>Select</code>,<code>Joins</code>,<code>Scopes</code>,<code>Preload</code>等等。</p><h3 id="终结方法" tabindex="-1"><a class="header-anchor" href="#终结方法" aria-hidden="true">#</a> 终结方法</h3><p>终结方法是回立即执行注册回调的方法，然后生成并执行SQL，比如：<code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>Update</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code></p><h3 id="新建会话方法" tabindex="-1"><a class="header-anchor" href="#新建会话方法" aria-hidden="true">#</a> 新建会话方法</h3><p>GORM定义了<code>Session</code>,<code>WithContext</code>,<code>Debug</code>方法作为<code>新建会话方法</code>。在 <code>链式方法</code>, <code>终结方法</code>之后, GORM 返回一个初始化的 <code>*gorm.DB</code> 实例，不能安全地再使用。您应该使用 <code>新建会话方法</code> 来标记 <code>*gorm.DB</code> 为可共享。</p><h2 id="会话" tabindex="-1"><a class="header-anchor" href="#会话" aria-hidden="true">#</a> 会话</h2><p>GORM提供了<code>Session</code>方法，这是一个<code>New Session Method</code>，它允许创建带配置的新建会话模式</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Session 配置</span>
<span class="token keyword">type</span> Session <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  DryRun                   <span class="token builtin">bool</span>
  PrepareStmt              <span class="token builtin">bool</span>
  NewDB                    <span class="token builtin">bool</span>
  Initialized              <span class="token builtin">bool</span>
  SkipHooks                <span class="token builtin">bool</span>
  SkipDefaultTransaction   <span class="token builtin">bool</span>
  DisableNestedTransaction <span class="token builtin">bool</span>
  AllowGlobalUpdate        <span class="token builtin">bool</span>
  FullSaveAssociations     <span class="token builtin">bool</span>
  QueryFields              <span class="token builtin">bool</span>
  Context                  context<span class="token punctuation">.</span>Context
  Logger                   logger<span class="token punctuation">.</span>Interface
  NowFunc                  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time
  CreateBatchSize          <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来会逐一讲解这些配置</p><h3 id="dryrun" tabindex="-1"><a class="header-anchor" href="#dryrun" aria-hidden="true">#</a> DryRun</h3><p>生成 <code>SQL</code> 但不执行。 它可以用于准备或测试生成的 SQL，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 新建会话模式</span>
stmt <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>DryRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`</span>
stmt<span class="token punctuation">.</span>Vars         <span class="token comment">//=&gt; []interface{}{1}</span>

<span class="token comment">// 全局 DryRun 模式</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>DryRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 不同的数据库生成不同的 SQL</span>
stmt <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM `users` WHERE `id` = $1 // PostgreSQL</span>
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM `users` WHERE `id` = ?  // MySQL</span>
stmt<span class="token punctuation">.</span>Vars         <span class="token comment">//=&gt; []interface{}{1}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以使用下面的代码生成最终的 SQL：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 注意：SQL 并不总是能安全地执行，GORM 仅将其用于日志，它可能导致会 SQL 注入</span>
db<span class="token punctuation">.</span>Dialector<span class="token punctuation">.</span><span class="token function">Explain</span><span class="token punctuation">(</span>stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stmt<span class="token punctuation">.</span>Vars<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` WHERE `id` = 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="预编译" tabindex="-1"><a class="header-anchor" href="#预编译" aria-hidden="true">#</a> 预编译</h3><p><code>PreparedStmt</code> 在执行任何 SQL 时都会创建一个 prepared statement 并将其缓存，以提高后续的效率，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 全局模式，所有 DB 操作都会创建并缓存预编译语句</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 会话模式</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

<span class="token comment">// returns prepared statements manager</span>
stmtManger<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span>ConnPool<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>PreparedStmtDB<span class="token punctuation">)</span>

<span class="token comment">// 关闭 *当前会话* 的预编译模式</span>
stmtManger<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 为 *当前会话* 预编译 SQL</span>
stmtManger<span class="token punctuation">.</span>PreparedSQL <span class="token comment">// =&gt; []string{}</span>

<span class="token comment">// 为当前数据库连接池的（所有会话）开启预编译模式</span>
stmtManger<span class="token punctuation">.</span>Stmts <span class="token comment">// map[string]*sql.Stmt</span>

<span class="token keyword">for</span> sql<span class="token punctuation">,</span> stmt <span class="token operator">:=</span> <span class="token keyword">range</span> stmtManger<span class="token punctuation">.</span>Stmts <span class="token punctuation">{</span>
  sql  <span class="token comment">// 预编译 SQL</span>
  stmt <span class="token comment">// 预编译模式</span>
  stmt<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭预编译模式</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="newdb" tabindex="-1"><a class="header-anchor" href="#newdb" aria-hidden="true">#</a> NewDB</h3><p>通过 <code>NewDB</code> 选项创建一个不会保留先前条件的新会话。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>NewDB<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users ORDER BY id LIMIT 1 //name = jinzhu的条件被遗弃</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = 10 ORDER BY id //name = jinzhu的条件被遗弃</span>

<span class="token comment">// 不带 `NewDB` 选项</span>
tx2 <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx2<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; ORDER BY id //name = jinzhu的条件被保留</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化" aria-hidden="true">#</a> 初始化</h3><p>创建一个新的初始化的 DB，这个 DB 不再是方法链、协程安全。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>Initialized<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="跳过钩子" tabindex="-1"><a class="header-anchor" href="#跳过钩子" aria-hidden="true">#</a> 跳过钩子</h3><p>如果您想跳过 <code>钩子</code> 方法，您可以使用 <code>SkipHooks</code> 会话模式，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="禁用嵌套事务" tabindex="-1"><a class="header-anchor" href="#禁用嵌套事务" aria-hidden="true">#</a> 禁用嵌套事务</h3><p>在一个 DB 事务中使用 <code>Transaction</code> 方法，GORM 会使用 <code>SavePoint(savedPointName)</code>，<code>RollbackTo(savedPointName)</code> 为你提供嵌套事务支持。 你可以通过 <code>DisableNestedTransaction</code> 选项关闭它，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>
  DisableNestedTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="禁用全局更新" tabindex="-1"><a class="header-anchor" href="#禁用全局更新" aria-hidden="true">#</a> 禁用全局更新</h3><p>GORM 默认不允许进行全局 update/delete，该操作会返回 <code>ErrMissingWhereClause</code> 错误。 您可以通过将一个选项设置为 true 来启用它，例如：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>db.Session(&amp;gorm.Session{
  AllowGlobalUpdate: true,
}).Model(&amp;User{}).Update(&quot;name&quot;, &quot;jinzhu&quot;)
// UPDATE users SET `name` = &quot;jinzhu&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="保存所有关联" tabindex="-1"><a class="header-anchor" href="#保存所有关联" aria-hidden="true">#</a> 保存所有关联</h3><p>在创建、更新记录时，GORM 会通过自动保存关联及其引用记录。 如果您想要更新关联的数据，您应该使用 <code>FullSaveAssociations</code> 模式，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>FullSaveAssociations<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);</span>
<span class="token comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span>
<span class="token comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="context-1" tabindex="-1"><a class="header-anchor" href="#context-1" aria-hidden="true">#</a> Context</h3><p>通过 <code>Context</code> 选项，您可以传入 <code>Context</code> 来追踪 SQL 操作，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>timeoutCtx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Context<span class="token punctuation">:</span> timeoutCtx<span class="token punctuation">}</span><span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// 带有 context timeoutCtx 的查询操作</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 带有 context timeoutCtx 的更新操作</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GORM 也提供了简写形式的方法 <code>WithContext</code>，其实现如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">WithContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Context<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义-logger" tabindex="-1"><a class="header-anchor" href="#自定义-logger" aria-hidden="true">#</a> 自定义 Logger</h3><p>Gorm 允许使用 <code>Logger</code> 选项自定义内建 Logger，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>newLogger <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>
              logger<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
                SlowThreshold<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
                LogLevel<span class="token punctuation">:</span>      logger<span class="token punctuation">.</span>Silent<span class="token punctuation">,</span>
                Colorful<span class="token punctuation">:</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> logger<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Silent<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="nowfunc" tabindex="-1"><a class="header-anchor" href="#nowfunc" aria-hidden="true">#</a> NowFunc</h3><p><code>NowFunc</code> 允许改变 GORM 获取当前时间的实现，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
  NowFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Local</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="调试" tabindex="-1"><a class="header-anchor" href="#调试" aria-hidden="true">#</a> 调试</h3><p><code>Debug</code> 只是将会话的 <code>Logger</code> 修改为调试模式的简写形式，其实现如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
    Logger<span class="token punctuation">:</span>         db<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Info<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询字段" tabindex="-1"><a class="header-anchor" href="#查询字段" aria-hidden="true">#</a> 查询字段</h3><p>声明查询字段</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>QueryFields<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 有该选项</span>
<span class="token comment">// SELECT * FROM `users` // 没有该选项</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="createbatchsize" tabindex="-1"><a class="header-anchor" href="#createbatchsize" aria-hidden="true">#</a> CreateBatchSize</h3><p>默认批量大小</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> Pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Pet<span class="token punctuation">{</span>pet1<span class="token punctuation">,</span> pet2<span class="token punctuation">,</span> pet3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>CreateBatchSize<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO users xxx (需 5 次)</span>
<span class="token comment">// INSERT INTO pets xxx (需 15 次)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="钩子方法-2" tabindex="-1"><a class="header-anchor" href="#钩子方法-2" aria-hidden="true">#</a> 钩子方法</h2><h3 id="生命周期" tabindex="-1"><a class="header-anchor" href="#生命周期" aria-hidden="true">#</a> 生命周期</h3><p>Hook是在创建，查询，更新，删除等操作之前，之后调用的函数。如果已经为模型定义了指定的方法，它会在创建，更新，查询，删除时，自动被调用。如果任何回调返回错误，GORM将会停止后续的操作并回滚事务。</p><h3 id="创建钩子" tabindex="-1"><a class="header-anchor" href="#创建钩子" aria-hidden="true">#</a> 创建钩子</h3><p>创建时可用的 hook</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 开始事务</span>
BeforeSave
BeforeCreate
<span class="token comment">// 关联前的 save</span>
<span class="token comment">// 插入记录至 db</span>
<span class="token comment">// 关联后的 save</span>
AfterCreate
AfterSave
<span class="token comment">// 提交或回滚事务</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  u<span class="token punctuation">.</span>UUID <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t save invalid data&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>ID <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在 GORM 中保存、删除操作会默认运行在事务上， 因此在事务完成之前该事务中所作的更改是不可见的，如果您的钩子返回了任何错误，则修改将被回滚。</p></div><h3 id="更新钩子" tabindex="-1"><a class="header-anchor" href="#更新钩子" aria-hidden="true">#</a> 更新钩子</h3><p>更新时可用的 hook</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 开始事务</span>
BeforeSave
BeforeUpdate
<span class="token comment">// 关联前的 save</span>
<span class="token comment">// 更新 db</span>
<span class="token comment">// 关联后的 save</span>
AfterUpdate
AfterSave
<span class="token comment">// 提交或回滚事务</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span><span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;read only user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在同一个事务中更新数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>Confirmed <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;user_id = ?&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;verfied&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除钩子" tabindex="-1"><a class="header-anchor" href="#删除钩子" aria-hidden="true">#</a> 删除钩子</h3><p>删除时可用的 hook</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 开始事务</span>
BeforeDelete
<span class="token comment">// 删除 db 中的数据</span>
AfterDelete
<span class="token comment">// 提交或回滚事务</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 在同一个事务中更新数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterDelete</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>Confirmed <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;user_id = ?&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;invalid&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询钩子" tabindex="-1"><a class="header-anchor" href="#查询钩子" aria-hidden="true">#</a> 查询钩子</h3><p>查询时可用的 hook</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 从 db 中加载数据</span>
<span class="token comment">// Preloading (eager loading)</span>
AfterFind
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterFind</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>MemberShip <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
    u<span class="token punctuation">.</span>MemberShip <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="索引" tabindex="-1"><a class="header-anchor" href="#索引" aria-hidden="true">#</a> 索引</h2><p>GORM 允许通过 <code>index</code>、<code>uniqueIndex</code> 标签创建索引，这些索引将在使用 GORM 进行<code>AutoMigrate</code> 或 <code>Createtable</code>时创建</p><h3 id="标签" tabindex="-1"><a class="header-anchor" href="#标签" aria-hidden="true">#</a> 标签</h3><p>GORM 可以接受很多索引设置，例如<code>class</code>、<code>type</code>、<code>where</code>、<code>comment</code>、<code>expression</code>、<code>sort</code>、<code>collate</code>、<code>option</code></p><p>下面有一些示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name  <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index&quot;`</span>
    Name2 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_name,unique&quot;`</span>
    Name3 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:,sort:desc,collate:utf8,type:btree,length:10,where:name3 != &#39;jinzhu&#39;&quot;`</span>
    Name4 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;uniqueIndex&quot;`</span>
    Age   <span class="token builtin">int64</span>  <span class="token string">`gorm:&quot;index:,class:FULLTEXT,comment:hello \\, world,where:age &gt; 10&quot;`</span>
    Age2  <span class="token builtin">int64</span>  <span class="token string">`gorm:&quot;index:,expression:ABS(age)&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// MySQL 选项</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:,class:FULLTEXT,option:WITH PARSER ngram INVISIBLE&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// PostgreSQL 选项</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:,option:CONCURRENTLY&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="唯一索引" tabindex="-1"><a class="header-anchor" href="#唯一索引" aria-hidden="true">#</a> 唯一索引</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>uniqueIndex` 标签的作用与 `index` 类似，它等效于 `index:,unique
type User struct {
    Name1 string `gorm:&quot;uniqueIndex&quot;`
    Name2 string `gorm:&quot;uniqueIndex:idx_name,sort:desc&quot;`
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="复合索引" tabindex="-1"><a class="header-anchor" href="#复合索引" aria-hidden="true">#</a> 复合索引</h3><p>两个字段使用同一个索引名将创建复合索引，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// create composite index `idx_member` with columns `name`, `number`</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name   <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member&quot;`</span>
    Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字段优先级" tabindex="-1"><a class="header-anchor" href="#字段优先级" aria-hidden="true">#</a> 字段优先级</h3><p>复合索引列的顺序会影响其性能，因此必须仔细考虑</p><p>您可以使用 <code>priority</code> 指定顺序，默认优先级值是 <code>10</code>，如果优先级值相同，则顺序取决于模型结构体字段的顺序</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name   <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member&quot;`</span>
    Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member&quot;`</span>
<span class="token punctuation">}</span>
<span class="token comment">// column order: name, number</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name   <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member,priority:2&quot;`</span>
    Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member,priority:1&quot;`</span>
<span class="token punctuation">}</span>
<span class="token comment">// column order: number, name</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name   <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member,priority:12&quot;`</span>
    Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_member&quot;`</span>
<span class="token punctuation">}</span>
<span class="token comment">// column order: number, name</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="共享复合索引" tabindex="-1"><a class="header-anchor" href="#共享复合索引" aria-hidden="true">#</a> 共享复合索引</h3><p>如果您正在创建带有嵌入结构的共享复合索引，您不能指定索引名称。 作为嵌入结构不止一次会导致重复的索引名称在 db。</p><p>在这种情况下，您可以使用索引标签 <code>composite</code>, 它意味着复合索引的id。 所有具有相同结构复合id的字段都与原始规则一样，被合并到相同的索引中。 但改进使得最受影响/嵌入结构能够通过命名策略生成索引名称。 例如:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Foo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  IndexA <span class="token builtin">int</span> <span class="token string">`gorm:&quot;index:,unique,composite:myname&quot;`</span>
  IndexB <span class="token builtin">int</span> <span class="token string">`gorm:&quot;index:,unique,composite:myname&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果表Foo被创建，复合索引的名称将是 <code>idx_foo_myname</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Bar0 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Foo
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Bar1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Foo
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>复合索引的名称分别是 <code>idx_bar0_myname</code> 和 <code>idx_bar1_myname</code>。</p><p><code>复合</code> 只能在指定索引名称时使用。</p><h3 id="多索引" tabindex="-1"><a class="header-anchor" href="#多索引" aria-hidden="true">#</a> 多索引</h3><p>一个字段接受多个 <code>index</code>、<code>uniqueIndex</code> 标签，这会在一个字段上创建多个索引</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UserIndex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    OID          <span class="token builtin">int64</span>  <span class="token string">`gorm:&quot;index:idx_id;index:idx_oid,unique&quot;`</span>
    MemberNumber <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:idx_id&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="约束" tabindex="-1"><a class="header-anchor" href="#约束" aria-hidden="true">#</a> 约束</h2><p>GORM 允许通过标签创建数据库约束，约束会在通过 GORM 进行 <code>AutoMigrate</code> 或<code>createTables</code>时被创建。</p><h3 id="检查约束" tabindex="-1"><a class="header-anchor" href="#检查约束" aria-hidden="true">#</a> 检查约束</h3><p>通过 <code>check</code> 标签创建检查约束</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UserIndex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name  <span class="token builtin">string</span> <span class="token string">`gorm:&quot;check:name_checker,name &lt;&gt; &#39;jinzhu&#39;&quot;`</span>
    Name2 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;check:name &lt;&gt; &#39;jinzhu&#39;&quot;`</span>
    Name3 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;check:,name &lt;&gt; &#39;jinzhu&#39;&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="外键约束-4" tabindex="-1"><a class="header-anchor" href="#外键约束-4" aria-hidden="true">#</a> 外键约束</h3><p>GORM 会为关联创建外键约束，您可以在初始化过程中禁用此功能：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DisableForeignKeyConstraintWhenMigrating<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GORM 允许您通过 <code>constraint</code> 标签的 <code>OnDelete</code>、<code>OnUpdate</code> 选项设置外键约束，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CompanyID  <span class="token builtin">int</span>
  Company    Company    <span class="token string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span>
  CreditCard CreditCard <span class="token string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Company <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="事务" tabindex="-1"><a class="header-anchor" href="#事务" aria-hidden="true">#</a> 事务</h2><h3 id="禁用默认事务" tabindex="-1"><a class="header-anchor" href="#禁用默认事务" aria-hidden="true">#</a> 禁用默认事务</h3><p>为了确保数据一致性，GORM 会在事务里执行写入操作（创建、更新、删除）。如果没有这方面的要求，您可以在初始化时禁用它，这将获得大约 30%+ 性能提升。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 全局禁用</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 持续会话模式</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事务使用" tabindex="-1"><a class="header-anchor" href="#事务使用" aria-hidden="true">#</a> 事务使用</h3><p>要在事务中执行一系列操作，一般流程如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 &#39;tx&#39; 而不是 &#39;db&#39;）</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回任何错误都会回滚事务</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回 nil 提交事务</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="嵌套事务" tabindex="-1"><a class="header-anchor" href="#嵌套事务" aria-hidden="true">#</a> 嵌套事务</h3><p>GORM 支持嵌套事务，您可以回滚较大事务内执行的一部分操作，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user1<span class="token punctuation">)</span>

  tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    tx2<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rollback user2&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Rollback user2</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    tx2<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user3<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Commit user1, user3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="手动事务" tabindex="-1"><a class="header-anchor" href="#手动事务" aria-hidden="true">#</a> 手动事务</h3><p>Gorm 支持直接调用事务控制方法（commit、rollback），例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 开始事务</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 &#39;tx&#39; 而不是 &#39;db&#39;）</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>

<span class="token comment">// 遇到错误时回滚事务</span>
tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 否则，提交事务</span>
tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">CreateAnimals</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 再唠叨一下，事务一旦开始，你就应该使用 tx 处理数据</span>
  tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="定点回滚" tabindex="-1"><a class="header-anchor" href="#定点回滚" aria-hidden="true">#</a> 定点回滚</h3><p>GORM 提供了 <code>SavePoint</code>、<code>Rollbackto</code> 方法，来提供保存点以及回滚至保存点功能，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user1<span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">SavePoint</span><span class="token punctuation">(</span><span class="token string">&quot;sp1&quot;</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">RollbackTo</span><span class="token punctuation">(</span><span class="token string">&quot;sp1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Rollback user2</span>

tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Commit user1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="迁移" tabindex="-1"><a class="header-anchor" href="#迁移" aria-hidden="true">#</a> 迁移</h2><h3 id="自动迁移" tabindex="-1"><a class="header-anchor" href="#自动迁移" aria-hidden="true">#</a> 自动迁移</h3><p>AutoMigrate 用于自动迁移您的 schema，保持您的 schema 是最新的。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p><strong>注意：</strong> AutoMigrate 会创建表、缺失的外键、约束、列和索引。 如果大小、精度、是否为空可以更改，则 AutoMigrate 会改变列的类型。 出于保护您数据的目的，它 <strong>不会</strong> 删除未使用的列</p></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 创建表时添加后缀</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>禁用自动创建外键约束</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  DisableForeignKeyConstraintWhenMigrating<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="migrator-接口" tabindex="-1"><a class="header-anchor" href="#migrator-接口" aria-hidden="true">#</a> Migrator 接口</h3><p>GORM 提供了 Migrator 接口，该接口为每个数据库提供了统一的 API 接口，可用来为您的数据库构建独立迁移，例如：</p><p>SQLite 不支持 <code>ALTER COLUMN</code>、<code>DROP COLUMN</code>，当你试图修改表结构，GORM 将创建一个新表、复制所有数据、删除旧表、重命名新表。</p><p>一些版本的 MySQL 不支持 rename 列，索引。GORM 将基于您使用 MySQL 的版本执行不同 SQL</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Migrator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token comment">// AutoMigrate</span>
  <span class="token function">AutoMigrate</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

  <span class="token comment">// Database</span>
  <span class="token function">CurrentDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
  <span class="token function">FullDataTypeOf</span><span class="token punctuation">(</span><span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">)</span> clause<span class="token punctuation">.</span>Expr

  <span class="token comment">// Tables</span>
  <span class="token function">CreateTable</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropTable</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasTable</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameTable</span><span class="token punctuation">(</span>oldName<span class="token punctuation">,</span> newName <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">GetTables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tableList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

  <span class="token comment">// Columns</span>
  <span class="token function">AddColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">AlterColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">MigrateColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">,</span> columnType ColumnType<span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldName<span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">ColumnTypes</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ColumnType<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

  <span class="token comment">// Constraints</span>
  <span class="token function">CreateConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>

  <span class="token comment">// Indexes</span>
  <span class="token function">CreateIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldName<span class="token punctuation">,</span> newName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="当前数据库" tabindex="-1"><a class="header-anchor" href="#当前数据库" aria-hidden="true">#</a> 当前数据库</h3><p>返回当前使用的数据库名</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CurrentDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="表" tabindex="-1"><a class="header-anchor" href="#表" aria-hidden="true">#</a> 表</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 为 `User` 创建表</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 将 &quot;ENGINE=InnoDB&quot; 添加到创建 `User` 的 SQL 里去</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 检查 `User` 对应的表是否存在</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 如果存在表则删除（删除时会忽略、删除外键约束)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 重命名表</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>UserInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user_infos&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="列" tabindex="-1"><a class="header-anchor" href="#列" aria-hidden="true">#</a> 列</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 添加 name 字段</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 删除 name 字段</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 修改 name 字段</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AlterColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 检查 name 字段是否存在</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name    <span class="token builtin">string</span>
  NewName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 字段重命名</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NewName&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;new_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 字段类型</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ColumnTypes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>ColumnType<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> ColumnType <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token function">DatabaseTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>                 <span class="token comment">// varchar</span>
    <span class="token function">ColumnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>columnType <span class="token builtin">string</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// varchar(64)</span>
    <span class="token function">PrimaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>isPrimaryKey <span class="token builtin">bool</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">AutoIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>isAutoIncrement <span class="token builtin">bool</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>length <span class="token builtin">int64</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">DecimalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>precision <span class="token builtin">int64</span><span class="token punctuation">,</span> scale <span class="token builtin">int64</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nullable <span class="token builtin">bool</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>unique <span class="token builtin">bool</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">ScanType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>Type
    <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">DefaultValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="约束-1" tabindex="-1"><a class="header-anchor" href="#约束-1" aria-hidden="true">#</a> 约束</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UserIndex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name  <span class="token builtin">string</span> <span class="token string">`gorm:&quot;check:name_checker,name &lt;&gt; &#39;jinzhu&#39;&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建约束</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 删除约束</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 检查约束是否存在</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为 relation 创建外键</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCards <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>

<span class="token comment">// 为 user &amp; credit_cards 创建 db 外键</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// ALTER TABLE `credit_cards` ADD CONSTRAINT `fk_users_credit_cards` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)</span>

<span class="token comment">// 检查 user &amp; credit_cards 的外键是否存在</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 删除 user &amp; credit_cards 的 db 外键</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="索引-1" tabindex="-1"><a class="header-anchor" href="#索引-1" aria-hidden="true">#</a> 索引</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;size:255;index:idx_name,unique&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// 为 Name 字段创建索引</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 为 Name 字段删除索引</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 检查索引是否存在</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name  <span class="token builtin">string</span> <span class="token string">`gorm:&quot;size:255;index:idx_name,unique&quot;`</span>
  Name2 <span class="token builtin">string</span> <span class="token string">`gorm:&quot;size:255;index:idx_name_2,unique&quot;`</span>
<span class="token punctuation">}</span>
<span class="token comment">// 修改索引名</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Name2&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name_2&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="日志" tabindex="-1"><a class="header-anchor" href="#日志" aria-hidden="true">#</a> 日志</h2><p>GORM有一个自己默认的Logger实现，通常情况下，它会打印慢SQL和错误。在项目中通常会使用第三方日志组件，这里仅作了解。</p><p>Logger 接受的选项不多，您可以在初始化时自定义它，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>newLogger <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
  log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// io writer（日志输出的目标，前缀和日志包含的内容——译者注）</span>
  logger<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
    SlowThreshold<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>   <span class="token comment">// 慢 SQL 阈值</span>
    LogLevel<span class="token punctuation">:</span>      logger<span class="token punctuation">.</span>Silent<span class="token punctuation">,</span> <span class="token comment">// 日志级别</span>
    IgnoreRecordNotFoundError<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 忽略ErrRecordNotFound（记录未找到）错误</span>
    Colorful<span class="token punctuation">:</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment">// 禁用彩色打印</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment">// 全局模式</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 新建会话模式</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="日志级别" tabindex="-1"><a class="header-anchor" href="#日志级别" aria-hidden="true">#</a> 日志级别</h3><p>GORM 定义了这些日志级别：<code>Silent</code>、<code>Error</code>、<code>Warn</code>、<code>Info</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  Logger<span class="token punctuation">:</span> logger<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Silent<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="debug" tabindex="-1"><a class="header-anchor" href="#debug" aria-hidden="true">#</a> Debug</h3><p>Debug 单个操作，将当前操作的 log 级别调整为 <a href="http://logger.Info" target="_blank" rel="noopener noreferrer">logger.Info<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="自定义-logger-1" tabindex="-1"><a class="header-anchor" href="#自定义-logger-1" aria-hidden="true">#</a> 自定义 Logger</h3><p>参考 GORM 的 <a href="https://github.com/go-gorm/gorm/blob/master/logger/logger.go" target="_blank" rel="noopener noreferrer">默认 logger<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来定义您自己的 logger</p><p>Logger 需要实现以下接口，它接受 <code>context</code>，所以你可以用它来追踪日志</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">LogMode</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">)</span> Interface
    <span class="token function">Info</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">Warn</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">Error</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">Trace</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> begin time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> fc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sql <span class="token builtin">string</span><span class="token punctuation">,</span> rowsAffected <span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安全" tabindex="-1"><a class="header-anchor" href="#安全" aria-hidden="true">#</a> 安全</h2><p>GORM 使用 <code>database/sql</code> 的参数占位符来构造 SQL 语句，这可以自动转义参数，避免 SQL 注入数据</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意</strong> Logger 打印的 SQL 并不像最终执行的 SQL 那样已经转义，复制和运行这些 SQL 时应当注意。</p></div><h3 id="查询条件" tabindex="-1"><a class="header-anchor" href="#查询条件" aria-hidden="true">#</a> 查询条件</h3><p>用户的输入只能作为参数，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>userInput <span class="token operator">:=</span> <span class="token string">&quot;jinzhu;drop table users;&quot;</span>

<span class="token comment">// 安全的，会被转义</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// SQL 注入</span>
db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name = %v&quot;</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内联条件-1" tabindex="-1"><a class="header-anchor" href="#内联条件-1" aria-hidden="true">#</a> 内联条件</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 会被转义</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span>

<span class="token comment">// SQL 注入</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;name = %v&quot;</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当通过用户输入的整形主键检索记录时，你应该对变量进行类型检查。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>userInputID <span class="token operator">:=</span> <span class="token string">&quot;1=1;drop table users;&quot;</span>
<span class="token comment">// 安全的，返回 err</span>
id<span class="token punctuation">,</span>err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>userInputID<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

<span class="token comment">// SQL 注入</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> userInputID<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE 1=1;drop table users;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sql-注入方法" tabindex="-1"><a class="header-anchor" href="#sql-注入方法" aria-hidden="true">#</a> SQL 注入方法</h3><p>为了支持某些功能，一些输入不会被转义，调用方法时要小心用户输入的参数。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;name; drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token string">&quot;name; drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pluck</span><span class="token punctuation">(</span><span class="token string">&quot;name; drop table users;&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>names<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name; drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Having</span><span class="token punctuation">(</span><span class="token string">&quot;1 = 1;drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select name from users; drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;select name from users; drop table users;&quot;</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Order</span><span class="token punctuation">(</span><span class="token string">&quot;name; drop table users;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>避免 SQL 注入的一般原则是，不信任用户提交的数据。您可以进行白名单验证来测试用户的输入是否为已知安全的、已批准、已定义的输入，并且在使用用户的输入时，仅将它们作为参数。</p><h2 id="通用数据库接口" tabindex="-1"><a class="header-anchor" href="#通用数据库接口" aria-hidden="true">#</a> 通用数据库接口</h2><p>ORM 提供了 <code>DB</code> 方法，可用于从当前 <code>*gorm.DB</code> 返回一个通用的数据库接口 <a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener noreferrer">*sql.DB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 获取通用数据库对象 sql.DB，然后使用其提供的功能</span>
sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Ping</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Close</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 返回数据库统计信息</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p><strong>注意</strong> 如果底层连接的数据库不是 <code>*sql.DB</code>，它会返回错误</p></div><h3 id="连接池-1" tabindex="-1"><a class="header-anchor" href="#连接池-1" aria-hidden="true">#</a> 连接池</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 获取通用数据库对象 sql.DB ，然后使用其提供的功能</span>
sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxIdleConns 用于设置连接池中空闲连接的最大数量。</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxOpenConns 设置打开数据库连接的最大数量。</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// SetConnMaxLifetime 设置了连接可复用的最大时间。</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="性能" tabindex="-1"><a class="header-anchor" href="#性能" aria-hidden="true">#</a> 性能</h2><p>GORM 已经优化了许多东西来提高性能，其默认性能对大多数应用来说都够用了。但这里还是有一些关于如何为您的应用改进性能的方法。</p><h3 id="禁用默认事务-1" tabindex="-1"><a class="header-anchor" href="#禁用默认事务-1" aria-hidden="true">#</a> 禁用默认事务</h3><p>对于写操作（创建、更新、删除），为了确保数据的完整性，GORM 会将它们封装在一个事务里。但这会降低性能，你可以在初始化时禁用这种方式</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="缓存预编译语句" tabindex="-1"><a class="header-anchor" href="#缓存预编译语句" aria-hidden="true">#</a> 缓存预编译语句</h3><p>执行任何 SQL 时都创建并缓存预编译语句，可以提高后续的调用速度</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 全局模式</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 会话模式</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="带预编译的sql生成器" tabindex="-1"><a class="header-anchor" href="#带预编译的sql生成器" aria-hidden="true">#</a> 带预编译的SQL生成器</h3><p>Prepared Statement 也可以和原生 SQL 一起使用，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select sum(age) from users where role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>age<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="缩小字段选择范围" tabindex="-1"><a class="header-anchor" href="#缩小字段选择范围" aria-hidden="true">#</a> 缩小字段选择范围</h3><p>默认情况下，GORM 在查询时会选择所有的字段，您可以使用 <code>Select</code> 来指定您想要的字段</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或者定义一个较小的 API 结构体，使用智能选择字段功能</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     <span class="token builtin">uint</span>
  Name   <span class="token builtin">string</span>
  Age    <span class="token builtin">int</span>
  Gender <span class="token builtin">string</span>
  <span class="token comment">// 假设后面还有几百个字段...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> APIUser <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">uint</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询时会自动选择 `id`、`name` 字段</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>APIUser<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT `id`, `name` FROM `users` LIMIT 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="findinbatches-1" tabindex="-1"><a class="header-anchor" href="#findinbatches-1" aria-hidden="true">#</a> FindInBatches</h3><h3 id="索引提示" tabindex="-1"><a class="header-anchor" href="#索引提示" aria-hidden="true">#</a> 索引提示</h3><p>索引用于提高数据检索和 SQL 查询性能。 <code>Index Hints</code> 向优化器提供了在查询处理过程中如何选择索引的信息。与 optimizer 相比，它可以更灵活地选择更有效的执行计划</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/hints&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">UseIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">ForceIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&quot;</span>

db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>
    hints<span class="token punctuation">.</span><span class="token function">ForceIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForOrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    hints<span class="token punctuation">.</span><span class="token function">IgnoreIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForGroupBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM `users` FORCE INDEX FOR ORDER BY (`idx_user_name`,`idx_user_id`) IGNORE INDEX FOR GROUP BY (`idx_user_name`)&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><strong>注意</strong> 也可以参考如何为 MySQL 开启 interpolateparams 以减少 roundtrip <a href="https://github.com/go-sql-driver/mysql#interpolateparams" target="_blank" rel="noopener noreferrer">https://github.com/go-sql-driver/mysql#interpolateparams<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="读写分离" tabindex="-1"><a class="header-anchor" href="#读写分离" aria-hidden="true">#</a> 读写分离</h3><p>通过读写分离提高数据吞吐量</p><h2 id="自定义数据类型" tabindex="-1"><a class="header-anchor" href="#自定义数据类型" aria-hidden="true">#</a> 自定义数据类型</h2><p>GORM提供了少量接口，使用户能够为GORM定义支持的数据类型，这里以<code>JSON</code>为例子。</p><p>官方的自定义数据类型仓库：<a href="https://github.com/go-gorm/datatypes" target="_blank" rel="noopener noreferrer">go-gorm/datatypes: GORM Customized Data Types Collection (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="scanner-valuer" tabindex="-1"><a class="header-anchor" href="#scanner-valuer" aria-hidden="true">#</a> Scanner/valuer</h3><p>自定义数据类型必须实现<code>Scanner/Valuer</code>接口，以便让GORM知道如何将该类型接受，保存到数据库。</p><p>例如:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> JSON json<span class="token punctuation">.</span>RawMessage

<span class="token comment">// 实现 sql.Scanner 接口，Scan 将 value 扫描至 Jsonb</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JSON<span class="token punctuation">)</span> <span class="token function">Scan</span><span class="token punctuation">(</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  bytes<span class="token punctuation">,</span> ok <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to unmarshal JSONB value:&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  result <span class="token operator">:=</span> json<span class="token punctuation">.</span>RawMessage<span class="token punctuation">{</span><span class="token punctuation">}</span>
  err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
  <span class="token operator">*</span>j <span class="token operator">=</span> <span class="token function">JSON</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment">// 实现 driver.Valuer 接口，Value 返回 json value</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>j JSON<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>driver<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">RawMessage</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MarshalJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有许多第三方包实现了 <code>Scanner</code>/<code>Valuer</code> 接口，可与 GORM 一起使用，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;github.com/google/uuid&quot;</span>
  <span class="token string">&quot;github.com/lib/pq&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Post <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     uuid<span class="token punctuation">.</span>UUID <span class="token string">`gorm:&quot;type:uuid;default:uuid_generate_v4()&quot;`</span>
  Title  <span class="token builtin">string</span>
  Tags   pq<span class="token punctuation">.</span>StringArray <span class="token string">`gorm:&quot;type:text[]&quot;`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据类型接口" tabindex="-1"><a class="header-anchor" href="#数据类型接口" aria-hidden="true">#</a> 数据类型接口</h3><p>GORM 会从 <code>type</code> 标签中读取字段的数据库类型，如果找不到，则会检查该结构体是否实现了 <code>GormDBDataTypeInterface</code> 或 <code>GormDataTypeInterface</code> 接口，然后使用接口返回值作为数据类型</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> GormDataTypeInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">GormDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> GormDBDataTypeInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">GormDBDataType</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> <span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>GormDataType</code> 的结果用于生成通用数据类型，也可以通过 <code>schema.Field</code> 的 <code>DataType</code> 字段得到。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>JSON<span class="token punctuation">)</span> <span class="token function">GormDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;json&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Attrs JSON
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>user User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  field <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">LookUpField</span><span class="token punctuation">(</span><span class="token string">&quot;Attrs&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> field<span class="token punctuation">.</span>DataType <span class="token operator">==</span> <span class="token string">&quot;json&quot;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 做点什么...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在迁移时，<code>GormDBDataType</code> 通常会为当前驱动返回恰当的数据类型，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>JSON<span class="token punctuation">)</span> <span class="token function">GormDBDataType</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> field <span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用 field.Tag、field.TagSettings 获取字段的 tag</span>
  <span class="token comment">// 查看 https://github.com/go-gorm/gorm/blob/master/schema/field.go 获取全部的选项</span>

  <span class="token comment">// 根据不同的数据库驱动返回不同的数据类型</span>
  <span class="token keyword">switch</span> db<span class="token punctuation">.</span>Dialector<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sqlite&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;JSON&quot;</span>
  <span class="token keyword">case</span> <span class="token string">&quot;postgres&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;JSONB&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 struct 没有实现 <code>GormDBDataTypeInterface</code> 或 <code>GormDataTypeInterface</code> 接口，GORM 会根据 struct 第一个字段推测其数据类型，例如：会为 <code>NullString</code> 使用 <code>string</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> NullString <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  String <span class="token builtin">string</span> <span class="token comment">// 使用第一个字段的数据类型</span>
  Valid  <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name NullString <span class="token comment">// 数据类型会是 string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gormvaluerinterface" tabindex="-1"><a class="header-anchor" href="#gormvaluerinterface" aria-hidden="true">#</a> GormValuerInterface</h3><p>GORM 提供了 <code>GormValuerInterface</code> 接口，支持使用 SQL 表达式或基于 context 的值进行 create/update。基于此接口，可以实现自定义数据类型在生成SQL时自定义SQL表达式，提供更加灵活的处理方式。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> GormValuerInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">GormValue</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> clause<span class="token punctuation">.</span>Expr
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Location <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    X<span class="token punctuation">,</span> Y <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>loc Location<span class="token punctuation">)</span> <span class="token function">GormDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;geometry&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>loc Location<span class="token punctuation">)</span> <span class="token function">GormValue</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> clause<span class="token punctuation">.</span>Expr <span class="token punctuation">{</span>
  <span class="token keyword">return</span> clause<span class="token punctuation">.</span>Expr<span class="token punctuation">{</span>
    SQL<span class="token punctuation">:</span>  <span class="token string">&quot;ST_PointFromText(?)&quot;</span><span class="token punctuation">,</span><span class="token comment">//表达式</span>
    Vars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;POINT(%d %d)&quot;</span><span class="token punctuation">,</span> loc<span class="token punctuation">.</span>X<span class="token punctuation">,</span> loc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//参数</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Scan 方法实现了 sql.Scanner 接口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>loc <span class="token operator">*</span>Location<span class="token punctuation">)</span> <span class="token function">Scan</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// Scan a value into struct from database driver</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID       <span class="token builtin">int</span>
  Name     <span class="token builtin">string</span>
  Location Location
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>     <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  Location<span class="token punctuation">:</span> Location<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO `users` (`name`,`point`) VALUES (&quot;jinzhu&quot;,ST_PointFromText(&quot;POINT(100 100)&quot;))</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>  <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  Location<span class="token punctuation">:</span> Location<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE `user_with_points` SET `name`=&quot;jinzhu&quot;,`location`=ST_PointFromText(&quot;POINT(100 100)&quot;) WHERE `id` = 1</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基于Context的值</p><p>如果你想创建或更新一个依赖于当前 context 的值，你也可以实现 <code>GormValuerInterface</code> 接口，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> EncryptedString <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>es EncryptedString<span class="token punctuation">)</span> <span class="token function">GormValue</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>expr clause<span class="token punctuation">.</span>Expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> encryptionKey<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;TenantEncryptionKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
    <span class="token keyword">return</span> clause<span class="token punctuation">.</span>Expr<span class="token punctuation">{</span>SQL<span class="token punctuation">:</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> Vars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token function">Encrypt</span><span class="token punctuation">(</span>es<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> encryptionKey<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid encryption key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="子句表达式" tabindex="-1"><a class="header-anchor" href="#子句表达式" aria-hidden="true">#</a> 子句表达式</h3><p>如果你想构建一些查询 helper，你可以让 struct 实现 <code>clause.Expression</code> 接口：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Expression <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Build</span><span class="token punctuation">(</span>builder Builder<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下为<a href="https://github.com/go-gorm/datatypes/blob/master/json.go" target="_blank" rel="noopener noreferrer">datatypes/json.go at master · go-gorm/datatypes (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中的一个<code>JSONQueryExpression</code>实现。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// JSONQueryExpression json query expression, implements clause.Expression interface to use as querier</span>
<span class="token keyword">type</span> JSONQueryExpression <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	column      <span class="token builtin">string</span>
	keys        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	hasKeys     <span class="token builtin">bool</span>
	equals      <span class="token builtin">bool</span>
	equalsValue <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	extract     <span class="token builtin">bool</span>
	path        <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// JSONQuery query column as json</span>
<span class="token keyword">func</span> <span class="token function">JSONQuery</span><span class="token punctuation">(</span>column <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>JSONQueryExpression <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>JSONQueryExpression<span class="token punctuation">{</span>column<span class="token punctuation">:</span> column<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Extract extract json with path</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsonQuery <span class="token operator">*</span>JSONQueryExpression<span class="token punctuation">)</span> <span class="token function">Extract</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>JSONQueryExpression <span class="token punctuation">{</span>
	jsonQuery<span class="token punctuation">.</span>extract <span class="token operator">=</span> <span class="token boolean">true</span>
	jsonQuery<span class="token punctuation">.</span>path <span class="token operator">=</span> path
	<span class="token keyword">return</span> jsonQuery
<span class="token punctuation">}</span>

<span class="token comment">// HasKey returns clause.Expression</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsonQuery <span class="token operator">*</span>JSONQueryExpression<span class="token punctuation">)</span> <span class="token function">HasKey</span><span class="token punctuation">(</span>keys <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>JSONQueryExpression <span class="token punctuation">{</span>
	jsonQuery<span class="token punctuation">.</span>keys <span class="token operator">=</span> keys
	jsonQuery<span class="token punctuation">.</span>hasKeys <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">return</span> jsonQuery
<span class="token punctuation">}</span>

<span class="token comment">// Keys returns clause.Expression</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsonQuery <span class="token operator">*</span>JSONQueryExpression<span class="token punctuation">)</span> <span class="token function">Equals</span><span class="token punctuation">(</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> keys <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>JSONQueryExpression <span class="token punctuation">{</span>
	jsonQuery<span class="token punctuation">.</span>keys <span class="token operator">=</span> keys
	jsonQuery<span class="token punctuation">.</span>equals <span class="token operator">=</span> <span class="token boolean">true</span>
	jsonQuery<span class="token punctuation">.</span>equalsValue <span class="token operator">=</span> value
	<span class="token keyword">return</span> jsonQuery
<span class="token punctuation">}</span>

<span class="token comment">// Build implements clause.Expression</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsonQuery <span class="token operator">*</span>JSONQueryExpression<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span>builder clause<span class="token punctuation">.</span>Builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> stmt<span class="token punctuation">,</span> ok <span class="token operator">:=</span> builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>Statement<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> stmt<span class="token punctuation">.</span>Dialector<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sqlite&quot;</span><span class="token punctuation">:</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> jsonQuery<span class="token punctuation">.</span>extract<span class="token punctuation">:</span>
				builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;JSON_EXTRACT(&quot;</span><span class="token punctuation">)</span>
				builder<span class="token punctuation">.</span><span class="token function">WriteQuoted</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>column<span class="token punctuation">)</span>
				builder<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span>
				builder<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> jsonQuery<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
				builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> jsonQuery<span class="token punctuation">.</span>hasKeys<span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;JSON_EXTRACT(&quot;</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteQuoted</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>column<span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token function">jsonQueryJoin</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;) IS NOT NULL&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> jsonQuery<span class="token punctuation">.</span>equals<span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;JSON_EXTRACT(&quot;</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteQuoted</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>column<span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token function">jsonQueryJoin</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;) = &quot;</span><span class="token punctuation">)</span>
					<span class="token keyword">if</span> value<span class="token punctuation">,</span> ok <span class="token operator">:=</span> jsonQuery<span class="token punctuation">.</span>equalsValue<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
						builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">FormatBool</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> jsonQuery<span class="token punctuation">.</span>equalsValue<span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token string">&quot;postgres&quot;</span><span class="token punctuation">:</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> jsonQuery<span class="token punctuation">.</span>hasKeys<span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					stmt<span class="token punctuation">.</span><span class="token function">WriteQuoted</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>column<span class="token punctuation">)</span>
					stmt<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;::jsonb&quot;</span><span class="token punctuation">)</span>
					<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
						stmt<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot; -&gt; &quot;</span><span class="token punctuation">)</span>
						stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
					<span class="token punctuation">}</span>

					stmt<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot; ? &quot;</span><span class="token punctuation">)</span>
					stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> jsonQuery<span class="token punctuation">.</span>equals<span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;json_extract_path_text(%v::json,&quot;</span><span class="token punctuation">,</span> stmt<span class="token punctuation">.</span><span class="token function">Quote</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

					<span class="token keyword">for</span> idx<span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> jsonQuery<span class="token punctuation">.</span>keys <span class="token punctuation">{</span>
						<span class="token keyword">if</span> idx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
							builder<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span>
						<span class="token punctuation">}</span>
						stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;) = &quot;</span><span class="token punctuation">)</span>

					<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> jsonQuery<span class="token punctuation">.</span>equalsValue<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
						stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> jsonQuery<span class="token punctuation">.</span>equalsValue<span class="token punctuation">)</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						stmt<span class="token punctuation">.</span><span class="token function">AddVar</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>jsonQuery<span class="token punctuation">.</span>equalsValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="scope-1" tabindex="-1"><a class="header-anchor" href="#scope-1" aria-hidden="true">#</a> Scope</h2><p><code>Scope</code>允许复用通用的逻辑，这种共享逻辑需要定义为类型<code>func(*gorm.DB) *gorm.DB</code>。</p><h3 id="查询-1" tabindex="-1"><a class="header-anchor" href="#查询-1" aria-hidden="true">#</a> 查询</h3><p>Scope 查询示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AmountGreaterThan1000</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;amount &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCreditCard</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode_sign = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCod</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode_sign = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span>status <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;status IN (?)&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCreditCard<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于 1000 的信用卡订单</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于 1000 的 COD 订单</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;paid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shipped&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// 查找所有金额大于1000 的已付款或已发货订单</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分页" tabindex="-1"><a class="header-anchor" href="#分页" aria-hidden="true">#</a> 分页</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Paginate</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    q <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    page<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> page <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      page <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    pageSize<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;page_size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> pageSize <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
      pageSize <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">case</span> pageSize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
      pageSize <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>

    offset <span class="token operator">:=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">Paginate</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">Paginate</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>articles<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="动态表" tabindex="-1"><a class="header-anchor" href="#动态表" aria-hidden="true">#</a> 动态表</h3><p>使用 <code>Scopes</code> 来动态指定查询的表</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TableOfYear</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">,</span> year <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
        tableName <span class="token operator">:=</span> user<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfYear</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">2019</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users_2019;</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfYear</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users_2020;</span>

<span class="token comment">// Table form different database</span>
<span class="token keyword">func</span> <span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">,</span> dbName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
        tableName <span class="token operator">:=</span> dbName <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;org1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM org1.users;</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;org2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM org2.users;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新-1" tabindex="-1"><a class="header-anchor" href="#更新-1" aria-hidden="true">#</a> 更新</h3><p>Scope 更新、删除示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">CurOrganization</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    org <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">&quot;org&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> org <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> organization Organization
      <span class="token keyword">if</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>organization<span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> org<span class="token punctuation">)</span><span class="token punctuation">.</span>Error <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;org_id = ?&quot;</span><span class="token punctuation">,</span> organization<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    db<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span><span class="token string">&quot;invalid organization&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>article<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">CurOrganization</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name 1&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE articles SET name = &quot;name 1&quot; WHERE org_id = 111</span>
db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">CurOrganization</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Article<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM articles WHERE org_id = 111</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="数据库实例的上下文值传递" tabindex="-1"><a class="header-anchor" href="#数据库实例的上下文值传递" aria-hidden="true">#</a> 数据库实例的上下文值传递</h2><p>GORM 提供了 <code>Set</code>, <code>Get</code>, <code>InstanceSet</code>, <code>InstanceGet</code> 方法来允许用户传值给勾子或其他方法</p><p>Gorm 中有一些特性用到了这种机制，如迁移表格时传递表格选项。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 创建表时添加表后缀</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="set-get" tabindex="-1"><a class="header-anchor" href="#set-get" aria-hidden="true">#</a> Set / Get</h3><p>使用 <code>Set</code> / <code>Get</code> 传递设置到钩子方法，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>card <span class="token operator">*</span>CreditCard<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

myValue <span class="token operator">:=</span> <span class="token number">123</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">,</span> myValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="instanceset-instanceget" tabindex="-1"><a class="header-anchor" href="#instanceset-instanceget" aria-hidden="true">#</a> InstanceSet / InstanceGet</h3><p>使用 <code>InstanceSet</code> / <code>InstanceGet</code> 传递设置到 <code>*Statement</code> 的钩子方法，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">InstanceGet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在创建关联时，GORM 创建了一个新 `*Statement`，所以它不能读取到其它实例的设置</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>card <span class="token operator">*</span>CreditCard<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">InstanceGet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; false</span>
  <span class="token comment">// myValue =&gt; nil</span>
<span class="token punctuation">}</span>

myValue <span class="token operator">:=</span> <span class="token number">123</span>
db<span class="token punctuation">.</span><span class="token function">InstanceSet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">,</span> myValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="数据库解析器" tabindex="-1"><a class="header-anchor" href="#数据库解析器" aria-hidden="true">#</a> 数据库解析器</h2><p><code>DBResolver</code>为GORM提供了多个数据库支持，支持以下功能。</p><ul><li>支持多个<code>sources</code>,<code>replicas</code></li><li>读写分离</li><li>根据工作表，结构体自动切换连接</li><li>手动切换连接</li><li>负载均衡</li><li>适用于原生SQL</li><li>事务支持</li></ul><h3 id="用法" tabindex="-1"><a class="header-anchor" href="#用法" aria-hidden="true">#</a> 用法</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;gorm.io/gorm&quot;</span>
  <span class="token string">&quot;gorm.io/plugin/dbresolver&quot;</span>
  <span class="token string">&quot;gorm.io/driver/mysql&quot;</span>
<span class="token punctuation">)</span>

db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db1_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  <span class="token comment">// `db2` 作为 sources，`db3`、`db4` 作为 replicas</span>
  Sources<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>Dialector<span class="token punctuation">{</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db2_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  Replicas<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>Dialector<span class="token punctuation">{</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db3_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db4_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// sources/replicas 负载均衡策略</span>
  Policy<span class="token punctuation">:</span> dbresolver<span class="token punctuation">.</span>RandomPolicy<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  <span class="token comment">// `db1` 作为 sources（DB 的默认连接），对于 `User`、`Address` 使用 `db5` 作为 replicas</span>
  Replicas<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>Dialector<span class="token punctuation">{</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db5_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  <span class="token comment">// `db6`、`db7` 作为 sources，对于 `orders`、`Product` 使用 `db8` 作为 replicas</span>
  Sources<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>Dialector<span class="token punctuation">{</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db6_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db7_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  Replicas<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>Dialector<span class="token punctuation">{</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;db8_dsn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;orders&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;secondary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自动切换连接" tabindex="-1"><a class="header-anchor" href="#自动切换连接" aria-hidden="true">#</a> 自动切换连接</h3><p>DBResolver 会根据工作表、struct 自动切换连接</p><p>对于原生 SQL，DBResolver 会从 SQL 中提取表名以匹配 Resolver，除非 SQL 开头为 <code>SELECT</code>（select for update 除外），否则 DBResolver 总是会使用 <code>sources</code> ，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// `User` Resolver 示例</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// replicas `db5`</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AdvancedUser<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// replicas `db5`</span>
db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;update users set name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span> <span class="token comment">// sources `db1`</span>
db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select name from users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">)</span> <span class="token comment">// replicas `db5`</span>
db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// sources `db1`</span>
db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span> <span class="token comment">// sources `db1`</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span> <span class="token comment">// sources `db1`</span>

<span class="token comment">// Global Resolver 示例</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Pet<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// replicas `db3`/`db4`</span>
db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Pet<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// sources `db2`</span>

<span class="token comment">// Orders Resolver 示例</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// replicas `db8`</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;orders&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Report<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// replicas `db8`</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="读写分离-1" tabindex="-1"><a class="header-anchor" href="#读写分离-1" aria-hidden="true">#</a> 读写分离</h3><p>DBResolver 的读写分离目前是基于 <code>GORM callback</code> 实现的。</p><p>对于 <code>Query</code>、<code>Row</code> callback，如果手动指定为 <code>Write</code> 模式，此时会使用 <code>sources</code>，否则使用 <code>replicas</code>。 对于 <code>Raw</code> callback，如果 SQL 是以 <code>SELECT</code> 开头，语句会被认为是只读的，会使用 <code>replicas</code>，否则会使用 <code>sources</code>。</p><h3 id="手动切换连接" tabindex="-1"><a class="header-anchor" href="#手动切换连接" aria-hidden="true">#</a> 手动切换连接</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 使用 Write 模式：从 sources db `db1` 读取 user</span>
db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 指定 Resolver：从 `secondary` 的 replicas db `db8` 读取 user</span>
db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token string">&quot;secondary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

<span class="token comment">// 指定 Resolver 和 Write 模式：从 `secondary` 的 sources db `db6` 或 `db7` 读取 user</span>
db<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token string">&quot;secondary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dbresolver<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事务-1" tabindex="-1"><a class="header-anchor" href="#事务-1" aria-hidden="true">#</a> 事务</h3><p>使用事务时，DBResolver 也会保持使用一个事务，且不会根据配置切换 sources/replicas 连接</p><p>但您可以在事务开始之前指定使用哪个数据库，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 通过默认 replicas db 开始事务</span>
tx <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Read<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 通过默认 sources db 开始事务</span>
tx <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 通过 `secondary` 的 sources db 开始事务</span>
tx <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token string">&quot;secondary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dbresolver<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="负载均衡" tabindex="-1"><a class="header-anchor" href="#负载均衡" aria-hidden="true">#</a> 负载均衡</h3><p>GORM 支持基于策略的 sources/replicas 负载均衡，自定义策略应该是一个实现了以下接口的 struct：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Policy <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>gorm<span class="token punctuation">.</span>ConnPool<span class="token punctuation">)</span> gorm<span class="token punctuation">.</span>ConnPool
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当前只实现了一个 <code>RandomPolicy</code> 策略，如果没有指定其它策略，它就是默认策略。</p><h3 id="连接池-2" tabindex="-1"><a class="header-anchor" href="#连接池-2" aria-hidden="true">#</a> 连接池</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>
  dbresolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>dbresolver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span> <span class="token comment">/* xxx */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
  <span class="token function">SetConnMaxIdleTime</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">.</span>
  <span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">.</span>
  <span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
  <span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/CQUT-Programmer/Golang-Doc/edit/main/src/语言进阶/实用框架/gorm.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2633565580@qq.com">246859</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/gin.html" class="nav-link prev" aria-label="Gin"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->Gin</div></a><a href="/%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/%E5%AE%9E%E7%94%A8%E6%A1%86%E6%9E%B6/xorm.html" class="nav-link next" aria-label="Xorm"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">Xorm<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-6834afb2.js" defer></script>
  </body>
</html>
